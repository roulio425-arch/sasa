<!doctype html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <title>ZG MUSIC Dashboard</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
            rel="stylesheet"
        />
        <style>
            @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

            * {
                font-family: "Inter", sans-serif;
            }

            body {
                margin: 0;
                padding: 0;
                overflow-x: hidden;
                position: relative;
            }

            /* Fond d'écran animé rouge magnifique */
            .animated-background {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: -1000;
                background: linear-gradient(
                    45deg,
                    #7f1d1d,
                    #991b1b,
                    #dc2626,
                    #ef4444,
                    #dc2626,
                    #991b1b,
                    #7f1d1d
                );
                background-size: 400% 400%;
                animation: gradientShift 8s ease-in-out infinite;
            }

            @keyframes gradientShift {
                0%,
                100% {
                    background-position: 0% 50%;
                }
                25% {
                    background-position: 100% 50%;
                }
                50% {
                    background-position: 100% 100%;
                }
                75% {
                    background-position: 0% 100%;
                }
            }

            .background-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                z-index: -999;
                backdrop-filter: blur(1px);
            }

            /* Particules flottantes rouges */
            .particles-container {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: -998;
                pointer-events: none;
                overflow: hidden;
            }

            .particle {
                position: absolute;
                background: radial-gradient(
                    circle,
                    rgba(220, 38, 38, 0.8) 0%,
                    rgba(220, 38, 38, 0.2) 50%,
                    transparent 100%
                );
                border-radius: 50%;
                animation: float 15s infinite linear;
                opacity: 0.6;
            }

            /* Nouvelles particules étoiles */
            .particle-star {
                position: absolute;
                background: linear-gradient(45deg, #fff, #dc2626, #fff);
                border-radius: 50%;
                animation:
                    starFloat 12s infinite linear,
                    starTwinkle 2s infinite;
                opacity: 0.8;
                box-shadow: 0 0 10px rgba(220, 38, 38, 0.6);
            }

            /* Particules diamant */
            .particle-diamond {
                position: absolute;
                background: linear-gradient(45deg, #dc2626, #ef4444, #dc2626);
                transform: rotate(45deg);
                animation:
                    diamondFloat 18s infinite linear,
                    diamondSpin 3s infinite;
                opacity: 0.7;
                box-shadow: 0 0 15px rgba(220, 38, 38, 0.4);
            }

            /* Particules néon */
            .particle-neon {
                position: absolute;
                background: rgba(220, 38, 38, 0.9);
                border-radius: 50%;
                animation:
                    neonFloat 14s infinite linear,
                    neonPulse 1.5s infinite;
                box-shadow:
                    0 0 20px #dc2626,
                    0 0 40px #dc2626,
                    0 0 60px #dc2626;
                opacity: 0.9;
            }

            @keyframes float {
                0% {
                    transform: translateY(100vh) translateX(0) rotate(0deg);
                    opacity: 0;
                }
                10% {
                    opacity: 0.6;
                }
                90% {
                    opacity: 0.6;
                }
                100% {
                    transform: translateY(-100px) translateX(200px)
                        rotate(360deg);
                    opacity: 0;
                }
            }

            @keyframes starFloat {
                0% {
                    transform: translateY(100vh) translateX(-50px) rotate(0deg)
                        scale(0.5);
                    opacity: 0;
                }
                20% {
                    opacity: 1;
                }
                80% {
                    opacity: 1;
                }
                100% {
                    transform: translateY(-100px) translateX(100px)
                        rotate(720deg) scale(1.5);
                    opacity: 0;
                }
            }

            @keyframes starTwinkle {
                0%,
                100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.3);
                }
            }

            @keyframes diamondFloat {
                0% {
                    transform: translateY(100vh) translateX(50px) rotate(45deg)
                        scale(0.8);
                    opacity: 0;
                }
                15% {
                    opacity: 0.7;
                }
                85% {
                    opacity: 0.7;
                }
                100% {
                    transform: translateY(-100px) translateX(-150px)
                        rotate(405deg) scale(1.2);
                    opacity: 0;
                }
            }

            @keyframes diamondSpin {
                0% {
                    transform: rotate(45deg);
                }
                100% {
                    transform: rotate(405deg);
                }
            }

            @keyframes neonFloat {
                0% {
                    transform: translateY(100vh) translateX(0) scale(0.3);
                    opacity: 0;
                }
                25% {
                    opacity: 0.9;
                }
                75% {
                    opacity: 0.9;
                }
                100% {
                    transform: translateY(-100px) translateX(80px) scale(1.8);
                    opacity: 0;
                }
            }

            @keyframes neonPulse {
                0%,
                100% {
                    box-shadow:
                        0 0 20px #dc2626,
                        0 0 40px #dc2626,
                        0 0 60px #dc2626;
                }
                50% {
                    box-shadow:
                        0 0 40px #dc2626,
                        0 0 80px #dc2626,
                        0 0 120px #dc2626;
                }
            }

            /* Curseur exact de serveur-zg.rf.gd */
            :root {
                --primary-red: #ff0d0d;
                --dark-red: #8b0000;
                --blood-red: #660000;
                --crimson: #dc143c;
                --neon-red: #ff073a;
                --deep-black: #0a0a0a;
                --card-black: #111111;
                --border-red: #330000;
                
                /* Variables de thème dynamiques */
                --theme-primary: #dc2626;
                --theme-secondary: #991b1b;
                --theme-light: #ef4444;
                --theme-dark: #7f1d1d;
                --theme-particle: rgba(220, 38, 38, 0.8);
            }

            @media (hover: hover) and (pointer: fine) {
                * {
                    cursor: none !important;
                }
            }

            .custom-cursor {
                position: fixed;
                width: 20px;
                height: 20px;
                background: radial-gradient(
                    circle,
                    var(--theme-primary) 0%,
                    transparent 70%
                );
                border-radius: 50%;
                pointer-events: none;
                z-index: 10001;
                transition: transform 0.1s ease, background 0.3s ease, box-shadow 0.3s ease;
                box-shadow: 0 0 20px var(--theme-primary);
                display: none;
            }

            @media (hover: hover) and (pointer: fine) {
                .custom-cursor {
                    display: block;
                }
            }

            .cursor-trail {
                position: fixed;
                width: 6px;
                height: 6px;
                background: var(--theme-primary);
                border-radius: 50%;
                pointer-events: none;
                z-index: 10000;
                opacity: 0.8;
                animation: fadeTrail 0.5s ease-out forwards;
            }

            @keyframes fadeTrail {
                from {
                    opacity: 0.8;
                    transform: scale(1);
                }
                to {
                    opacity: 0;
                    transform: scale(0);
                }
            }

            .glass-effect {
                background: rgba(255, 255, 255, 0.05);
                backdrop-filter: blur(15px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
                -webkit-backface-visibility: hidden;
                backface-visibility: hidden;
                contain: layout style paint;
            }
            
            .glass-effect:hover {
                animation: glassShimmer 4s ease-in-out infinite;
            }

            @keyframes glassShimmer {
                0%,
                100% {
                    background: rgba(255, 255, 255, 0.03);
                }
                50% {
                    background: rgba(255, 255, 255, 0.08);
                }
            }

            .gradient-border {
                background: linear-gradient(
                    45deg,
                    var(--theme-primary),
                    var(--theme-secondary),
                    var(--theme-dark),
                    var(--theme-secondary),
                    var(--theme-primary)
                );
                padding: 1px;
                border-radius: 12px;
                -webkit-backface-visibility: hidden;
                backface-visibility: hidden;
                contain: layout style paint;
            }
            
            .gradient-border:hover {
                will-change: transform;
            }

            .gradient-border-content {
                background: rgba(17, 24, 39, 0.8);
                backdrop-filter: blur(20px);
                border-radius: 11px;
                height: 100%;
                -webkit-backface-visibility: hidden;
                backface-visibility: hidden;
                contain: layout style paint;
            }
            
            .gradient-border-content:hover {
                animation: contentGlow 3s ease-in-out infinite;
            }

            @keyframes contentGlow {
                0%,
                100% {
                    box-shadow: inset 0 0 20px color-mix(in srgb, var(--theme-primary) 10%, transparent);
                }
                50% {
                    box-shadow: inset 0 0 30px color-mix(in srgb, var(--theme-primary) 20%, transparent);
                }
            }

            .scrollbar-thin::-webkit-scrollbar {
                width: 8px;
            }
            .scrollbar-thin::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.05);
                border-radius: 10px;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb {
                background: linear-gradient(45deg, var(--theme-primary), var(--theme-secondary));
                border-radius: 10px;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(45deg, var(--theme-secondary), var(--theme-dark));
            }

            .btn-primary {
                background: linear-gradient(45deg, var(--theme-primary), var(--theme-secondary));
                transition: all 0.3s ease;
                transform: scale(1);
            }

            .btn-primary:hover {
                transform: scale(1.05);
                box-shadow: 0 10px 20px color-mix(in srgb, var(--theme-primary) 40%, transparent);
            }

            .pulse-animation {
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.7;
                }
            }

            .floating-animation {
                animation: floating 3s ease-in-out infinite;
            }

            @keyframes floating {
                0%,
                100% {
                    transform: translateY(0px);
                }
                50% {
                    transform: translateY(-10px);
                }
            }

            /* Logo néon animé */
            .logo-glow-container {
                position: relative;
                display: inline-block;
            }

            /* Effet de filets de lumière pour les éléments spéciaux */
            .light-scan-effect {
                position: relative;
                overflow: hidden;
            }

            .light-scan-effect::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 3px;
                background: linear-gradient(
                    90deg,
                    transparent 0%,
                    transparent 30%,
                    var(--theme-light) 50%,
                    transparent 70%,
                    transparent 100%
                );
                box-shadow: 0 0 20px var(--theme-primary),
                            0 0 30px var(--theme-light);
                opacity: 0.8;
                animation: lightScan 4s ease-in-out infinite;
                z-index: 100;
                pointer-events: none;
            }

            .light-scan-effect::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: -100%;
                width: 100%;
                height: 3px;
                background: linear-gradient(
                    90deg,
                    transparent 0%,
                    transparent 35%,
                    var(--theme-primary) 50%,
                    transparent 65%,
                    transparent 100%
                );
                box-shadow: 0 0 15px var(--theme-primary),
                            0 0 25px var(--theme-secondary);
                opacity: 0.7;
                animation: lightScan 4s ease-in-out infinite 2s;
                z-index: 100;
                pointer-events: none;
            }

            @keyframes lightScan {
                0% {
                    left: -100%;
                    opacity: 0;
                }
                20% {
                    opacity: 0.7;
                }
                80% {
                    opacity: 0.7;
                }
                100% {
                    left: 100%;
                    opacity: 0;
                }
            }

            .logo-neon {
                position: relative;
                z-index: 2;
                filter: drop-shadow(0 0 8px rgba(0, 0, 0, 0.6))
                        drop-shadow(0 0 15px var(--theme-primary))
                        drop-shadow(0 0 25px var(--theme-primary))
                        drop-shadow(0 0 40px var(--theme-secondary));
                animation: logoNeonPulse 3s ease-in-out infinite, logoRotate 8s ease-in-out infinite;
                transition: all 0.3s ease;
            }

            /* User Dropdown Menu Styles */
            .user-menu-container {
                position: relative;
            }

            .user-dropdown-menu {
                position: fixed !important;
                top: 75px !important;
                right: 12px !important;
                min-width: 200px;
                background: rgba(15, 15, 20, 0.95);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.15);
                border-radius: 12px;
                box-shadow: 
                    0 8px 32px rgba(0, 0, 0, 0.6),
                    0 0 0 1px color-mix(in srgb, var(--theme-primary) 30%, transparent);
                opacity: 0;
                transform: translateY(-10px);
                pointer-events: none;
                transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
                z-index: 1000000 !important;
                overflow: hidden;
            }
            
            @media (max-width: 640px) {
                .user-dropdown-menu {
                    top: 68px !important;
                    right: 8px !important;
                    min-width: 180px;
                }
            }

            .user-dropdown-menu.show {
                opacity: 1;
                transform: translateY(0);
                pointer-events: all;
            }

            .user-dropdown-item {
                padding: 12px 16px;
                color: rgba(255, 255, 255, 0.9);
                transition: all 0.2s ease;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 14px;
                font-weight: 500;
            }

            .user-dropdown-item:hover {
                background: linear-gradient(135deg, 
                    color-mix(in srgb, var(--theme-primary) 20%, transparent),
                    color-mix(in srgb, var(--theme-secondary) 15%, transparent));
                color: white;
            }

            .user-dropdown-item i {
                width: 20px;
                text-align: center;
                font-size: 16px;
            }

            .user-dropdown-divider {
                height: 1px;
                background: rgba(255, 255, 255, 0.1);
                margin: 4px 0;
            }

            .user-avatar-btn {
                cursor: pointer;
                transition: all 0.3s ease;
                position: relative;
            }

            .user-avatar-btn:hover {
                transform: scale(1.05);
            }
            
            .user-avatar-btn:hover img {
                box-shadow: 0 0 15px var(--theme-primary);
            }

            .logo-neon:hover {
                filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.8))
                        drop-shadow(0 0 25px var(--theme-light))
                        drop-shadow(0 0 40px var(--theme-primary))
                        drop-shadow(0 0 60px var(--theme-secondary));
                transform: scale(1.08);
            }

            @keyframes logoNeonPulse {
                0%, 100% {
                    filter: drop-shadow(0 0 8px rgba(0, 0, 0, 0.6))
                            drop-shadow(0 0 15px var(--theme-primary))
                            drop-shadow(0 0 25px var(--theme-primary))
                            drop-shadow(0 0 40px var(--theme-secondary));
                }
                50% {
                    filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.8))
                            drop-shadow(0 0 25px var(--theme-light))
                            drop-shadow(0 0 40px var(--theme-primary))
                            drop-shadow(0 0 60px var(--theme-secondary));
                }
            }

            @keyframes logoRotate {
                0%, 100% {
                    transform: rotate(0deg) scale(1);
                }
                25% {
                    transform: rotate(-5deg) scale(1.03);
                }
                50% {
                    transform: rotate(0deg) scale(1.05);
                }
                75% {
                    transform: rotate(5deg) scale(1.03);
                }
            }

            .card-hover {
                transition: all 0.3s ease;
            }

            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            }

            /* Queue Item Enhanced Styles */
            .queue-item {
                position: relative;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                background: linear-gradient(135deg, 
                    rgba(255, 255, 255, 0.03),
                    rgba(255, 255, 255, 0.01)
                );
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                overflow: hidden;
            }

            .queue-item::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(135deg, 
                    color-mix(in srgb, var(--theme-primary) 5%, transparent),
                    color-mix(in srgb, var(--theme-secondary) 5%, transparent)
                );
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: none;
            }

            .queue-item:hover::before {
                opacity: 1;
            }

            .queue-item:hover {
                transform: translateX(8px);
                border-color: color-mix(in srgb, var(--theme-primary) 40%, transparent);
                box-shadow: 
                    0 8px 25px rgba(0, 0, 0, 0.4),
                    0 0 20px color-mix(in srgb, var(--theme-primary) 20%, transparent);
            }

            /* Neon effect for user avatar in queue */
            .queue-user-avatar {
                position: relative;
                border-radius: 50%;
                border: 2px solid var(--theme-primary);
                box-shadow: 
                    0 0 10px var(--theme-primary),
                    0 0 20px color-mix(in srgb, var(--theme-primary) 50%, transparent),
                    inset 0 0 10px color-mix(in srgb, var(--theme-primary) 30%, transparent);
                animation: avatarNeonPulse 2s ease-in-out infinite;
            }

            @keyframes avatarNeonPulse {
                0%, 100% {
                    box-shadow: 
                        0 0 10px var(--theme-primary),
                        0 0 20px color-mix(in srgb, var(--theme-primary) 50%, transparent),
                        inset 0 0 10px color-mix(in srgb, var(--theme-primary) 30%, transparent);
                }
                50% {
                    box-shadow: 
                        0 0 15px var(--theme-light),
                        0 0 30px color-mix(in srgb, var(--theme-light) 60%, transparent),
                        inset 0 0 15px color-mix(in srgb, var(--theme-light) 40%, transparent);
                }
            }

            /* Platform badge with neon effect */
            .platform-badge {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 6px 12px;
                border-radius: 8px;
                font-size: 12px;
                font-weight: 600;
                border: 1px solid;
                transition: all 0.3s ease;
                box-shadow: 0 0 10px currentColor;
            }

            .platform-badge:hover {
                transform: scale(1.05);
                box-shadow: 0 0 20px currentColor;
            }

            /* Drag and Drop Styles */
            .queue-item[draggable="true"] {
                cursor: grab;
                user-select: none;
            }

            .queue-item.dragging {
                background: linear-gradient(135deg, 
                    color-mix(in srgb, var(--theme-primary) 30%, transparent),
                    color-mix(in srgb, var(--theme-secondary) 30%, transparent)
                );
                border: 2px solid var(--theme-primary);
                cursor: grabbing;
                z-index: 1000;
                transform: scale(1.05) rotate(2deg);
                box-shadow: 
                    0 12px 35px rgba(0, 0, 0, 0.6),
                    0 0 30px var(--theme-primary);
                opacity: 0.9;
            }

            .queue-item.drag-over {
                border-top: 3px solid var(--theme-light);
                background: linear-gradient(135deg, 
                    color-mix(in srgb, var(--theme-light) 15%, transparent),
                    color-mix(in srgb, var(--theme-primary) 15%, transparent)
                );
            }

            .queue-item.drag-placeholder {
                opacity: 0.4;
                background: rgba(255, 255, 255, 0.02);
                border: 2px dashed color-mix(in srgb, var(--theme-primary) 50%, transparent);
            }

            /* Touch drag indicator */
            .queue-item.touch-holding {
                animation: touchHoldPulse 0.6s ease-in-out;
            }

            @keyframes touchHoldPulse {
                0%, 100% {
                    transform: scale(1);
                    box-shadow: 0 0 0 rgba(255, 255, 255, 0);
                }
                50% {
                    transform: scale(1.02);
                    box-shadow: 0 0 20px color-mix(in srgb, var(--theme-primary) 60%, transparent);
                }
            }

            /* Progress Bar Styles */
            .progress-container {
                position: relative;
                width: 100%;
                height: 8px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
                overflow: hidden;
                margin: 16px 0;
                box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            }

            .progress-bar {
                height: 100%;
                background: linear-gradient(45deg, var(--theme-primary), var(--theme-light), var(--theme-primary));
                background-size: 200% 100%;
                border-radius: 10px;
                width: 0%;
                transition: width 0.3s ease;
                position: relative;
                animation: progressGlow 2s ease-in-out infinite;
            }

            @keyframes progressGlow {
                0%,
                100% {
                    box-shadow: 0 0 10px color-mix(in srgb, var(--theme-primary) 60%, transparent);
                    background-position: 0% 50%;
                }
                50% {
                    box-shadow: 0 0 20px color-mix(in srgb, var(--theme-primary) 90%, transparent);
                    background-position: 100% 50%;
                }
            }

            .progress-bar::after {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(255, 255, 255, 0.4),
                    transparent
                );
                animation: progressShine 2s ease-in-out infinite;
            }

            @keyframes progressShine {
                0% {
                    transform: translateX(-100%);
                }
                100% {
                    transform: translateX(100%);
                }
            }

            /* Enhanced Button Animations */
            .btn-primary {
                background: linear-gradient(45deg, var(--theme-primary), var(--theme-secondary));
                transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
                transform: scale(1);
                position: relative;
                overflow: hidden;
            }

            .btn-primary::before {
                content: "";
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(255, 255, 255, 0.2),
                    transparent
                );
                transition: left 0.5s;
            }

            .btn-primary:hover::before {
                left: 100%;
            }

            .btn-primary:hover {
                transform: scale(1.05) translateY(-2px);
                box-shadow: 0 15px 30px color-mix(in srgb, var(--theme-primary) 40%, transparent);
            }

            /* Enhanced Cards */
            .card-hover {
                transition: transform 0.3s cubic-bezier(0.23, 1, 0.32, 1);
                position: relative;
                -webkit-backface-visibility: hidden;
                backface-visibility: hidden;
                contain: layout style paint;
            }
            
            .card-hover:hover {
                will-change: transform;
            }
            
            /* Optimisation scroll - désactiver les animations pendant le scroll */
            body.scrolling .glass-effect,
            body.scrolling .gradient-border-content,
            body.scrolling .card-hover {
                animation: none !important;
                transition: none !important;
            }
            
            /* Optimisation scroll mobile */
            @media (max-width: 768px) {
                body {
                    -webkit-overflow-scrolling: touch;
                }
                
                .gradient-border-content {
                    backdrop-filter: blur(10px);
                }
                
                .glass-effect {
                    backdrop-filter: blur(8px);
                }
                
                /* Réduire les animations sur mobile */
                .particle {
                    animation-duration: 20s;
                }
            }

            .card-hover::before {
                content: "";
                position: absolute;
                inset: 0;
                padding: 2px;
                background: linear-gradient(
                    45deg,
                    var(--theme-primary),
                    transparent,
                    var(--theme-primary)
                );
                border-radius: inherit;
                mask:
                    linear-gradient(#fff 0 0) content-box,
                    linear-gradient(#fff 0 0);
                mask-composite: exclude;
                opacity: 0;
                transition: opacity 0.3s;
            }

            .card-hover:hover::before {
                opacity: 1;
            }

            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            }

            /* Ripple Effect */
            .ripple {
                position: relative;
                overflow: hidden;
            }

            .ripple::before {
                content: "";
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.3);
                transform: translate(-50%, -50%);
                transition:
                    width 0.6s,
                    height 0.6s;
            }

            .ripple:active::before {
                width: 300px;
                height: 300px;
            }

            /* Popup de bienvenue */
            .welcome-popup {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(10px);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 1;
                transition: opacity 0.5s ease;
            }

            .welcome-popup.hidden {
                opacity: 0;
                pointer-events: none;
            }

            .popup-content {
                background: linear-gradient(
                    145deg,
                    rgba(17, 24, 39, 0.95),
                    rgba(31, 41, 55, 0.95)
                );
                border: 2px solid rgba(220, 38, 38, 0.5);
                border-radius: 20px;
                padding: 2rem;
                max-width: 600px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 25px 50px rgba(220, 38, 38, 0.3);
                animation: popupSlideIn 0.6s cubic-bezier(0.23, 1, 0.32, 1);
                position: relative;
            }

            @keyframes popupSlideIn {
                0% {
                    transform: scale(0.8) translateY(50px);
                    opacity: 0;
                }
                100% {
                    transform: scale(1) translateY(0);
                    opacity: 1;
                }
            }

            .popup-header {
                text-align: center;
                margin-bottom: 1.5rem;
            }

            .popup-title {
                font-size: 2rem;
                font-weight: bold;
                background: linear-gradient(45deg, #dc2626, #ef4444, #dc2626);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                margin-bottom: 0.5rem;
                animation: titleGlow 3s ease-in-out infinite;
            }

            @keyframes titleGlow {
                0%,
                100% {
                    filter: brightness(1);
                }
                50% {
                    filter: brightness(1.3);
                }
            }

            .popup-subtitle {
                color: rgba(255, 255, 255, 0.8);
                font-size: 1.1rem;
                margin-bottom: 1rem;
            }

            .features-grid {
                display: grid;
                gap: 1rem;
                margin: 1.5rem 0;
            }

            .feature-item {
                background: rgba(220, 38, 38, 0.1);
                border: 1px solid rgba(220, 38, 38, 0.3);
                border-radius: 12px;
                padding: 1rem;
                transition: all 0.3s ease;
            }

            .feature-item:hover {
                background: rgba(220, 38, 38, 0.15);
                border-color: rgba(220, 38, 38, 0.5);
                transform: translateY(-2px);
            }

            .feature-icon {
                color: #dc2626;
                font-size: 1.5rem;
                margin-right: 0.75rem;
            }

            .feature-title {
                color: #fff;
                font-weight: 600;
                font-size: 1.1rem;
                margin-bottom: 0.25rem;
            }

            .feature-desc {
                color: rgba(255, 255, 255, 0.7);
                font-size: 0.9rem;
                line-height: 1.4;
            }

            .popup-close-btn {
                background: linear-gradient(45deg, #dc2626, #991b1b);
                color: white;
                border: none;
                border-radius: 12px;
                padding: 0.75rem 2rem;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                width: 100%;
                margin-top: 1.5rem;
            }

            .popup-close-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 20px rgba(220, 38, 38, 0.4);
            }

            .popup-banner {
                width: 100%;
                border-radius: 15px;
                margin: 1rem 0;
                box-shadow: 0 10px 30px rgba(220, 38, 38, 0.3);
            }

            /* Dashboard Tabs Styles */
            .dashboard-tab {
                background: rgba(255, 255, 255, 0.05);
                color: rgba(255, 255, 255, 0.6);
                border: 1px solid rgba(255, 255, 255, 0.1);
                cursor: pointer;
                min-width: fit-content;
                flex: 1;
                justify-content: center;
                white-space: nowrap;
            }
            
            @media (max-width: 640px) {
                .dashboard-tab {
                    flex: 1;
                    padding: 0.75rem 0.5rem;
                }
            }

            .dashboard-tab:hover {
                background: rgba(255, 255, 255, 0.1);
                color: rgba(255, 255, 255, 0.8);
                transform: translateY(-2px);
            }

            .dashboard-tab.active {
                background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
                color: white;
                border-color: transparent;
                box-shadow: 0 0 20px color-mix(in srgb, var(--theme-primary) 40%, transparent);
                box-shadow: 0 4px 15px color-mix(in srgb, var(--theme-primary) 40%, transparent);
            }

            .tab-content {
                animation: fadeInTab 0.4s ease-in-out;
            }

            @keyframes fadeInTab {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Settings Styles */
            .platform-pref-btn, .theme-btn {
                background: rgba(255, 255, 255, 0.05);
                color: rgba(255, 255, 255, 0.6);
                border: 2px solid rgba(255, 255, 255, 0.1);
                cursor: pointer;
            }

            .platform-pref-btn:hover, .theme-btn:hover {
                background: rgba(255, 255, 255, 0.1);
                color: rgba(255, 255, 255, 0.9);
                border-color: rgba(255, 255, 255, 0.2);
            }

            .platform-pref-btn.active, .theme-btn.active {
                background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
                color: white;
                border-color: var(--theme-primary);
                box-shadow: 0 4px 15px color-mix(in srgb, var(--theme-primary) 30%, transparent);
            }

            /* Range Slider Styling */
            input[type="range"]::-webkit-slider-thumb {
                appearance: none;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
                cursor: pointer;
                box-shadow: 0 2px 10px color-mix(in srgb, var(--theme-primary) 50%, transparent);
            }

            input[type="range"]::-moz-range-thumb {
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
                cursor: pointer;
                border: none;
                box-shadow: 0 2px 10px color-mix(in srgb, var(--theme-primary) 50%, transparent);
            }

            /* Statistics Chart Animation */
            @keyframes barGrow {
                from {
                    transform: scaleY(0);
                }
                to {
                    transform: scaleY(1);
                }
            }

            /* Classes utilitaires pour le thème dynamique */
            .theme-gradient-text {
                background: linear-gradient(45deg, var(--theme-light), var(--theme-primary));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            .theme-bg-gradient {
                background: linear-gradient(45deg, var(--theme-primary), var(--theme-secondary));
            }

            .theme-bg-gradient-hover:hover {
                background: linear-gradient(45deg, var(--theme-secondary), var(--theme-dark));
            }

            .theme-text {
                color: var(--theme-light);
            }

            .theme-border {
                border-color: color-mix(in srgb, var(--theme-primary) 30%, transparent);
            }

            /* Styles pour le popup de recherche avec thème dynamique */
            .close-btn-theme:hover {
                background: color-mix(in srgb, var(--theme-primary) 30%, transparent) !important;
            }

            .search-input-theme:focus {
                box-shadow: 0 0 0 3px color-mix(in srgb, var(--theme-primary) 20%, transparent) !important;
            }

            /* Boutons de contrôle de la file d'attente */
            .queue-control-btn:hover:not(.opacity-30) {
                background: linear-gradient(135deg, color-mix(in srgb, var(--theme-primary) 40%, transparent), color-mix(in srgb, var(--theme-secondary) 40%, transparent)) !important;
                color: white !important;
            }

            /* Hover du titre dans la file d'attente */
            .queue-item:hover .queue-title-hover {
                color: var(--theme-light) !important;
            }

            /* Notes de musique animées dans le popup */
            .popup-music-note {
                position: absolute;
                font-size: 20px;
                opacity: 0;
                animation: popupNoteFloat 8s linear infinite;
                pointer-events: none;
            }

            @keyframes popupNoteFloat {
                0% {
                    transform: translateY(150px) rotate(0deg) scale(0.5);
                    opacity: 0;
                }
                10% {
                    opacity: 0.6;
                }
                90% {
                    opacity: 0.6;
                }
                100% {
                    transform: translateY(-150px) rotate(360deg) scale(1.2);
                    opacity: 0;
                }
            }

            /* Animations pour popup de recherche */
            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateY(30px) scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            /* Fix menu couleur z-index pour PC et mobile */
            #colorPickerMenu {
                position: fixed !important;
                z-index: 999999 !important;
                transform: translate(0, 0);
            }
            
            /* Header avec z-index minimal pour ne pas bloquer le menu utilisateur */
            header {
                position: relative;
                z-index: 1;
            }

            /* Effet de vague lumineuse pour bouton musique */
            .btn-music-shine {
                position: relative;
                overflow: hidden;
                will-change: transform;
            }

            .btn-music-shine::before {
                content: '';
                position: absolute;
                top: -50%;
                left: -60%;
                width: 30%;
                height: 200%;
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(255, 255, 255, 0.8),
                    transparent
                );
                transform: skewX(-25deg);
                animation: waveShine 4s ease-in-out infinite;
                will-change: left;
            }

            .btn-music-shine::after {
                content: '';
                position: absolute;
                top: -50%;
                left: -60%;
                width: 20%;
                height: 200%;
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(255, 255, 255, 0.4),
                    transparent
                );
                transform: skewX(-25deg);
                animation: waveShine 4s ease-in-out infinite 0.3s;
                will-change: left;
            }

            @keyframes waveShine {
                0% {
                    left: -60%;
                }
                100% {
                    left: 160%;
                }
            }
            
            /* Contrôle de volume circulaire ultra moderne - Pro Design */
            .volume-control-container {
                position: relative;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 24px;
            }
            
            /* Indicateur circulaire de volume interactif */
            .volume-circular {
                position: relative;
                width: 120px;
                height: 120px;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                cursor: pointer;
                touch-action: none;
                user-select: none;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                filter: drop-shadow(0 0 15px color-mix(in srgb, var(--theme-primary) 25%, transparent))
                        drop-shadow(0 0 25px color-mix(in srgb, var(--theme-light) 15%, transparent));
            }
            
            .volume-circular::before {
                content: '';
                position: absolute;
                inset: -8px;
                border-radius: 50%;
                background: radial-gradient(circle, 
                    transparent 40%, 
                    color-mix(in srgb, var(--theme-primary) 15%, transparent) 70%,
                    color-mix(in srgb, var(--theme-light) 20%, transparent) 85%,
                    transparent 100%);
                opacity: 0.6;
                animation: volumeNeonPulse 3s ease-in-out infinite;
                pointer-events: none;
                z-index: -1;
            }
            
            @keyframes volumeNeonPulse {
                0%, 100% {
                    opacity: 0.6;
                    transform: scale(1);
                }
                50% {
                    opacity: 0.8;
                    transform: scale(1.05);
                }
            }
            
            .volume-circular:hover {
                transform: scale(1.05);
                filter: drop-shadow(0 0 20px color-mix(in srgb, var(--theme-light) 35%, transparent))
                        drop-shadow(0 0 35px color-mix(in srgb, var(--theme-primary) 25%, transparent));
            }
            
            .volume-circular:hover::before {
                opacity: 1;
                animation: volumeNeonPulseHover 2s ease-in-out infinite;
            }
            
            @keyframes volumeNeonPulseHover {
                0%, 100% {
                    opacity: 0.8;
                    transform: scale(1.05);
                }
                50% {
                    opacity: 1;
                    transform: scale(1.1);
                }
            }
            
            .volume-circular:active {
                transform: scale(0.98);
            }
            
            /* Cercle de fond avec effet 3D */
            .volume-circle-bg {
                position: absolute;
                width: 100%;
                height: 100%;
                border-radius: 50%;
                background: radial-gradient(circle at 30% 30%, 
                    rgba(255, 255, 255, 0.08), 
                    rgba(255, 255, 255, 0.02));
                box-shadow: 
                    inset 0 0 30px rgba(0, 0, 0, 0.6),
                    inset -8px -8px 20px rgba(0, 0, 0, 0.4),
                    inset 8px 8px 20px rgba(255, 255, 255, 0.05),
                    0 10px 40px rgba(0, 0, 0, 0.4);
                border: 1px solid rgba(255, 255, 255, 0.05);
            }
            
            /* Progression circulaire améliorée */
            .volume-circle-progress {
                position: absolute;
                width: 100%;
                height: 100%;
                border-radius: 50%;
                background: conic-gradient(
                    from -90deg,
                    var(--theme-light) 0%,
                    var(--theme-primary) calc(var(--volume-progress, 100%) / 2),
                    var(--theme-secondary) var(--volume-progress, 100%),
                    rgba(255, 255, 255, 0.03) var(--volume-progress, 100%)
                );
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                animation: volumeGlow 3s ease-in-out infinite;
                filter: blur(0.5px);
            }
            
            @keyframes volumeGlow {
                0%, 100% {
                    filter: blur(0.5px) drop-shadow(0 0 3px rgba(0, 0, 0, 0.4))
                            drop-shadow(0 0 6px color-mix(in srgb, var(--theme-primary) 15%, transparent));
                }
                50% {
                    filter: blur(0.5px) drop-shadow(0 0 4px rgba(0, 0, 0, 0.5))
                            drop-shadow(0 0 10px color-mix(in srgb, var(--theme-primary) 25%, transparent));
                }
            }
            
            /* Cercle intérieur avec effet néomorphique */
            .volume-circle-inner {
                position: absolute;
                width: 82%;
                height: 82%;
                border-radius: 50%;
                background: radial-gradient(circle at 35% 35%, 
                    rgba(25, 30, 40, 0.98) 0%, 
                    rgba(12, 12, 15, 0.98) 60%,
                    rgba(8, 8, 10, 0.98) 100%);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 6px;
                box-shadow: 
                    0 0 30px rgba(0, 0, 0, 0.6),
                    0 0 15px color-mix(in srgb, var(--theme-primary) 8%, transparent),
                    inset 5px 5px 18px rgba(0, 0, 0, 0.6),
                    inset -5px -5px 18px rgba(255, 255, 255, 0.04);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            /* Icône de volume avec animation fluide */
            .volume-icon-display {
                font-size: 36px;
                background: linear-gradient(135deg, 
                    var(--theme-light) 0%, 
                    var(--theme-primary) 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                filter: drop-shadow(0 0 6px rgba(0, 0, 0, 0.7))
                        drop-shadow(0 0 12px color-mix(in srgb, var(--theme-light) 35%, transparent))
                        drop-shadow(0 0 20px color-mix(in srgb, var(--theme-primary) 25%, transparent));
                animation: volumeIconPulse 2.5s ease-in-out infinite;
                transition: all 0.3s ease;
            }
            
            @keyframes volumeIconPulse {
                0%, 100% {
                    transform: scale(1);
                    filter: drop-shadow(0 0 6px rgba(0, 0, 0, 0.7))
                            drop-shadow(0 0 12px color-mix(in srgb, var(--theme-light) 35%, transparent))
                            drop-shadow(0 0 20px color-mix(in srgb, var(--theme-primary) 25%, transparent));
                }
                50% {
                    transform: scale(1.08);
                    filter: drop-shadow(0 0 8px rgba(0, 0, 0, 0.8))
                            drop-shadow(0 0 18px color-mix(in srgb, var(--theme-light) 45%, transparent))
                            drop-shadow(0 0 28px color-mix(in srgb, var(--theme-primary) 35%, transparent));
                }
            }
            
            /* Pourcentage de volume stylisé */
            .volume-percentage {
                font-size: 18px;
                font-weight: 800;
                background: linear-gradient(135deg, 
                    var(--theme-light) 0%, 
                    var(--theme-primary) 50%,
                    var(--theme-secondary) 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                filter: drop-shadow(0 1px 3px rgba(0, 0, 0, 0.8))
                        drop-shadow(0 0 8px color-mix(in srgb, var(--theme-primary) 25%, transparent))
                        drop-shadow(0 0 14px color-mix(in srgb, var(--theme-light) 15%, transparent));
                letter-spacing: 1px;
                line-height: 1;
            }
            
            /* Indicateur de rotation pour mobile */
            .volume-rotation-indicator {
                position: absolute;
                width: 4px;
                height: 30%;
                background: linear-gradient(to bottom, 
                    var(--theme-light), 
                    transparent);
                border-radius: 2px;
                top: 15%;
                left: 50%;
                transform-origin: center 120%;
                transform: translateX(-50%) rotate(0deg);
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.3s ease;
                filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.5));
            }
            
            .volume-circular.rotating .volume-rotation-indicator {
                opacity: 0.5;
            }
            
            /* Feedback visuel lors de l'interaction */
            .volume-circular.interacting .volume-circle-progress {
                animation: none;
                filter: blur(0.5px) drop-shadow(0 0 8px rgba(0, 0, 0, 0.5))
                        drop-shadow(0 0 15px color-mix(in srgb, var(--theme-light) 35%, transparent));
            }
            
            .volume-circular.interacting .volume-circle-inner {
                box-shadow: 
                    0 0 30px rgba(0, 0, 0, 0.7),
                    0 0 20px color-mix(in srgb, var(--theme-primary) 15%, transparent),
                    inset 4px 4px 20px rgba(0, 0, 0, 0.6),
                    inset -4px -4px 20px rgba(255, 255, 255, 0.05);
            }
            
            /* Conteneur de boutons de volume côte à côte */
            .volume-controls-row {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 24px;
            }
            
            /* Boutons de contrôle volume ultra stylés */
            .volume-btn {
                width: 45px;
                height: 45px;
                border-radius: 50%;
                background: linear-gradient(145deg, 
                    rgba(20, 25, 35, 0.98), 
                    rgba(10, 10, 10, 0.98));
                border: 2px solid var(--theme-primary);
                color: var(--theme-light);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                position: relative;
                overflow: hidden;
                flex-shrink: 0;
                box-shadow: 
                    0 4px 15px rgba(0, 0, 0, 0.5),
                    0 0 8px color-mix(in srgb, var(--theme-primary) 12%, transparent),
                    inset 3px 3px 10px rgba(0, 0, 0, 0.5),
                    inset -3px -3px 10px rgba(255, 255, 255, 0.03);
            }
            
            .volume-btn::before {
                content: '';
                position: absolute;
                inset: 0;
                background: radial-gradient(circle at center, var(--theme-light), transparent 70%);
                opacity: 0;
                transition: opacity 0.3s ease;
                border-radius: 50%;
            }
            
            .volume-btn::after {
                content: '';
                position: absolute;
                inset: -2px;
                border-radius: 50%;
                padding: 2px;
                background: linear-gradient(135deg, var(--theme-light), var(--theme-primary), var(--theme-secondary));
                -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                -webkit-mask-composite: xor;
                mask-composite: exclude;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            .volume-btn:hover {
                background: linear-gradient(145deg, 
                    rgba(30, 35, 50, 0.98), 
                    rgba(15, 15, 15, 0.98));
                border-color: var(--theme-light);
                transform: scale(1.12);
                box-shadow: 
                    0 6px 20px rgba(0, 0, 0, 0.6),
                    0 0 16px color-mix(in srgb, var(--theme-light) 25%, transparent),
                    inset 3px 3px 15px rgba(0, 0, 0, 0.6),
                    inset -3px -3px 15px rgba(255, 255, 255, 0.05);
            }
            
            .volume-btn:hover::before {
                opacity: 0.2;
            }
            
            .volume-btn:hover::after {
                opacity: 1;
            }
            
            .volume-btn:active {
                transform: scale(1.05);
                box-shadow: 
                    0 3px 12px rgba(0, 0, 0, 0.7),
                    0 0 8px rgba(0, 0, 0, 0.5),
                    inset 4px 4px 18px rgba(0, 0, 0, 0.7),
                    inset -4px -4px 18px rgba(255, 255, 255, 0.02);
            }
            
            .volume-btn i {
                font-size: 18px;
                filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.5))
                        drop-shadow(0 0 6px color-mix(in srgb, var(--theme-primary) 15%, transparent));
                font-weight: 900;
                transition: all 0.3s ease;
            }
            
            .volume-btn:hover i {
                filter: drop-shadow(0 0 4px rgba(0, 0, 0, 0.6))
                        drop-shadow(0 0 10px color-mix(in srgb, var(--theme-light) 30%, transparent));
                transform: scale(1.1);
            }
            
            /* Animation pulsante pour bouton musique */
            .btn-pulse-attract {
                animation: pulseAttract 4s ease-in-out infinite;
            }
            
            @keyframes pulseAttract {
                0%, 100% {
                    transform: scale(1);
                    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
                }
                25% {
                    transform: scale(1.02) translateY(-2px);
                    box-shadow: 0 15px 30px var(--theme-primary)/40;
                }
                50% {
                    transform: scale(1);
                    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
                }
                75% {
                    transform: scale(1.02) translateY(-2px);
                    box-shadow: 0 15px 30px var(--theme-primary)/40;
                }
            }

            /* Styles pour l'historique groupé avec effets néon */
            .history-group-card {
                background: rgba(255, 255, 255, 0.03);
                backdrop-filter: blur(15px);
                border: 1px solid rgba(255, 255, 255, 0.08);
                border-radius: 16px;
                padding: 16px;
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }

            .history-group-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 2px;
                background: linear-gradient(90deg, transparent, var(--theme-primary), transparent);
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .history-group-card:hover {
                background: rgba(255, 255, 255, 0.06);
                border-color: rgba(255, 255, 255, 0.15);
                transform: translateY(-2px);
                box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            }

            .history-group-card:hover::before {
                opacity: 1;
            }

            /* Avatar avec effet néon */
            .history-avatar-neon {
                position: relative;
                border-radius: 50%;
                box-shadow: 
                    0 0 10px color-mix(in srgb, var(--theme-primary) 30%, transparent),
                    0 0 20px color-mix(in srgb, var(--theme-primary) 20%, transparent),
                    0 0 30px color-mix(in srgb, var(--theme-light) 10%, transparent);
                border: 2px solid color-mix(in srgb, var(--theme-primary) 40%, transparent);
                animation: avatarNeonPulse 3s ease-in-out infinite;
            }

            @keyframes avatarNeonPulse {
                0%, 100% {
                    box-shadow: 
                        0 0 10px color-mix(in srgb, var(--theme-primary) 30%, transparent),
                        0 0 20px color-mix(in srgb, var(--theme-primary) 20%, transparent),
                        0 0 30px color-mix(in srgb, var(--theme-light) 10%, transparent);
                }
                50% {
                    box-shadow: 
                        0 0 15px color-mix(in srgb, var(--theme-light) 40%, transparent),
                        0 0 30px color-mix(in srgb, var(--theme-primary) 30%, transparent),
                        0 0 45px color-mix(in srgb, var(--theme-secondary) 20%, transparent);
                }
            }

            /* Pseudo avec effet néon */
            .history-username-neon {
                background: linear-gradient(135deg, var(--theme-light), var(--theme-primary));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                font-weight: 700;
                text-shadow: 
                    0 0 10px color-mix(in srgb, var(--theme-primary) 30%, transparent),
                    0 0 20px color-mix(in srgb, var(--theme-primary) 20%, transparent);
                filter: drop-shadow(0 0 8px color-mix(in srgb, var(--theme-primary) 25%, transparent))
                        drop-shadow(0 0 15px color-mix(in srgb, var(--theme-light) 15%, transparent));
                animation: usernameGlow 4s ease-in-out infinite;
            }

            @keyframes usernameGlow {
                0%, 100% {
                    filter: drop-shadow(0 0 8px color-mix(in srgb, var(--theme-primary) 25%, transparent))
                            drop-shadow(0 0 15px color-mix(in srgb, var(--theme-light) 15%, transparent));
                }
                50% {
                    filter: drop-shadow(0 0 12px color-mix(in srgb, var(--theme-light) 35%, transparent))
                            drop-shadow(0 0 22px color-mix(in srgb, var(--theme-primary) 25%, transparent));
                }
            }

            /* Date/heure simple et élégante */
            .history-datetime {
                color: rgba(255, 255, 255, 0.5);
                font-weight: 500;
                font-size: 0.75rem;
            }

            /* Bouton favoris avec animation */
            .btn-favorite {
                background: linear-gradient(135deg, rgba(220, 38, 38, 0.15), rgba(153, 27, 27, 0.15));
                border: 2px solid color-mix(in srgb, var(--theme-primary) 30%, transparent);
                color: var(--theme-light);
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }

            .btn-favorite::before {
                content: '';
                position: absolute;
                inset: 0;
                background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .btn-favorite:hover {
                transform: scale(1.1);
                border-color: var(--theme-light);
                box-shadow: 
                    0 0 15px color-mix(in srgb, var(--theme-primary) 40%, transparent),
                    0 0 25px color-mix(in srgb, var(--theme-light) 25%, transparent);
            }

            .btn-favorite:hover::before {
                opacity: 0.2;
            }

            .btn-favorite.is-favorite {
                background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
                border-color: var(--theme-light);
                animation: heartBeat 1.5s ease-in-out infinite;
            }

            @keyframes heartBeat {
                0%, 100% {
                    transform: scale(1);
                }
                10% {
                    transform: scale(1.1);
                }
                20% {
                    transform: scale(1);
                }
            }

            /* Pochette d'album avec effet hover */
            .history-thumbnail {
                position: relative;
                border-radius: 12px;
                overflow: hidden;
                transition: all 0.3s ease;
            }

            .history-thumbnail:hover {
                transform: scale(1.05);
                box-shadow: 
                    0 8px 25px rgba(0, 0, 0, 0.5),
                    0 0 15px color-mix(in srgb, var(--theme-primary) 30%, transparent);
            }

            /* Badge de compteur de lecture */
            .play-count-badge {
                background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
                color: white;
                font-size: 0.75rem;
                font-weight: 700;
                padding: 4px 10px;
                border-radius: 20px;
                box-shadow: 
                    0 2px 8px rgba(0, 0, 0, 0.3),
                    0 0 10px color-mix(in srgb, var(--theme-primary) 30%, transparent);
                animation: badgePulse 3s ease-in-out infinite;
            }

            @keyframes badgePulse {
                0%, 100% {
                    box-shadow: 
                        0 2px 8px rgba(0, 0, 0, 0.3),
                        0 0 10px color-mix(in srgb, var(--theme-primary) 30%, transparent);
                }
                50% {
                    box-shadow: 
                        0 2px 12px rgba(0, 0, 0, 0.4),
                        0 0 18px color-mix(in srgb, var(--theme-light) 40%, transparent);
                }
            }

            /* Responsive mobile pour la barre de recherche */
            @media (max-width: 640px) {
                .history-search-input {
                    width: 100%;
                    font-size: 14px;
                    padding: 10px 12px;
                }

                .history-group-card {
                    padding: 12px;
                }

                .history-thumbnail {
                    width: 60px !important;
                    height: 60px !important;
                }

                .btn-favorite,
                .btn-add-queue {
                    padding: 8px 10px !important;
                    font-size: 14px;
                }
            }
        </style>
    </head>
    <body class="bg-gray-900 text-white min-h-screen">
        <!-- Fond d'écran animé rouge magnifique -->
        <div class="animated-background"></div>

        <!-- Conteneur de particules flottantes -->
        <div class="particles-container" id="particlesContainer"></div>

        <!-- Overlay pour la lisibilité du texte -->
        <div class="background-overlay"></div>

        <!-- Les curseurs seront créés dynamiquement via JavaScript -->

        <!-- Menu de sélection de couleur moderne (en dehors du header pour z-index) -->
        <div
            id="colorPickerMenu"
            class="hidden w-56 backdrop-blur-xl bg-black/80 border border-white/10 rounded-2xl shadow-2xl p-4"
            style="box-shadow: 0 20px 60px rgba(0,0,0,0.7), 0 0 20px rgba(255,255,255,0.05);"
        >
            <div class="text-white text-sm font-semibold mb-3 flex items-center justify-between px-1">
                <span class="flex items-center gap-2">
                    <i class="fas fa-palette" style="font-size: 14px;"></i>
                    <span>Thème</span>
                </span>
            </div>
            <div class="space-y-2">
                <button
                    id="theme-red-btn"
                    onclick="changeGradient('red')"
                    class="group w-full px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 hover:border-red-400/50 text-white font-medium transition-all duration-300 hover:scale-[1.02] flex items-center justify-between"
                >
                    <span class="flex items-center gap-2.5">
                        <div class="w-5 h-5 rounded-full bg-gradient-to-br from-red-500 to-red-700 ring-2 ring-red-400/30"></div>
                        <span class="text-sm">Rouge</span>
                    </span>
                    <i id="theme-red-check" class="fas fa-check text-red-400 text-sm opacity-100 transition-all duration-300"></i>
                </button>
                <button
                    id="theme-blue-btn"
                    onclick="changeGradient('blue')"
                    class="group w-full px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 hover:border-blue-400/50 text-white font-medium transition-all duration-300 hover:scale-[1.02] flex items-center justify-between"
                >
                    <span class="flex items-center gap-2.5">
                        <div class="w-5 h-5 rounded-full bg-gradient-to-br from-blue-500 to-blue-700 ring-2 ring-blue-400/30"></div>
                        <span class="text-sm">Bleu</span>
                    </span>
                    <i id="theme-blue-check" class="fas fa-check text-blue-400 text-sm opacity-0 transition-all duration-300"></i>
                </button>
            </div>
        </div>

        <!-- Header -->
        <header id="mainHeader" class="glass-effect shadow-2xl border-b border-white/10 hidden">
            <div class="max-w-7xl mx-auto px-3 sm:px-4 py-1">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="relative logo-glow-container">
                            <img
                                id="themeLogo"
                                src="zg-logo-silver.png"
                                alt="ZG Logo"
                                class="h-20 w-20 sm:h-24 sm:w-24 md:h-28 md:w-28 logo-neon mt-1"
                            />
                        </div>
                    </div>
                    <div class="flex items-center space-x-3 sm:space-x-4">
                        <button
                            id="colorPickerBtn"
                            class="bg-gradient-to-r from-red-600 to-red-800 hover:from-red-700 hover:to-red-900 text-white px-4 py-3 sm:px-5 sm:py-3.5 rounded-full transition-all duration-300 font-medium text-sm sm:text-base flex items-center justify-center space-x-2 shadow-lg hover:shadow-xl hover:scale-105"
                            title="Changer la couleur du dégradé"
                            onclick="toggleColorPicker()"
                        >
                            <i class="fas fa-palette text-sm sm:text-base"></i>
                            <span class="hidden sm:inline">Couleur</span>
                        </button>
                        
                        <!-- Search Button -->
                        <button
                            id="searchButton"
                            onclick="openSearchPopup()"
                            class="bg-gradient-to-r from-red-600 to-red-800 hover:from-red-700 hover:to-red-900 text-white px-4 py-3 sm:px-5 sm:py-3.5 rounded-full transition-all duration-300 font-medium text-sm sm:text-base flex items-center justify-center space-x-2 shadow-lg hover:shadow-xl hover:scale-105 hidden"
                            title="Rechercher de la musique"
                        >
                            <i class="fas fa-search text-sm sm:text-base"></i>
                            <span class="hidden sm:inline">Recherche</span>
                        </button>
                        
                        <!-- User Profile Avatar Button -->
                        <div id="userProfile" class="hidden">
                            <div class="user-avatar-btn flex items-center space-x-2" onclick="toggleUserMenu(event)">
                                <img id="userAvatar" src="" alt="Avatar" class="w-10 h-10 rounded-full border-2 border-[var(--theme-primary)]" />
                                <span id="userName" class="text-white text-sm font-medium hidden sm:inline"></span>
                                <i class="fas fa-chevron-down text-white/60 text-xs hidden sm:inline"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- User Dropdown Menu (Outside header for proper z-index) -->
        <div id="userDropdownMenu" class="user-dropdown-menu">
            <div class="user-dropdown-item" onclick="logout()">
                <i class="fas fa-sign-out-alt" style="color: #ef4444;"></i>
                <span>Se déconnecter</span>
            </div>
        </div>

        <!-- Page de connexion Discord -->
        <div id="loginPage" class="fixed inset-0 z-50 flex items-center justify-center overflow-hidden">
            <!-- Background Image avec effet de flou -->
            <div class="absolute inset-0 w-full h-full">
                <div class="absolute inset-0 w-full h-full bg-cover bg-center" 
                     style="background-image: url('https://i.pinimg.com/1200x/28/db/fb/28dbfbab4afdb0472e9a1855adb643c3.jpg'); filter: blur(8px); transform: scale(1.1);">
                </div>
                <!-- Overlay gradient pour améliorer la lisibilité -->
                <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/50 to-black/70"></div>
            </div>
            
            <!-- Container de connexion -->
            <div class="relative z-10 w-full max-w-md mx-4 px-4 sm:px-0" style="animation: slideUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);">
                <!-- Card de connexion avec effet glassmorphism -->
                <div class="relative backdrop-blur-xl bg-white/10 rounded-3xl shadow-2xl border border-white/20 overflow-hidden">
                    <!-- Effet de lumière en haut -->
                    <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-white/50 to-transparent"></div>
                    
                    <!-- Contenu -->
                    <div class="p-8 sm:p-12">
                        <!-- Logo et titre -->
                        <div class="flex flex-col items-center mb-10 sm:mb-12">
                            <div class="relative mb-6 sm:mb-8">
                                <div class="absolute inset-0 bg-gradient-to-r from-[#5865F2] to-[#7289DA] rounded-full blur-2xl opacity-50 animate-pulse"></div>
                                <img
                                    src="zg-logo-silver.png"
                                    alt="ZG Music Logo"
                                    class="relative h-32 w-32 sm:h-40 sm:w-40 drop-shadow-2xl"
                                    style="animation: floating 3s ease-in-out infinite;"
                                />
                            </div>
                            <h1 class="text-4xl sm:text-5xl font-black text-center mb-3 sm:mb-4 text-white drop-shadow-lg" style="
                                text-shadow: 0 0 40px rgba(88, 101, 242, 0.5), 0 0 80px rgba(88, 101, 242, 0.3);
                            ">ZG MUSIC</h1>
                            <p class="text-white/80 text-center text-base sm:text-lg font-medium">
                                Votre Dashboard Musical Discord
                            </p>
                            <p class="text-white/60 text-center text-sm sm:text-base mt-2">
                                Connectez-vous pour contrôler la musique
                            </p>
                        </div>
                        
                        <!-- Bouton Discord -->
                        <button
                            onclick="loginWithDiscord()"
                            class="w-full group relative overflow-hidden text-white font-bold py-5 sm:py-6 px-6 sm:px-8 rounded-2xl text-base sm:text-lg transition-all duration-300 hover:scale-105 hover:shadow-2xl active:scale-95 flex items-center justify-center gap-3 sm:gap-4"
                            style="background: linear-gradient(135deg, #5865F2, #7289DA); box-shadow: 0 15px 40px rgba(88, 101, 242, 0.5);"
                        >
                            <!-- Effet de brillance au survol -->
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-200%] group-hover:translate-x-[200%] transition-transform duration-700"></div>
                            
                            <i class="fab fa-discord text-2xl sm:text-3xl relative z-10"></i>
                            <span class="relative z-10 text-base sm:text-lg">Se connecter avec Discord</span>
                        </button>
                        
                        <!-- Info sécurité -->
                        <div class="mt-8 sm:mt-10 pt-6 sm:pt-8 border-t border-white/20">
                            <div class="flex flex-col sm:flex-row items-center justify-center gap-2 sm:gap-6 text-white/60 text-xs sm:text-sm">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-shield-alt text-green-400"></i>
                                    <span>Connexion sécurisée</span>
                                </div>
                                <div class="hidden sm:block w-1 h-1 bg-white/40 rounded-full"></div>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-lock text-blue-400"></i>
                                    <span>OAuth2 Discord</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Guild Selection -->
        <div id="guildSelection" class="max-w-6xl mx-auto px-4 sm:px-6 py-8 sm:py-12 hidden">
            <div class="text-center mb-8 sm:mb-12">
                <div class="inline-flex items-center justify-center w-16 h-16 sm:w-20 sm:h-20 rounded-2xl mb-4 sm:mb-6" style="background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary)); box-shadow: 0 8px 32px color-mix(in srgb, var(--theme-primary) 40%, transparent);">
                    <i class="fab fa-discord text-white text-3xl sm:text-4xl"></i>
                </div>
                <h2 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-white mb-3 sm:mb-4">
                    Sélectionnez votre serveur
                </h2>
                <p class="text-white/60 text-sm sm:text-base lg:text-lg max-w-2xl mx-auto px-4">
                    Choisissez le serveur Discord sur lequel vous souhaitez contrôler la musique
                </p>
            </div>
            <div
                id="guildList"
                class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6"
            >
                <!-- Guild cards will be populated here -->
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboard" class="max-w-7xl mx-auto px-3 sm:px-4 py-6 sm:py-12 hidden">
            <!-- Tabs Navigation -->
            <div class="mb-6 sm:mb-8">
                <div class="gradient-border">
                    <div class="gradient-border-content p-1.5 sm:p-2">
                        <div class="grid grid-cols-4 gap-1.5 sm:gap-2">
                            <button onclick="switchDashboardTab('home')" id="dashTab-home" class="dashboard-tab active flex flex-col sm:flex-row items-center gap-1 sm:gap-2 px-2 sm:px-4 py-2 sm:py-3 rounded-lg font-semibold text-xs sm:text-sm transition-all duration-300">
                                <i class="fas fa-home text-base sm:text-lg"></i>
                                <span class="text-xs sm:text-sm">Accueil</span>
                            </button>
                            <button onclick="switchDashboardTab('queue')" id="dashTab-queue" class="dashboard-tab flex flex-col sm:flex-row items-center gap-1 sm:gap-2 px-2 sm:px-4 py-2 sm:py-3 rounded-lg font-semibold text-xs sm:text-sm transition-all duration-300">
                                <i class="fas fa-list text-base sm:text-lg"></i>
                                <span class="text-xs sm:text-sm">Queue</span>
                            </button>
                            <button onclick="switchDashboardTab('history')" id="dashTab-history" class="dashboard-tab flex flex-col sm:flex-row items-center gap-1 sm:gap-2 px-2 sm:px-4 py-2 sm:py-3 rounded-lg font-semibold text-xs sm:text-sm transition-all duration-300">
                                <i class="fas fa-history text-base sm:text-lg"></i>
                                <span class="text-xs sm:text-sm">Historique</span>
                            </button>
                            <button onclick="switchDashboardTab('statistics')" id="dashTab-statistics" class="dashboard-tab flex flex-col sm:flex-row items-center gap-1 sm:gap-2 px-2 sm:px-4 py-2 sm:py-3 rounded-lg font-semibold text-xs sm:text-sm transition-all duration-300">
                                <i class="fas fa-chart-bar text-base sm:text-lg"></i>
                                <span class="text-xs sm:text-sm">Stats</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Home -->
            <div id="tabContent-home" class="tab-content">
            <!-- Current Track Section - Full Width -->
            <div class="mb-8">
                <div class="gradient-border card-hover">
                    <div class="gradient-border-content p-8">
                        <h2 class="text-2xl font-bold mb-6 flex items-center">
                            <i
                                class="fas fa-play-circle text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-red-600 mr-3 text-2xl"
                            ></i>
                            <span
                                class="text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-red-600"
                                >Lecture en cours</span
                            >
                        </h2>
                        <div id="currentTrack" class="space-y-6">
                            <div class="text-center py-16 text-white/40">
                                <i
                                    class="fas fa-music text-6xl mb-6 floating-animation"
                                ></i>
                                <p class="text-xl">Aucune musique en cours</p>
                                <p class="text-sm mt-2">
                                    Lancez une musique pour voir les détails ici
                                </p>
                            </div>
                        </div>

                        <!-- Progress Bar Section -->
                        <div id="progressSection" class="mt-6 hidden">
                            <div class="progress-container">
                                <div
                                    id="musicProgressBar"
                                    class="progress-bar"
                                    style="width: 0%"
                                ></div>
                            </div>
                            <div class="flex justify-center mt-3">
                                <div
                                    class="flex items-center space-x-2 text-xs text-white/50"
                                >
                                    <i
                                        class="fas fa-volume-up"
                                        style="color: var(--theme-light);"
                                    ></i>
                                    <span>Progression en temps réel</span>
                                    <div
                                        class="w-2 h-2 rounded-full pulse-animation"
                                        style="background-color: var(--theme-primary);"
                                    ></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls and Queue Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Recherche & Contrôles -->
                <div class="space-y-8">
                    <!-- Recherche de Musique -->
                    <div class="gradient-border card-hover">
                        <div class="gradient-border-content p-6">
                            <h3
                                class="text-xl font-semibold mb-6 text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-red-600"
                            >
                                <i class="fas fa-search mr-2"></i>Recherche
                                Musique
                            </h3>
                            <button
                                onclick="openSearchPopup()"
                                class="w-full btn-primary btn-music-shine btn-pulse-attract ripple text-white font-semibold py-4 px-6 rounded-xl text-lg transition-all duration-300"
                            >
                                <i class="fas fa-search mr-3"></i>Ajouter de la
                                musique
                            </button>
                            <div class="mt-4 text-center">
                                <div
                                    class="flex justify-center space-x-4 text-xs text-white/60"
                                >
                                    <div class="flex items-center space-x-1">
                                        <i
                                            class="fab fa-youtube text-red-400"
                                        ></i>
                                        <span>YouTube</span>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <i
                                            class="fab fa-spotify text-green-400"
                                        ></i>
                                        <span>Spotify</span>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <i
                                            class="fas fa-link text-blue-400"
                                        ></i>
                                        <span>Liens directs</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contrôles du Lecteur -->
                    <div class="gradient-border card-hover">
                        <div class="gradient-border-content p-6">
                            <h3
                                class="text-xl font-semibold mb-6 text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-red-600"
                            >
                                <i class="fas fa-sliders-h mr-2"></i>Contrôles
                            </h3>
                            <div class="grid grid-cols-1 gap-4">
                                <!-- Combined Play/Pause Button -->
                                <button
                                    id="playPauseBtn"
                                    onclick="togglePlayPause()"
                                    class="btn-primary ripple text-white p-4 rounded-xl transition-all duration-300 font-medium text-lg"
                                >
                                    <i
                                        id="playPauseIcon"
                                        class="fas fa-play mr-2"
                                    ></i>
                                    <span id="playPauseText">Reprendre</span>
                                </button>

                                <div class="grid grid-cols-2 gap-3">
                                    <button
                                        onclick="control('skip')"
                                        class="ripple bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white p-3 rounded-xl transition-all duration-300 font-medium hover:scale-105 hover:shadow-lg"
                                    >
                                        <i class="fas fa-forward mr-2"></i
                                        >Suivant
                                    </button>
                                    <button
                                        onclick="control('stop')"
                                        class="ripple bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white p-3 rounded-xl transition-all duration-300 font-medium hover:scale-105 hover:shadow-lg"
                                    >
                                        <i class="fas fa-stop mr-2"></i>Arrêter
                                    </button>
                                </div>
                                
                                <!-- Loop Button -->
                                <button
                                    id="loopBtn"
                                    onclick="toggleLoop()"
                                    class="ripple bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white p-3 rounded-xl transition-all duration-300 font-medium hover:scale-105 hover:shadow-lg"
                                >
                                    <i class="fas fa-repeat mr-2"></i
                                    >Rejouer à l'infini
                                </button>
                            </div>

                            <!-- Volume Control Ultra Pro -->
                            <div class="mt-6 volume-control-container">
                                <!-- Contrôles horizontaux avec cercle au centre -->
                                <div class="volume-controls-row">
                                    <button
                                        onclick="adjustVolume(-10)"
                                        class="volume-btn"
                                        title="Baisser le volume"
                                    >
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    
                                    <!-- Indicateur circulaire -->
                                    <div id="volumeCircular" class="volume-circular">
                                        <div class="volume-circle-bg"></div>
                                        <div id="volumeCircleProgress" class="volume-circle-progress" style="--volume-progress: 100%"></div>
                                        <div class="volume-circle-inner">
                                            <i id="volumeIconDisplay" class="fas fa-volume-up volume-icon-display"></i>
                                            <div id="volumePercentage" class="volume-percentage">100%</div>
                                        </div>
                                        <div class="volume-rotation-indicator"></div>
                                    </div>
                                    
                                    <button
                                        onclick="adjustVolume(10)"
                                        class="volume-btn"
                                        title="Monter le volume"
                                    >
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                
                                <!-- Slider caché pour la compatibilité -->
                                <input
                                    type="range"
                                    id="volumeSlider"
                                    min="0"
                                    max="100"
                                    value="100"
                                    style="display: none;"
                                />
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            </div>
            
            <!-- Tab Content: Queue -->
            <div id="tabContent-queue" class="tab-content hidden">
                <div class="gradient-border card-hover">
                    <div class="gradient-border-content p-6">
                        <h2 class="text-xl font-bold mb-6 flex items-center justify-between">
                            <span class="text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-red-600">
                                <i class="fas fa-list mr-2 text-lg"></i>File d'attente
                            </span>
                            <div class="flex items-center space-x-3">
                                <span id="queueCount" class="text-xs text-white/60 bg-white/5 px-2 py-1 rounded-full">
                                    0 musiques
                                </span>
                                <button onclick="clearQueue()" class="text-red-400 hover:text-red-300 transition-colors text-sm" title="Vider la file">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </h2>
                        <div id="queue" class="space-y-3 overflow-y-auto scrollbar-thin pr-2" style="max-height: 600px">
                            <div class="text-center py-12 text-white/40">
                                <i class="fas fa-list-ul text-4xl mb-4 floating-animation"></i>
                                <p class="text-lg mb-1">File d'attente vide</p>
                                <p class="text-sm">Ajoutez des musiques</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: History -->
            <div id="tabContent-history" class="tab-content hidden">
                <div class="gradient-border card-hover">
                    <div class="gradient-border-content p-6">
                        <h2 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6">
                            <span class="text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-red-600">
                                <i class="fas fa-history mr-2"></i>Historique Groupé
                            </span>
                        </h2>
                        <!-- Barre de recherche - Responsive -->
                        <div class="mb-4 sm:mb-6">
                            <input type="text" id="historySearchInput" placeholder="Rechercher une musique..." class="history-search-input w-full px-3 sm:px-4 py-2.5 sm:py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/40 focus:outline-none focus:border-white/40 focus:bg-white/15 transition-all text-sm sm:text-base" oninput="filterHistory(this.value)">
                        </div>
                        <div id="dashboardHistoryList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto scrollbar-thin" style="max-height: 600px">
                            <div class="col-span-full text-center py-12 text-white/40">
                                <i class="fas fa-history text-6xl mb-4 floating-animation"></i>
                                <p class="text-xl">Chargement de l'historique...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Settings -->
            <div id="tabContent-settings" class="tab-content hidden">
                <div class="gradient-border card-hover">
                    <div class="gradient-border-content p-6">
                        <h2 class="text-2xl font-bold mb-6 flex items-center">
                            <span class="text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-red-600">
                                <i class="fas fa-cog mr-2"></i>Réglages
                            </span>
                        </h2>
                        <div class="space-y-6 max-w-3xl">
                            <!-- Volume par défaut -->
                            <div class="glass-effect rounded-xl p-6">
                                <label class="block text-white font-semibold mb-3 flex items-center gap-2">
                                    <i class="fas fa-volume-up theme-text"></i>
                                    Volume par défaut
                                </label>
                                <div class="flex items-center gap-4">
                                    <input type="range" id="defaultVolumeSlider" min="0" max="150" value="100" class="flex-1 h-2 bg-white/20 rounded-lg appearance-none cursor-pointer" oninput="updateVolumeDisplay(this.value)">
                                    <span id="defaultVolumeDisplay" class="text-white font-bold min-w-[4rem] text-right">100%</span>
                                </div>
                            </div>

                            <!-- Plateforme préférée -->
                            <div class="glass-effect rounded-xl p-6">
                                <label class="block text-white font-semibold mb-3 flex items-center gap-2">
                                    <i class="fas fa-music theme-text"></i>
                                    Plateforme de recherche préférée
                                </label>
                                <div class="grid grid-cols-3 gap-3">
                                    <button onclick="selectPreferredPlatform('youtube')" id="pref-youtube" class="platform-pref-btn active flex flex-col items-center gap-2 p-4 rounded-lg transition-all">
                                        <i class="fab fa-youtube text-2xl"></i>
                                        <span class="text-sm font-medium">YouTube</span>
                                    </button>
                                    <button onclick="selectPreferredPlatform('spotify')" id="pref-spotify" class="platform-pref-btn flex flex-col items-center gap-2 p-4 rounded-lg transition-all">
                                        <i class="fab fa-spotify text-2xl"></i>
                                        <span class="text-sm font-medium">Spotify</span>
                                    </button>
                                    <button onclick="selectPreferredPlatform('soundcloud')" id="pref-soundcloud" class="platform-pref-btn flex flex-col items-center gap-2 p-4 rounded-lg transition-all">
                                        <i class="fab fa-soundcloud text-2xl"></i>
                                        <span class="text-sm font-medium">SoundCloud</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Thème -->
                            <div class="glass-effect rounded-xl p-6">
                                <label class="block text-white font-semibold mb-3 flex items-center gap-2">
                                    <i class="fas fa-palette theme-text"></i>
                                    Thème
                                </label>
                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="switchTheme('red')" id="theme-red" class="theme-btn active flex items-center justify-center gap-3 p-4 rounded-lg transition-all">
                                        <div class="w-6 h-6 rounded-full" style="background: linear-gradient(45deg, #dc2626, #991b1b);"></div>
                                        <span class="font-medium">Rouge</span>
                                    </button>
                                    <button onclick="switchTheme('blue')" id="theme-blue" class="theme-btn flex items-center justify-center gap-3 p-4 rounded-lg transition-all">
                                        <div class="w-6 h-6 rounded-full" style="background: linear-gradient(45deg, #2563eb, #1e40af);"></div>
                                        <span class="font-medium">Bleu</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Langue -->
                            <div class="glass-effect rounded-xl p-6">
                                <label class="block text-white font-semibold mb-3 flex items-center gap-2">
                                    <i class="fas fa-language theme-text"></i>
                                    Langue
                                </label>
                                <select id="languageSelect" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:border-white/40" onchange="changeLanguage(this.value)">
                                    <option value="fr">Français</option>
                                    <option value="en">English</option>
                                </select>
                            </div>

                            <!-- Autoplay -->
                            <div class="glass-effect rounded-xl p-6">
                                <div class="flex items-center justify-between">
                                    <label class="text-white font-semibold flex items-center gap-2">
                                        <i class="fas fa-play-circle theme-text"></i>
                                        Autoplay
                                    </label>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="autoplayToggle" class="sr-only peer" onchange="toggleAutoplay(this.checked)">
                                        <div class="w-14 h-7 bg-white/20 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-gradient-to-r peer-checked:from-red-500 peer-checked:to-red-600"></div>
                                    </label>
                                </div>
                            </div>

                            <!-- Notifications -->
                            <div class="glass-effect rounded-xl p-6">
                                <div class="flex items-center justify-between">
                                    <label class="text-white font-semibold flex items-center gap-2">
                                        <i class="fas fa-bell theme-text"></i>
                                        Notifications
                                    </label>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="notificationsToggle" class="sr-only peer" checked onchange="toggleNotifications(this.checked)">
                                        <div class="w-14 h-7 bg-white/20 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-gradient-to-r peer-checked:from-red-500 peer-checked:to-red-600"></div>
                                    </label>
                                </div>
                            </div>

                            <!-- Save button -->
                            <button onclick="saveSettings()" class="w-full btn-primary text-white font-bold py-4 px-6 rounded-xl text-lg transition-all duration-300 hover:scale-105">
                                <i class="fas fa-save mr-2"></i>Sauvegarder les réglages
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Playlists -->
            <div id="tabContent-playlists" class="tab-content hidden">
                <div class="gradient-border card-hover">
                    <div class="gradient-border-content p-6">
                        <h2 class="text-2xl font-bold mb-6 flex items-center justify-between">
                            <span class="text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-red-600">
                                <i class="fas fa-list-music mr-2"></i>Mes Playlists
                            </span>
                            <button onclick="openCreatePlaylistModal()" class="btn-primary px-4 py-2 rounded-lg text-white">
                                <i class="fas fa-plus mr-2"></i>Créer une playlist
                            </button>
                        </h2>
                        <div id="playlistsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 overflow-y-auto scrollbar-thin" style="max-height: 600px">
                            <div class="col-span-full text-center py-12 text-white/40">
                                <i class="fas fa-list-music text-6xl mb-4 floating-animation"></i>
                                <p class="text-xl">Aucune playlist</p>
                                <p class="text-sm mt-2">Créez votre première playlist</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Statistics -->
            <div id="tabContent-statistics" class="tab-content hidden">
                <div class="space-y-4 sm:space-y-6">
                    <!-- Stats Summary - Mobile optimisé -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 md:gap-6">
                        <div class="gradient-border card-hover">
                            <div class="gradient-border-content p-4 sm:p-6 text-center">
                                <i class="fas fa-music text-3xl sm:text-4xl mb-2 sm:mb-3 theme-text"></i>
                                <div class="text-2xl sm:text-3xl font-bold text-white mb-1" id="totalTracksPlayed">0</div>
                                <div class="text-xs sm:text-sm text-white/60">Morceaux écoutés</div>
                            </div>
                        </div>
                        <div class="gradient-border card-hover">
                            <div class="gradient-border-content p-4 sm:p-6 text-center">
                                <i class="fas fa-clock text-3xl sm:text-4xl mb-2 sm:mb-3 theme-text"></i>
                                <div class="text-2xl sm:text-3xl font-bold text-white mb-1" id="totalPlaytime">0h</div>
                                <div class="text-xs sm:text-sm text-white/60">Temps d'écoute</div>
                            </div>
                        </div>
                    </div>

                    <!-- Top 10 Morceaux du serveur - Pleine largeur -->
                    <div class="gradient-border card-hover">
                        <div class="gradient-border-content p-4 sm:p-6">
                            <h3 class="text-lg sm:text-xl font-bold mb-3 sm:mb-4 text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-red-600">
                                <i class="fas fa-trophy mr-2"></i>Top 10 Morceaux du serveur
                            </h3>
                            <div id="topTracksList" class="space-y-2 sm:space-y-3 overflow-y-auto scrollbar-thin" style="max-height: 500px">
                                <div class="text-center py-8 text-white/40">
                                    <p class="text-sm sm:text-base">Chargement...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Popup de Recherche - Plein écran optimisé mobile -->
        <div id="searchPopup" class="fixed inset-0 hidden search-overlay" style="z-index: 9999; animation: overlayFadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);">
            <!-- Fond sombre simple sans flou -->
            <div class="absolute inset-0 search-overlay-backdrop" style="background: linear-gradient(135deg, rgba(0,0,0,0.85), rgba(20,0,0,0.90), rgba(0,0,0,0.85));"></div>
            
            <!-- Logo en fond -->
            <div class="absolute inset-0 flex items-center justify-center opacity-5 pointer-events-none" style="overflow: hidden;">
                <img src="/zg-logo-silver.png" alt="" class="w-1/2 h-1/2 object-contain" style="animation: logoFloat 6s ease-in-out infinite;">
            </div>
            
            <!-- Icônes de musique animées en fond -->
            <div class="absolute inset-0 pointer-events-none overflow-hidden" id="musicIconsContainer"></div>
            
            <!-- Contenu plein écran -->
            <div class="relative h-full w-full flex flex-col overflow-hidden">
                <div class="w-full h-full relative" style="animation: popupScaleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);">
                    <!-- Container Principal - Plein écran -->
                    <div id="searchPopupContent" class="relative bg-gradient-to-br from-black/60 via-black/40 to-black/60 overflow-hidden h-full w-full" style="display: flex; flex-direction: column; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);">
                    
                    <!-- Close Button - Visible et simple -->
                    <button id="popupCloseBtn" onclick="closeSearchPopup()" class="absolute w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-white/10 flex items-center justify-center hover:scale-105 active:scale-95 group close-btn-theme" style="top: 16px; right: 16px; z-index: 10000; touch-action: manipulation; transition: all 0.3s ease;">
                        <i class="fas fa-times text-white/80 group-hover:text-white text-xl sm:text-2xl transition-all duration-300 group-hover:rotate-90" style="pointer-events: none;"></i>
                    </button>
                    
                    <!-- Content - Optimisé mobile plein écran -->
                    <div class="relative px-4 py-6 sm:px-8 sm:py-8 flex flex-col h-full overflow-hidden">
                        <!-- Zone header fixe -->
                        <div id="popupHeaderSection" class="flex-shrink-0 relative">
                            <!-- Notes de musique animées en fond -->
                            <div class="absolute pointer-events-none overflow-visible" id="popupMusicNotesContainer" style="z-index: 10; top: 0; left: 0; right: 0; height: 100%;"></div>
                            
                            <!-- Title avec effet néon et logo -->
                            <div class="relative mb-6 sm:mb-8 flex flex-col items-center justify-center" style="z-index: 20;">
                                <div class="flex flex-col items-center justify-center gap-3 sm:gap-4">
                                    <!-- Logo avec effet néon adouci -->
                                    <img src="/zg-logo-silver.png" alt="ZG Music" class="w-14 h-14 sm:w-20 sm:h-20 object-contain logo-popup-theme" style="
                                        filter: drop-shadow(0 0 5px color-mix(in srgb, var(--theme-primary) 40%, transparent))
                                                drop-shadow(0 0 10px color-mix(in srgb, var(--theme-primary) 30%, transparent))
                                                drop-shadow(0 0 15px color-mix(in srgb, var(--theme-secondary) 20%, transparent));
                                    ">
                                    
                                    <!-- Texte avec effet néon -->
                                    <h2 class="text-center text-2xl sm:text-4xl font-black tracking-tight">
                                        <span class="neon-text" style="
                                            color: white;
                                            text-shadow: 
                                                0 0 10px var(--theme-primary),
                                                0 0 20px var(--theme-primary),
                                                0 0 30px var(--theme-primary),
                                                0 0 40px var(--theme-secondary),
                                                0 0 70px var(--theme-secondary),
                                                0 0 80px var(--theme-secondary),
                                                0 0 100px var(--theme-secondary);
                                            animation: neonFlicker 3s ease-in-out infinite;
                                        ">Recherche Musique</span>
                                    </h2>
                                </div>
                            </div>
                            
                            <!-- Sélecteur de Plateforme - Élégant et compact -->
                            <div class="mb-4 sm:mb-5 flex-shrink-0">
                            <div class="flex justify-center gap-2 sm:gap-3">
                                <button onclick="selectSearchPlatform('ytsearch')" id="platform-youtube" class="search-platform-btn active flex items-center gap-1.5 px-3 sm:px-4 py-2 rounded-lg font-medium text-sm transition-all duration-300 backdrop-blur-sm" style="background: linear-gradient(135deg, color-mix(in srgb, #FF0000 25%, transparent), color-mix(in srgb, #FF0000 10%, transparent)); border: 1.5px solid rgba(255,0,0,0.4);">
                                    <i class="fab fa-youtube text-base"></i>
                                    <span class="text-xs sm:text-sm">YouTube</span>
                                </button>
                                <button onclick="selectSearchPlatform('spsearch')" id="platform-spotify" class="search-platform-btn flex items-center gap-1.5 px-3 sm:px-4 py-2 rounded-lg font-medium text-sm transition-all duration-300 backdrop-blur-sm" style="background: color-mix(in srgb, #1DB954 10%, transparent); border: 1.5px solid rgba(29,185,84,0.3);">
                                    <i class="fab fa-spotify text-base"></i>
                                    <span class="text-xs sm:text-sm">Spotify</span>
                                </button>
                                <button onclick="selectSearchPlatform('scsearch')" id="platform-soundcloud" class="search-platform-btn flex items-center gap-1.5 px-3 sm:px-4 py-2 rounded-lg font-medium text-sm transition-all duration-300 backdrop-blur-sm" style="background: color-mix(in srgb, #FF7700 10%, transparent); border: 1.5px solid rgba(255,119,0,0.3);">
                                    <i class="fab fa-soundcloud text-base"></i>
                                    <span class="text-xs sm:text-sm">SoundCloud</span>
                                </button>
                            </div>
                        </div>
                        
                            <!-- Search Input - Élégant et centré -->
                            <div class="relative mb-4 flex-shrink-0 max-w-2xl mx-auto">
                                <div class="relative flex gap-2">
                                <div class="flex-1 relative group">
                                    <input
                                        type="text"
                                        id="popupSearchInput"
                                        placeholder=""
                                        class="w-full h-12 sm:h-14 px-4 sm:px-5 pr-10 sm:pr-12 font-medium bg-white/10 border border-white/20 rounded-xl focus:outline-none transition-all text-white placeholder-white/50 focus:border-white/40 focus:bg-white/15 search-input-theme"
                                        style="font-size: 16px;"
                                        onfocus="searchInputFocus()"
                                        onblur="searchInputBlur()"
                                        oninput="searchInputChange(this); toggleClearBtn()"
                                        onkeypress="if(event.key==='Enter') searchMusicPopup()"
                                    />
                                    <button 
                                        id="clearSearchBtn"
                                        onclick="clearSearchInput()"
                                        class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 sm:w-9 sm:h-9 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-all opacity-0 pointer-events-none"
                                        style="z-index: 10;"
                                    >
                                        <i class="fas fa-times text-white/80 text-sm"></i>
                                    </button>
                                    <div class="absolute inset-0 rounded-xl pointer-events-none opacity-0 group-focus-within:opacity-100 transition-opacity duration-300" style="background: linear-gradient(135deg, color-mix(in srgb, var(--theme-primary) 8%, transparent), transparent); box-shadow: inset 0 1px 1px rgba(255,255,255,0.15);"></div>
                                </div>
                                <button
                                    onclick="searchMusicPopup()"
                                    class="px-5 sm:px-6 h-12 sm:h-14 rounded-xl font-semibold text-white transition-all duration-300 hover:scale-105 active:scale-95 relative overflow-hidden group search-btn-theme"
                                    style="background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary)); box-shadow: 0 6px 16px color-mix(in srgb, var(--theme-primary) 40%, transparent);"
                                >
                                    <div class="absolute inset-0 bg-white/0 group-hover:bg-white/15 transition-colors duration-300"></div>
                                    <i class="fas fa-search relative text-sm sm:text-base"></i>
                                </button>
                                </div>
                            </div>
                        </div>
                        <!-- Fin zone réductible -->
                        
                        <!-- Loading -->
                        <div id="popupLoading" class="hidden py-12 sm:py-16 text-center">
                            <div class="inline-flex flex-col items-center gap-3">
                                <div class="w-8 h-8 sm:w-10 sm:h-10 border-3 border-transparent rounded-full animate-spin" style="border-top-color: var(--theme-primary); border-right-color: var(--theme-secondary);"></div>
                                <p class="text-white/70 font-medium text-sm sm:text-base">Recherche en cours...</p>
                            </div>
                        </div>
                        
                        <!-- Tabs Navigation -->
                        <div class="flex gap-2 mb-4 px-1" id="popupTabsNav">
                            <button onclick="switchPopupTab('history')" id="tab-history" class="popup-tab active flex-1 px-4 py-2 rounded-lg font-bold text-xs sm:text-sm transition-all duration-300 flex flex-col items-center gap-1" style="background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary)); color: white;">
                                <i class="fas fa-history text-base"></i>
                                <span>Historique</span>
                            </button>
                            <button onclick="switchPopupTab('trending')" id="tab-trending" class="popup-tab flex-1 px-4 py-2 rounded-lg font-bold text-xs sm:text-sm transition-all duration-300 flex flex-col items-center gap-1" style="background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.6);">
                                <i class="fas fa-fire text-base"></i>
                                <span>Tendance</span>
                            </button>
                            <button onclick="switchPopupTab('radio')" id="tab-radio" class="popup-tab flex-1 px-4 py-2 rounded-lg font-bold text-xs sm:text-sm transition-all duration-300 flex flex-col items-center gap-1" style="background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.6);">
                                <i class="fas fa-broadcast-tower text-base"></i>
                                <span>Radio</span>
                            </button>
                        </div>
                        
                        <!-- Historique -->
                        <div id="popupHistory" class="popup-tab-content relative flex-1 overflow-hidden">
                            <div class="flex flex-col gap-2 overflow-y-auto scrollbar-thin h-full pb-20 px-0.5" style="-webkit-overflow-scrolling: touch; touch-action: pan-y; overscroll-behavior: contain;" id="historyList"></div>
                        </div>
                        
                        <!-- Tendance (Top 20 France) -->
                        <div id="popupSuggestions" class="popup-tab-content hidden relative flex-1 overflow-hidden">
                            <div class="flex flex-col gap-2 overflow-y-auto scrollbar-thin h-full pb-20 px-0.5" style="-webkit-overflow-scrolling: touch; touch-action: pan-y; overscroll-behavior: contain;" id="suggestionsList"></div>
                        </div>
                        
                        <!-- Radio -->
                        <div id="popupRadio" class="popup-tab-content hidden relative flex-1 overflow-hidden">
                            <div class="flex flex-col gap-2 overflow-y-auto scrollbar-thin h-full pb-20 px-0.5" style="-webkit-overflow-scrolling: touch; touch-action: pan-y; overscroll-behavior: contain;" id="radioList"></div>
                        </div>
                        
                        <!-- Results - Zone scrollable optimisée mobile -->
                        <div class="relative flex-1 overflow-hidden hidden" id="popupResultsContainer">
                            <div id="popupSearchResults" class="space-y-2 overflow-y-auto scrollbar-thin h-full pb-4" style="-webkit-overflow-scrolling: touch; touch-action: pan-y; overscroll-behavior: contain;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal pour ajouter à une playlist -->
        <div id="addToPlaylistModal" class="fixed inset-0 hidden flex items-center justify-center" style="z-index: 10000; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);" onclick="closeAddToPlaylistModal(event)">
            <div class="gradient-border max-w-md w-full mx-4" onclick="event.stopPropagation()" style="animation: popupScaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);">
                <div class="gradient-border-content p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-red-600">
                            <i class="fas fa-plus-circle mr-2"></i>Ajouter à une playlist
                        </h3>
                        <button onclick="closeAddToPlaylistModal()" class="text-white/60 hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div id="playlistModalTrackInfo" class="glass-effect rounded-lg p-3 mb-4">
                        <!-- Track info will be inserted here -->
                    </div>
                    
                    <div id="playlistModalList" class="space-y-2 max-h-96 overflow-y-auto scrollbar-thin mb-4">
                        <div class="text-center py-8 text-white/40">
                            <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                            <p>Chargement des playlists...</p>
                        </div>
                    </div>
                    
                    <button onclick="closeAddToPlaylistModal()" class="w-full bg-white/10 hover:bg-white/20 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                        Annuler
                    </button>
                </div>
            </div>
        </div>
        
        <style>
            /* Animations pour le popup fullscreen */
            @keyframes overlayFadeIn {
                from { 
                    opacity: 0;
                }
                to { 
                    opacity: 1;
                }
            }
            
            @keyframes popupScaleIn {
                from { 
                    opacity: 0; 
                    transform: scale(0.9) translateY(30px);
                }
                to { 
                    opacity: 1; 
                    transform: scale(1) translateY(0);
                }
            }
            
            /* Animation néon pour le titre */
            @keyframes neonFlicker {
                0%, 100% {
                    text-shadow: 
                        0 0 10px var(--theme-primary),
                        0 0 20px var(--theme-primary),
                        0 0 30px var(--theme-primary),
                        0 0 40px var(--theme-secondary),
                        0 0 70px var(--theme-secondary),
                        0 0 80px var(--theme-secondary),
                        0 0 100px var(--theme-secondary);
                }
                50% {
                    text-shadow: 
                        0 0 5px var(--theme-primary),
                        0 0 10px var(--theme-primary),
                        0 0 15px var(--theme-primary),
                        0 0 20px var(--theme-secondary),
                        0 0 35px var(--theme-secondary),
                        0 0 40px var(--theme-secondary),
                        0 0 50px var(--theme-secondary);
                }
            }
            
            /* Animation du logo qui flotte */
            @keyframes logoFloat {
                0%, 100% {
                    transform: translateY(0) rotate(0deg);
                }
                25% {
                    transform: translateY(-20px) rotate(5deg);
                }
                50% {
                    transform: translateY(0) rotate(0deg);
                }
                75% {
                    transform: translateY(-10px) rotate(-5deg);
                }
            }
            
            /* Animation des icônes de musique */
            @keyframes musicIconFloat {
                0% {
                    transform: translateY(100vh) translateX(0) rotate(0deg);
                    opacity: 0;
                }
                10% {
                    opacity: 0.3;
                }
                90% {
                    opacity: 0.3;
                }
                100% {
                    transform: translateY(-100px) translateX(var(--drift)) rotate(360deg);
                    opacity: 0;
                }
            }
            
            /* Animation néon pour le logo */
            @keyframes logoNeonPulse {
                0%, 100% {
                    filter: drop-shadow(0 0 10px var(--theme-primary))
                            drop-shadow(0 0 20px var(--theme-primary))
                            drop-shadow(0 0 30px var(--theme-secondary))
                            drop-shadow(0 0 40px var(--theme-secondary));
                }
                50% {
                    filter: drop-shadow(0 0 5px var(--theme-primary))
                            drop-shadow(0 0 10px var(--theme-primary))
                            drop-shadow(0 0 15px var(--theme-secondary))
                            drop-shadow(0 0 20px var(--theme-secondary));
                }
            }
            
            /* Effet de backdrop simple */
            .search-overlay-backdrop {
                animation: overlayFadeIn 0.5s ease-out;
            }
            
            /* Boutons de sélection de plateforme */
            .search-platform-btn {
                color: white;
                opacity: 0.5;
                transform: scale(0.95);
                cursor: pointer;
                position: relative;
                overflow: hidden;
            }
            
            .search-platform-btn.active {
                opacity: 1;
                transform: scale(1);
                box-shadow: 0 8px 25px color-mix(in srgb, var(--theme-primary) 40%, transparent);
            }
            
            .search-platform-btn:hover {
                opacity: 0.8;
                transform: scale(1.05);
            }
            
            .search-platform-btn.active:hover {
                opacity: 1;
            }
            
            .search-platform-btn::before {
                content: '';
                position: absolute;
                inset: 0;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
                transform: translateX(-100%);
                transition: transform 0.6s;
            }
            
            .search-platform-btn:hover::before {
                transform: translateX(100%);
            }
            
            /* Plateformes - Version Mini */
            .platform-pill-mini {
                width: 36px;
                height: 36px;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
                color: white;
                transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
                cursor: pointer;
                position: relative;
            }
            
            @media (min-width: 640px) {
                .platform-pill-mini {
                    width: 40px;
                    height: 40px;
                    font-size: 18px;
                    border-radius: 12px;
                }
            }
            
            .platform-pill-mini::before {
                content: '';
                position: absolute;
                inset: -1px;
                border-radius: inherit;
                background: linear-gradient(135deg, rgba(255,255,255,0.3), transparent);
                opacity: 0;
                transition: opacity 0.3s;
            }
            
            .platform-pill-mini:hover {
                transform: translateY(-3px) scale(1.1);
            }
            
            .platform-pill-mini:hover::before {
                opacity: 1;
            }
            
            .youtube-pill {
                background: linear-gradient(135deg, #FF0000, #B30000);
                box-shadow: 0 6px 20px rgba(255, 0, 0, 0.3);
            }
            
            .youtube-pill:hover {
                box-shadow: 0 10px 30px rgba(255, 0, 0, 0.5);
            }
            
            .spotify-pill {
                background: linear-gradient(135deg, #1DB954, #158940);
                box-shadow: 0 6px 20px rgba(29, 185, 84, 0.3);
            }
            
            .spotify-pill:hover {
                box-shadow: 0 10px 30px rgba(29, 185, 84, 0.5);
            }
            
            .soundcloud-pill {
                background: linear-gradient(135deg, #FF8800, #CC6D00);
                box-shadow: 0 6px 20px rgba(255, 136, 0, 0.3);
            }
            
            .soundcloud-pill:hover {
                box-shadow: 0 10px 30px rgba(255, 136, 0, 0.5);
            }
            
            /* === NOUVEAUX STYLES POPUP COMPLEXE === */
            
            /* Bordure animée du popup */
            .popup-fancy-border {
                position: relative;
                border: 1px solid transparent;
            }
            
            .popup-fancy-border::before {
                content: '';
                position: absolute;
                inset: -2px;
                border-radius: inherit;
                padding: 2px;
                background: linear-gradient(45deg, 
                    var(--theme-primary),
                    var(--theme-light),
                    var(--theme-secondary),
                    var(--theme-primary)
                );
                background-size: 300% 300%;
                -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                -webkit-mask-composite: xor;
                mask-composite: exclude;
                animation: borderRotate 8s linear infinite;
                opacity: 0.3;
                pointer-events: none;
            }
            
            @keyframes borderRotate {
                0% { background-position: 0% 50%; }
                50% { background-position: 100% 50%; }
                100% { background-position: 0% 50%; }
            }
            
            .popup-border-animation {
                position: absolute;
                inset: 0;
                border-radius: inherit;
                pointer-events: none;
                overflow: hidden;
            }
            
            .popup-border-animation::before,
            .popup-border-animation::after {
                content: '';
                position: absolute;
                width: 200%;
                height: 2px;
                background: linear-gradient(90deg, transparent, var(--theme-primary), transparent);
                animation: borderScan 4s linear infinite;
            }
            
            .popup-border-animation::before {
                top: 0;
                left: -100%;
            }
            
            .popup-border-animation::after {
                bottom: 0;
                right: -100%;
                animation-delay: 2s;
            }
            
            @keyframes borderScan {
                0% { transform: translateX(0); }
                100% { transform: translateX(100%); }
            }
            
            /* Particules dans le popup */
            .popup-particles {
                position: absolute;
                inset: 0;
                pointer-events: none;
                overflow: hidden;
                opacity: 0.4;
            }
            
            .popup-particles::before,
            .popup-particles::after {
                content: '';
                position: absolute;
                width: 4px;
                height: 4px;
                border-radius: 50%;
                background: var(--theme-primary);
                box-shadow: 
                    20px 30px 0 var(--theme-light),
                    40px 70px 0 var(--theme-secondary),
                    70px 40px 0 var(--theme-primary),
                    90px 90px 0 var(--theme-light),
                    120px 50px 0 var(--theme-secondary),
                    150px 80px 0 var(--theme-primary),
                    180px 30px 0 var(--theme-light),
                    30px 100px 0 var(--theme-secondary),
                    80px 120px 0 var(--theme-primary),
                    130px 140px 0 var(--theme-light);
                animation: popupParticlesFloat 20s linear infinite;
            }
            
            .popup-particles::after {
                animation-delay: -10s;
                animation-duration: 25s;
            }
            
            @keyframes popupParticlesFloat {
                0% {
                    transform: translateY(0) translateX(0);
                    opacity: 0;
                }
                10% {
                    opacity: 0.6;
                }
                90% {
                    opacity: 0.6;
                }
                100% {
                    transform: translateY(-100%) translateX(50px);
                    opacity: 0;
                }
            }
            
            /* Fond de vagues animées */
            .popup-wave-bg {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 150px;
                opacity: 0.03;
                pointer-events: none;
                background: linear-gradient(0deg, var(--theme-primary) 0%, transparent 100%);
                overflow: hidden;
            }
            
            .popup-wave-bg::before,
            .popup-wave-bg::after {
                content: '';
                position: absolute;
                width: 200%;
                height: 200%;
                bottom: 0;
                left: 50%;
                background: radial-gradient(ellipse at center, transparent 40%, var(--theme-primary) 100%);
                opacity: 0.5;
                animation: waveMove 15s ease-in-out infinite;
            }
            
            .popup-wave-bg::after {
                animation-delay: -7.5s;
                opacity: 0.3;
            }
            
            @keyframes waveMove {
                0%, 100% {
                    transform: translateX(-50%) translateY(0) rotate(0deg);
                }
                50% {
                    transform: translateX(-50%) translateY(-20px) rotate(180deg);
                }
            }
            
            /* Pattern de grille */
            .popup-grid-pattern {
                position: absolute;
                inset: 0;
                pointer-events: none;
                opacity: 0.02;
                background-image: 
                    linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                    linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
                background-size: 20px 20px;
                animation: gridShift 20s linear infinite;
            }
            
            @keyframes gridShift {
                0% { transform: translate(0, 0); }
                100% { transform: translate(20px, 20px); }
            }
            
            /* Close button fancy */
            .popup-close-fancy {
                position: relative;
                overflow: hidden;
            }
            
            .popup-close-fancy::before {
                content: '';
                position: absolute;
                inset: -50%;
                background: conic-gradient(from 0deg, transparent, var(--theme-primary), transparent);
                animation: spinGlow 3s linear infinite;
                opacity: 0;
                transition: opacity 0.3s;
            }
            
            .popup-close-fancy:hover::before {
                opacity: 0.5;
            }
            
            @keyframes spinGlow {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            @keyframes closeButtonPulse {
                0%, 100% { opacity: 0; }
                50% { opacity: 0.3; }
            }
            
            /* Platform enhanced effects */
            .platform-enhanced {
                position: relative;
                overflow: visible;
            }
            
            .platform-glow {
                position: absolute;
                inset: -4px;
                border-radius: inherit;
                opacity: 0;
                transition: opacity 0.3s;
                filter: blur(8px);
                z-index: -1;
                animation: platformGlowPulse 2s ease-in-out infinite;
            }
            
            .youtube-pill .platform-glow {
                background: linear-gradient(135deg, #FF0000, #B30000);
            }
            
            .spotify-pill .platform-glow {
                background: linear-gradient(135deg, #1DB954, #158940);
            }
            
            .soundcloud-pill .platform-glow {
                background: linear-gradient(135deg, #FF8800, #CC6D00);
            }
            
            .platform-enhanced:hover .platform-glow {
                opacity: 0.6;
            }
            
            @keyframes platformGlowPulse {
                0%, 100% {
                    opacity: 0.2;
                    transform: scale(1);
                }
                50% {
                    opacity: 0.4;
                    transform: scale(1.1);
                }
            }
            
            /* Underline pulse */
            @keyframes underlinePulse {
                0%, 100% {
                    opacity: 0.3;
                    transform: scaleX(0.8);
                }
                50% {
                    opacity: 0.6;
                    transform: scaleX(1);
                }
            }
            
            /* Glow pulse générale */
            @keyframes popupGlowPulse {
                0%, 100% {
                    opacity: 0.1;
                }
                50% {
                    opacity: 0.25;
                }
            }
            
            /* Animations pour la page de login */
            @keyframes fadeOut {
                from {
                    opacity: 1;
                    transform: scale(1);
                }
                to {
                    opacity: 0;
                    transform: scale(0.95);
                }
            }
            
            @keyframes shake {
                0%, 100% {
                    transform: translateX(0);
                }
                25% {
                    transform: translateX(-10px);
                }
                75% {
                    transform: translateX(10px);
                }
            }
            
            .shake {
                animation: shake 0.5s ease-in-out;
            }
        </style>

        <script>
            // Custom Cursor fluide et réactif
            document.addEventListener("DOMContentLoaded", function () {
                // ZG cursor will be initialized separately in initZGCursor() function
            });

            let socket;
            let authToken = "demo_token_2024"; // Use the same token as in .env
            let currentGuild = "";
            let currentState = null;
            let searchResults = [];
            let isPlaying = false;
            let selectedSearchPlatform = "ytsearch"; // Default: YouTube

            // Progress tracking variables
            let currentPosition = 0;
            let currentDuration = 0;
            let lastUpdateTime = 0;
            let progressInterval = null;

            // Anti-spam system for tracks
            let recentlyAddedTracks = new Map(); // trackId -> timestamp
            const ANTI_SPAM_COOLDOWN = 10000; // 10 seconds cooldown per track
            
            // Track position system for popup bubbles
            // On utilise un Map avec le trackId de base et on garde trace de toutes les positions
            let trackQueuePositions = new Map(); // trackId -> Set of positions where this track appears
            
            // Generate track ID based on title and author
            function generateTrackId(title, author) {
                return `${title}_${author}`.toLowerCase().replace(/[^a-z0-9]/g, "");
            }

            // Authentication state
            let isAuthenticated = false;
            let currentUser = null;

            // Discord OAuth Authentication
            function loginWithDiscord() {
                console.log('🔐 Redirection vers Discord OAuth...');
                window.location.href = '/auth/discord';
            }

            // Check if user is already authenticated
            async function checkAuthStatus() {
                try {
                    const response = await fetch('/api/me', {
                        credentials: 'include'
                    });
                    const data = await response.json();
                    
                    if (data.authenticated && data.user) {
                        currentUser = data.user;
                        isAuthenticated = true;
                        hiddenLoginPage();
                        displayUserProfile(data.user);
                        console.log('✅ Utilisateur Discord authentifié:', data.user.username);
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('❌ Erreur lors de la vérification de l\'authentification:', error);
                    return false;
                }
            }

            // Display user profile in header
            function displayUserProfile(user) {
                const userProfile = document.getElementById('userProfile');
                const userAvatar = document.getElementById('userAvatar');
                const userName = document.getElementById('userName');
                
                if (user && userProfile && userAvatar && userName) {
                    const avatarUrl = user.avatar 
                        ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png?size=64`
                        : `https://cdn.discordapp.com/embed/avatars/${parseInt(user.discriminator) % 5}.png`;
                    
                    userAvatar.src = avatarUrl;
                    userName.textContent = user.username;
                    userProfile.classList.remove('hidden');
                    userProfile.classList.add('flex');
                }
            }

            // Logout function
            function logout() {
                if (confirm('Voulez-vous vraiment vous déconnecter ?')) {
                    window.location.href = '/auth/logout';
                }
            }

            // Toggle user dropdown menu
            function toggleUserMenu(event) {
                event.stopPropagation();
                const menu = document.getElementById('userDropdownMenu');
                if (menu) {
                    menu.classList.toggle('show');
                }
            }

            // Open settings tab
            function openSettingsTab() {
                const settingsTab = document.querySelector('[data-tab="settings"]');
                if (settingsTab) {
                    settingsTab.click();
                }
                // Close dropdown
                const menu = document.getElementById('userDropdownMenu');
                if (menu) {
                    menu.classList.remove('show');
                }
            }

            // Close dropdown when clicking outside (but not on color picker)
            document.addEventListener('click', function(event) {
                const menu = document.getElementById('userDropdownMenu');
                const userProfile = document.getElementById('userProfile');
                const colorPickerBtn = document.getElementById('colorPickerBtn');
                const colorPickerMenu = document.getElementById('colorPickerMenu');
                
                // Ne pas fermer si on clique sur le menu couleur ou son bouton
                const clickOnColorPicker = colorPickerBtn?.contains(event.target) || colorPickerMenu?.contains(event.target);
                
                if (menu && userProfile && !userProfile.contains(event.target) && !clickOnColorPicker) {
                    menu.classList.remove('show');
                }
            });

            // Hide login page
            function hiddenLoginPage() {
                const loginPage = document.getElementById('loginPage');
                const mainHeader = document.getElementById('mainHeader');
                
                if (loginPage && mainHeader) {
                    loginPage.style.animation = 'fadeOut 0.5s ease-out';
                    setTimeout(() => {
                        loginPage.style.display = 'none';
                        mainHeader.classList.remove('hidden');
                    }, 500);
                }
            }


            // Add CSS for search type buttons
            const style = document.createElement("style");
            style.textContent = `
                .search-type-btn {
                    background: rgba(255, 255, 255, 0.05);
                    color: rgba(255, 255, 255, 0.6);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                }
                .search-type-btn.active {
                    background: linear-gradient(45deg, #dc2626, #991b1b);
                    color: white;
                    border: 1px solid transparent;
                }
                .search-type-btn:hover {
                    background: rgba(255, 255, 255, 0.1);
                    color: rgba(255, 255, 255, 0.8);
                }
                .search-type-btn.active:hover {
                    background: linear-gradient(45deg, #b91c1c, #7f1d1d);
                    color: white;
                }
                .search-platform-btn {
                    background: rgba(255, 255, 255, 0.05);
                    color: rgba(255, 255, 255, 0.6);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                }
                .search-platform-btn.active {
                    background: linear-gradient(45deg, #dc2626, #991b1b);
                    color: white;
                    border: 1px solid transparent;
                }
                .search-platform-btn:hover {
                    background: rgba(255, 255, 255, 0.1);
                    color: rgba(255, 255, 255, 0.8);
                }
                .search-platform-btn.active:hover {
                    background: linear-gradient(45deg, #b91c1c, #7f1d1d);
                    color: white;
                }
            `;
            document.head.appendChild(style);

            // Helper function to get platform icons
            function getPlatformIcon(platform) {
                switch (platform.toLowerCase()) {
                    case "youtube":
                        return '<i class="fab fa-youtube text-red-400"></i>';
                    case "spotify":
                        return '<i class="fab fa-spotify text-green-400"></i>';
                    case "soundcloud":
                        return '<i class="fab fa-soundcloud text-orange-400"></i>';
                    default:
                        return '<i class="fas fa-music text-purple-400"></i>';
                }
            }

            // Gestion du popup de recherche
            let userIsTyping = false;
            let typingAnimationInterval = null;
            let currentTypingIndex = 0;
            const typingTexts = [
                "Rechercher une musique...",
                "Nom de l'artiste...",
                "Titre de la chanson...",
                "Lien YouTube, Spotify...",
            ];
            let currentTextIndex = 0;
            
            // Debounce pour la recherche automatique
            let searchDebounceTimer = null;
            const SEARCH_DEBOUNCE_DELAY = 800; // 800ms après avoir arrêté de taper
            
            // État du popup pour sauvegarder et restaurer correctement
            const popupState = {
                isSearchMode: false,      // true si en mode recherche, false si en mode onglets
                lastActiveTab: 'history', // 'history', 'trending', ou 'radio'
                searchQuery: ''           // Dernier texte recherché
            };

            function searchInputFocus() {
                const glow = document.getElementById('inputGlow');
                const input = document.getElementById('popupSearchInput');
                if (glow) glow.style.opacity = '0.25';
                if (input) {
                    input.style.borderColor = 'var(--theme-primary)';
                    input.style.backgroundColor = 'rgba(255,255,255,0.08)';
                }
                // L'animation continue même au focus si l'utilisateur n'a pas tapé
                if (!userIsTyping && !typingAnimationInterval) {
                    startTypingAnimation();
                }
            }

            function searchInputBlur() {
                const glow = document.getElementById('inputGlow');
                const input = document.getElementById('popupSearchInput');
                if (glow) glow.style.opacity = '0';
                if (input) {
                    input.style.borderColor = 'rgba(255,255,255,0.15)';
                    input.style.backgroundColor = 'rgba(255,255,255,0.05)';
                }
            }

            // Afficher/masquer le bouton effacer
            function toggleClearBtn() {
                const input = document.getElementById('popupSearchInput');
                const clearBtn = document.getElementById('clearSearchBtn');
                if (input && clearBtn) {
                    if (input.value.length > 0) {
                        clearBtn.style.opacity = '1';
                        clearBtn.style.pointerEvents = 'all';
                    } else {
                        clearBtn.style.opacity = '0';
                        clearBtn.style.pointerEvents = 'none';
                    }
                }
            }
            
            // Effacer le champ de recherche
            function clearSearchInput() {
                const input = document.getElementById('popupSearchInput');
                if (input) {
                    input.value = '';
                    input.focus();
                    searchInputChange(input);
                    toggleClearBtn();
                }
            }

            function searchInputChange(input) {
                const wasTyping = userIsTyping;
                userIsTyping = input.value.length > 0;
                
                // Sauvegarder l'état du popup
                popupState.isSearchMode = userIsTyping;
                popupState.searchQuery = input.value;
                
                // Gérer l'affichage des onglets vs résultats de recherche
                const tabsNav = document.getElementById('popupTabsNav');
                const resultsDiv = document.getElementById('popupResultsContainer');
                
                if (userIsTyping) {
                    // Mode recherche : cacher les onglets et leur contenu, montrer les résultats
                    if (tabsNav) tabsNav.classList.add('hidden');
                    document.querySelectorAll('.popup-tab-content').forEach(el => el.classList.add('hidden'));
                    if (resultsDiv) resultsDiv.classList.remove('hidden');
                    
                    // Annuler le timer de recherche précédent
                    if (searchDebounceTimer) {
                        clearTimeout(searchDebounceTimer);
                    }
                    
                    // Lancer une nouvelle recherche après le délai
                    searchDebounceTimer = setTimeout(() => {
                        const query = input.value.trim();
                        if (query.length >= 2) { // Minimum 2 caractères pour lancer la recherche
                            console.log('🔍 Recherche automatique:', query);
                            searchMusicPopup();
                        }
                    }, SEARCH_DEBOUNCE_DELAY);
                } else {
                    // Mode onglets : afficher les onglets, cacher les résultats de recherche
                    if (tabsNav) tabsNav.classList.remove('hidden');
                    if (resultsDiv) resultsDiv.classList.add('hidden');
                    
                    // Réafficher l'onglet actif
                    const activeTab = document.querySelector('.popup-tab.active');
                    if (activeTab) {
                        const tabName = activeTab.id.replace('tab-', '');
                        popupState.lastActiveTab = tabName; // Sauvegarder l'onglet actif
                        const contentMap = {
                            'history': 'popupHistory',
                            'trending': 'popupSuggestions',
                            'radio': 'popupRadio'
                        };
                        const contentId = contentMap[tabName];
                        if (contentId) {
                            document.getElementById(contentId)?.classList.remove('hidden');
                        }
                    }
                    
                    // Annuler le timer si l'utilisateur efface tout
                    if (searchDebounceTimer) {
                        clearTimeout(searchDebounceTimer);
                    }
                }
                
                // Si l'utilisateur commence à taper, arrêter l'animation
                if (userIsTyping && !wasTyping) {
                    stopTypingAnimation();
                }
                // Si l'utilisateur efface tout, redémarrer l'animation
                else if (!userIsTyping && wasTyping) {
                    startTypingAnimation();
                }
            }

            function startTypingAnimation() {
                const input = document.getElementById('popupSearchInput');
                if (!input || userIsTyping) return;
                
                stopTypingAnimation();
                
                let isDeleting = false;
                let currentText = typingTexts[currentTextIndex];
                currentTypingIndex = 0;
                
                typingAnimationInterval = setInterval(() => {
                    if (userIsTyping) {
                        stopTypingAnimation();
                        return;
                    }
                    
                    if (!isDeleting && currentTypingIndex < currentText.length) {
                        // Taper caractère par caractère
                        input.placeholder = currentText.substring(0, currentTypingIndex + 1);
                        currentTypingIndex++;
                    } else if (!isDeleting && currentTypingIndex === currentText.length) {
                        // Pause à la fin du texte
                        setTimeout(() => {
                            isDeleting = true;
                        }, 1500);
                    } else if (isDeleting && currentTypingIndex > 0) {
                        // Effacer caractère par caractère
                        currentTypingIndex--;
                        input.placeholder = currentText.substring(0, currentTypingIndex);
                    } else if (isDeleting && currentTypingIndex === 0) {
                        // Passer au texte suivant
                        isDeleting = false;
                        currentTextIndex = (currentTextIndex + 1) % typingTexts.length;
                        currentText = typingTexts[currentTextIndex];
                    }
                }, isDeleting ? 50 : 100);
            }

            function stopTypingAnimation() {
                if (typingAnimationInterval) {
                    clearInterval(typingAnimationInterval);
                    typingAnimationInterval = null;
                }
            }
            
            // Créer des icônes de musique animées en fond du popup
            function createMusicIcons() {
                const container = document.getElementById('musicIconsContainer');
                if (!container) return;
                
                // Nettoyer les anciennes icônes
                container.innerHTML = '';
                
                // Icônes de musique
                const musicIcons = ['fa-music', 'fa-headphones', 'fa-compact-disc', 'fa-guitar', 'fa-drum', 'fa-microphone'];
                
                // Créer 15 icônes aléatoires
                for (let i = 0; i < 15; i++) {
                    const icon = document.createElement('i');
                    const randomIcon = musicIcons[Math.floor(Math.random() * musicIcons.length)];
                    icon.className = `fas ${randomIcon}`;
                    
                    // Position horizontale aléatoire
                    const randomX = Math.random() * 100;
                    icon.style.position = 'absolute';
                    icon.style.left = randomX + '%';
                    icon.style.fontSize = (Math.random() * 20 + 20) + 'px';
                    icon.style.color = 'rgba(220, 38, 38, 0.3)';
                    
                    // Drift aléatoire pour l'animation
                    const drift = (Math.random() - 0.5) * 200;
                    icon.style.setProperty('--drift', drift + 'px');
                    
                    // Durée d'animation aléatoire
                    const duration = Math.random() * 10 + 15; // Entre 15 et 25 secondes
                    icon.style.animation = `musicIconFloat ${duration}s linear infinite`;
                    icon.style.animationDelay = (Math.random() * 5) + 's';
                    
                    container.appendChild(icon);
                }
            }

            // Créer les notes de musique animées dans le header du popup
            function createPopupHeaderNotes() {
                const container = document.getElementById('popupMusicNotesContainer');
                if (!container) return;
                
                // Vider le container
                container.innerHTML = '';
                
                // Types de notes
                const noteIcons = ['fa-music', 'fa-music', 'fa-music'];
                
                // Créer 5 notes de musique (subtil et stylé)
                for (let i = 0; i < 5; i++) {
                    const note = document.createElement('i');
                    const randomNote = noteIcons[Math.floor(Math.random() * noteIcons.length)];
                    note.className = `fas ${randomNote} popup-music-note`;
                    
                    // Position horizontale aléatoire
                    const randomX = Math.random() * 100;
                    note.style.left = randomX + '%';
                    note.style.top = '50%'; // Au milieu de la zone
                    
                    // Taille aléatoire
                    const size = Math.random() * 8 + 18; // Entre 18px et 26px
                    note.style.fontSize = size + 'px';
                    
                    // Couleur du thème avec opacité réduite pour effet subtil
                    note.style.color = `color-mix(in srgb, var(--theme-primary) ${Math.random() * 20 + 25}%, transparent)`;
                    
                    // Délai d'animation aléatoire
                    note.style.animationDelay = (Math.random() * 6) + 's';
                    
                    // Durée d'animation aléatoire
                    const duration = Math.random() * 4 + 6; // Entre 6 et 10 secondes
                    note.style.animationDuration = duration + 's';
                    
                    container.appendChild(note);
                }
            }

            function openSearchPopup() {
                document.getElementById("searchPopup").classList.remove("hidden");
                const input = document.getElementById("popupSearchInput");
                
                // Bloquer le scroll du body
                document.body.style.overflow = 'hidden';
                document.documentElement.style.overflow = 'hidden';
                
                // Réinitialiser la zone du haut
                const headerSection = document.getElementById('popupHeaderSection');
                if (headerSection) {
                    headerSection.style.maxHeight = '500px';
                    headerSection.style.opacity = '1';
                }
                
                // Créer les notes de musique dans le header
                createPopupHeaderNotes();
                
                // RESTAURER L'ÉTAT SAUVEGARDÉ au lieu de toujours charger l'historique
                const tabsNav = document.getElementById('popupTabsNav');
                const resultsDiv = document.getElementById('popupResultsContainer');
                
                if (popupState.isSearchMode) {
                    // Mode recherche : restaurer la recherche
                    if (input) {
                        input.value = popupState.searchQuery;
                        userIsTyping = true;
                    }
                    if (tabsNav) tabsNav.classList.add('hidden');
                    document.querySelectorAll('.popup-tab-content').forEach(el => el.classList.add('hidden'));
                    if (resultsDiv) resultsDiv.classList.remove('hidden');
                } else {
                    // Mode onglets : restaurer l'onglet actif
                    userIsTyping = false;
                    if (tabsNav) tabsNav.classList.remove('hidden');
                    if (resultsDiv) resultsDiv.classList.add('hidden');
                    
                    // Restaurer l'onglet actif
                    switchPopupTab(popupState.lastActiveTab);
                    
                    // Charger le contenu si nécessaire
                    const historyList = document.getElementById('historyList');
                    const suggestionsList = document.getElementById('suggestionsList');
                    const radioList = document.getElementById('radioList');
                    
                    if (popupState.lastActiveTab === 'history' && historyList && historyList.children.length === 0) {
                        loadHistory();
                    }
                    if (suggestionsList && suggestionsList.children.length === 0) {
                        loadPopularSuggestions();
                    }
                    if (radioList && radioList.children.length === 0) {
                        loadRadios();
                    }
                }
                
                setTimeout(() => {
                    if (input) {
                        input.focus();
                        toggleClearBtn(); // Afficher le bouton X si nécessaire
                        if (!userIsTyping) {
                            startTypingAnimation();
                        }
                    }
                }, 100);
                
                // Actualiser la liste toutes les 5 minutes
                if (window.trendingRefreshInterval) {
                    clearInterval(window.trendingRefreshInterval);
                }
                window.trendingRefreshInterval = setInterval(() => {
                    if (document.getElementById('popupSuggestions') && !document.getElementById('popupSuggestions').classList.contains('hidden')) {
                        loadPopularSuggestions();
                    }
                }, 5 * 60 * 1000);
                
                // Ajouter l'écouteur de scroll pour réduire la zone du haut
                setupPopupScrollCollapse();
            }
            
            // Charger les suggestions populaires depuis la playlist SoundCloud Top 100 France
            async function loadPopularSuggestions() {
                const suggestionsList = document.getElementById('suggestionsList');
                if (!suggestionsList) return;
                
                // Afficher un loader stylé pendant le chargement
                suggestionsList.innerHTML = `
                    <div class="col-span-full flex items-center justify-center py-8">
                        <div class="inline-flex flex-col items-center gap-4">
                            <div class="relative">
                                <div class="w-12 h-12 sm:w-14 sm:h-14 border-4 border-transparent rounded-full animate-spin" style="border-top-color: var(--theme-primary); border-right-color: var(--theme-secondary); animation: spin 1s linear infinite;"></div>
                                <i class="fas fa-fire absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xl" style="color: var(--theme-primary); animation: pulse 1.5s ease-in-out infinite;"></i>
                            </div>
                            <p class="text-white/80 font-bold text-sm sm:text-base" style="animation: pulse 1.5s ease-in-out infinite;">
                                Chargement Tendances...
                            </p>
                        </div>
                    </div>
                `;
                
                try {
                    // Récupérer la playlist SoundCloud
                    const response = await fetch('/api/youtube-trending', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Erreur lors de la récupération du Top 100 France');
                    }
                    
                    const data = await response.json();
                    
                    if (!data.tracks || data.tracks.length === 0) {
                        throw new Error('Aucune chanson trouvée dans la playlist');
                    }
                    
                    // Afficher les suggestions avec le système de checkmark
                    suggestionsList.innerHTML = data.tracks.map((track, index) => {
                        const songName = `${track.title} - ${track.author}`;
                        const thumbnail = track.thumbnail || "";
                        const trackId = generateTrackId(track.title || "unknown", track.author || "unknown");
                        const isInQueue = trackQueuePositions.has(trackId);
                        
                        const buttonHTML = isInQueue ? `
                            <button 
                                data-track-id="${trackId}"
                                class="queue-position-bubble flex-shrink-0 w-11 h-11 sm:w-auto sm:h-auto sm:px-5 sm:py-3 rounded-xl font-bold text-sm text-white flex items-center justify-center gap-2"
                                style="background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); cursor: default;"
                                disabled
                            >
                                <i class="fas fa-check"></i>
                                <span class="hidden sm:inline">Ajouté</span>
                            </button>
                        ` : `
                            <button 
                                data-track-id="${trackId}"
                                onclick="addTrendingTrack('${track.uri.replace(/'/g, "\\'")}', '${songName.replace(/'/g, "\\'")}', this); event.stopPropagation();"
                                class="add-track-btn flex-shrink-0 w-11 h-11 sm:w-auto sm:h-auto sm:px-5 sm:py-3 rounded-xl font-bold text-sm text-white transition-all duration-300 hover:scale-105 active:scale-95 flex items-center justify-center gap-2"
                                style="background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary)); box-shadow: 0 4px 15px rgba(var(--theme-particle), 0.3);"
                            >
                                <i class="fas fa-plus"></i>
                                <span class="hidden sm:inline">Ajouter</span>
                            </button>
                        `;
                        
                        return `
                        <div class="track-item" style="animation: trackAppear 0.4s ease ${index * 0.06}s both;">
                            <div class="group relative flex items-center gap-3 p-3 bg-white/5 border border-white/10 rounded-2xl transition-all duration-300 hover:bg-white/10 hover:border-white/25">
                                <!-- Thumbnail avec classement -->
                                <div class="relative w-16 h-16 flex-shrink-0 rounded-xl overflow-hidden">
                                    ${thumbnail 
                                        ? `<img src="${thumbnail}" alt="" class="w-full h-full object-cover">`
                                        : `<div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-orange-500/20 to-orange-900/20 text-white text-2xl"><i class="fab fa-soundcloud"></i></div>`
                                    }
                                    <div class="absolute top-1 left-1 backdrop-blur-sm font-black text-xs px-2 py-0.5 rounded-md" style="background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary)); color: white;">
                                        ${track.rank}
                                    </div>
                                </div>
                                
                                <!-- Info -->
                                <div class="flex-1 min-w-0">
                                    <div class="overflow-hidden mb-0.5">
                                        <h4 class="font-semibold text-white text-sm sm:text-base truncate" title="${(track.title || "Sans titre").replace(/"/g, "&quot;")}">
                                            ${(track.title || "Sans titre").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;")}
                                        </h4>
                                    </div>
                                    <p class="text-white/50 text-xs sm:text-sm truncate">
                                        ${(track.author || "Inconnu").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;")}
                                    </p>
                                </div>
                                
                                <!-- Bouton + ou Checkmark -->
                                ${buttonHTML}
                            </div>
                        </div>
                    `;
                    }).join('');
                    
                    console.log('✅ Top 100 France SoundCloud chargé avec succès');
                    
                } catch (error) {
                    console.error('Erreur lors du chargement des tendances:', error);
                    // Afficher un message d'erreur avec possibilité de réessayer
                    suggestionsList.innerHTML = `
                        <div class="col-span-full flex flex-col items-center justify-center py-8 text-center">
                            <i class="fas fa-exclamation-triangle text-orange-400 text-3xl sm:text-4xl mb-3"></i>
                            <p class="text-white/70 font-medium text-sm sm:text-base mb-2">Impossible de charger les tendances</p>
                            <p class="text-white/40 text-xs mb-3">${error.message}</p>
                            <button onclick="loadPopularSuggestions()" class="mt-3 px-4 py-2 rounded-lg text-white text-sm font-medium hover:scale-105 transition-transform" style="background: linear-gradient(135deg, #ff5500, #ff7700);">
                                <i class="fas fa-redo mr-2"></i>Réessayer
                            </button>
                        </div>
                    `;
                }
            }
            
            // Ajouter une chanson des tendances directement à la queue
            async function addTrendingTrack(trackUri, trackName, buttonElement) {
                try {
                    if (!currentGuild) {
                        showNotification('Veuillez sélectionner un serveur', 'error');
                        return;
                    }
                    
                    if (!buttonElement || buttonElement.disabled) {
                        return; // Prevent double clicks
                    }
                    
                    // Désactiver le bouton
                    buttonElement.disabled = true;
                    const originalHTML = buttonElement.innerHTML;
                    
                    // Créer un ID unique pour le track
                    const trackId = trackName.toLowerCase().replace(/[^a-z0-9]/g, "");
                    
                    // Spinner pendant le chargement
                    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span class="hidden sm:inline ml-2">Ajout...</span>';
                    buttonElement.style.transform = "scale(1.05)";
                    
                    // Ajouter directement à la queue via l'API
                    const response = await fetch(`/api/queue/${currentGuild}/add`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ 
                            uri: trackUri,
                            title: trackName
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('Track added successfully:', result);
                    
                    // Transformer en bouton checkmark persistant
                    const trackId2 = buttonElement.getAttribute('data-track-id');
                    
                    // Marquer dans la Map
                    if (!trackQueuePositions.has(trackId2)) {
                        trackQueuePositions.set(trackId2, new Set([1]));
                    }
                    
                    // Animation de transformation
                    buttonElement.style.animation = "buttonToBubble 0.6s ease-out forwards";
                    
                    setTimeout(() => {
                        // Transformer en checkmark vert
                        buttonElement.innerHTML = '<i class="fas fa-check"></i><span class="hidden sm:inline">Ajouté</span>';
                        buttonElement.className = 'queue-position-bubble flex-shrink-0 w-11 h-11 sm:w-auto sm:h-auto sm:px-5 sm:py-3 rounded-xl font-bold text-sm text-white flex items-center justify-center gap-2';
                        buttonElement.style.cssText = 'background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); cursor: default;';
                        buttonElement.disabled = true;
                        
                        console.log(`✅ Button transformed to checkmark for: ${trackName}`);
                    }, 600);
                    
                    // Afficher le message de succès
                    showNotification(`"${trackName}" ajouté à la playlist !`, 'success');
                    
                } catch (error) {
                    console.error('Error adding track to queue:', error);
                    showNotification(`Erreur lors de l'ajout: ${error.message}`, 'error');
                    
                    // Restaurer le bouton en cas d'erreur
                    if (buttonElement) {
                        buttonElement.innerHTML = '<i class="fas fa-times"></i><span class="hidden sm:inline ml-2">Erreur</span>';
                        buttonElement.style.boxShadow = "0 0 20px rgba(239, 68, 68, 0.6)";
                        
                        setTimeout(() => {
                            buttonElement.innerHTML = originalHTML;
                            buttonElement.disabled = false;
                            buttonElement.style.boxShadow = "";
                            buttonElement.style.transform = "";
                        }, 1500);
                    }
                }
            }
            
            // Ajouter une suggestion directement à la queue
            async function addSuggestionDirectly(songName, platform) {
                try {
                    // Afficher un message de chargement
                    showSuccess(`Ajout de "${songName}"...`);
                    
                    // Utiliser la plateforme appropriée pour la recherche
                    const searchPrefix = platform === 'spotify' ? 'spsearch:' : 'ytsearch:';
                    const query = searchPrefix + songName;
                    
                    // Ajouter directement à la queue via l'API
                    const response = await fetch(`/api/play/${currentGuild}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ query })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('Track added successfully:', result);
                    
                    // Afficher le message de succès sans fermer le popup
                    showSuccess(`"${songName}" ajouté à la playlist !`);
                } catch (error) {
                    console.error('Error adding track to queue:', error);
                    showError(`Erreur lors de l'ajout: ${error.message}`);
                }
            }
            
            function setupPopupScrollCollapse() {
                // Fonction simplifiée - pas besoin d'animation de scroll
                const resultsContainer = document.getElementById("popupSearchResults");
                if (!resultsContainer) return;
            }

            function closeSearchPopup() {
                document.getElementById("searchPopup").classList.add("hidden");
                // NE PLUS effacer les résultats - on les garde pour la prochaine ouverture
                // document.getElementById("popupSearchResults").innerHTML = "";
                // document.getElementById("popupSearchInput").value = "";
                document.getElementById("popupLoading").classList.add("hidden");
                
                // NE PAS réinitialiser userIsTyping - il sera calculé à la réouverture
                // userIsTyping = false;
                stopTypingAnimation();
                
                // Débloquer le scroll du body
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
            }

            // Fermer le popup en cliquant à l'extérieur - Désactivé pour éviter fermetures accidentelles
            function closeSearchPopupOnOutsideClick(event) {
                // Ne rien faire - on laisse l'utilisateur fermer uniquement via le bouton X
                // Cela évite que le popup se ferme accidentellement lors de l'ajout de musiques
                return;
            }
            
            // Fonction pour basculer entre les tabs du popup
            function switchPopupTab(tab) {
                // Sauvegarder l'onglet actif
                popupState.lastActiveTab = tab;
                popupState.isSearchMode = false;
                
                document.querySelectorAll('.popup-tab').forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.background = 'rgba(255,255,255,0.1)';
                    btn.style.color = 'rgba(255,255,255,0.6)';
                });
                
                document.querySelectorAll('.popup-tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                const activeBtn = document.getElementById(`tab-${tab}`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                    activeBtn.style.background = 'linear-gradient(135deg, var(--theme-primary), var(--theme-secondary))';
                    activeBtn.style.color = 'white';
                }
                
                if (tab === 'trending') {
                    document.getElementById('popupSuggestions').classList.remove('hidden');
                } else if (tab === 'history') {
                    document.getElementById('popupHistory').classList.remove('hidden');
                    loadHistory();
                } else if (tab === 'radio') {
                    document.getElementById('popupRadio').classList.remove('hidden');
                    loadRadios();
                }
            }
            
            async function loadHistory() {
                if (!currentGuild) {
                    return;
                }
                
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '<div class="text-center py-12"><div class="w-10 h-10 border-3 border-transparent rounded-full animate-spin mx-auto mb-3" style="border-top-color: var(--theme-primary); border-right-color: var(--theme-secondary);"></div><p class="text-white/70 font-medium">Chargement...</p></div>';
                
                try {
                    const response = await fetch(`/api/history/${currentGuild}?limit=50`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch history');
                    
                    const data = await response.json();
                    displayHistory(data.tracks || []);
                } catch (error) {
                    console.error('Error loading history:', error);
                    historyList.innerHTML = '<div class="text-center py-12 text-red-400"><i class="fas fa-exclamation-triangle text-2xl mb-4"></i><p>Erreur</p></div>';
                }
            }
            
            function displayHistory(tracks) {
                const historyList = document.getElementById('historyList');
                
                if (!tracks || tracks.length === 0) {
                    historyList.innerHTML = '<div class="text-center py-12 text-white/60"><i class="fas fa-music text-4xl mb-4 opacity-30"></i><p>Aucun historique</p></div>';
                    return;
                }
                
                historyList.innerHTML = tracks.map(track => {
                    const addedDate = new Date(track.addedAt);
                    const seconds = Math.floor((new Date() - addedDate) / 1000);
                    let timeAgo = 'À l\'instant';
                    if (seconds >= 60 && seconds < 3600) timeAgo = `Il y a ${Math.floor(seconds / 60)} min`;
                    else if (seconds >= 3600 && seconds < 86400) timeAgo = `Il y a ${Math.floor(seconds / 3600)} h`;
                    else if (seconds >= 86400) timeAgo = `Il y a ${Math.floor(seconds / 86400)} j`;
                    
                    const userDisplayName = track.addedByDisplayName || track.addedByUsername || 'Dashboard User';
                    const userAvatar = track.addedByAvatar || 'https://cdn.discordapp.com/embed/avatars/0.png';
                    
                    const trackId = generateTrackId(track.trackTitle || "unknown", track.trackAuthor || "unknown");
                    const isInQueue = trackQueuePositions.has(trackId);
                    
                    const buttonHTML = isInQueue ? `
                        <button 
                            data-track-id="${trackId}"
                            class="queue-position-bubble flex-shrink-0 w-11 h-11 sm:w-auto sm:h-auto sm:px-3 sm:py-2 rounded-xl text-white flex items-center justify-center gap-1 text-xs font-bold"
                            style="background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); cursor: default;"
                            disabled
                        >
                            <i class="fas fa-check"></i>
                            <span class="hidden sm:inline">Ajouté</span>
                        </button>
                    ` : `
                        <button 
                            data-track-id="${trackId}"
                            onclick="addHistoryTrack('${(track.trackUri || '').replace(/'/g, "\\'")}', '${(track.trackTitle || '').replace(/'/g, "\\'")}', this)"
                            class="add-track-btn flex-shrink-0 w-11 h-11 rounded-xl text-white hover:scale-105 transition-all" 
                            style="background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));"
                        >
                            <i class="fas fa-plus"></i>
                        </button>
                    `;
                    
                    return `
                        <div class="flex items-center gap-3 p-3 rounded-xl bg-white/5 hover:bg-white/10 transition-all duration-300 group">
                            <img src="${track.trackThumbnail || 'https://via.placeholder.com/80'}" alt="" class="w-16 h-16 rounded-lg object-cover flex-shrink-0" />
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-white text-sm truncate" title="${(track.trackTitle || '').replace(/"/g, "&quot;")}">${track.trackTitle}</h4>
                                <p class="text-xs text-white/60 truncate">${track.trackAuthor}</p>
                                <div class="flex items-center gap-2 mt-1 text-xs">
                                    <img src="${userAvatar}" alt="" class="w-4 h-4 rounded-full object-cover history-avatar-neon" />
                                    <span class="font-medium history-username-neon">${userDisplayName}</span>
                                    <span class="text-white/40">•</span>
                                    <span class="text-white/40">${timeAgo}</span>
                                </div>
                            </div>
                            ${buttonHTML}
                        </div>
                    `;
                }).join('');
            }
            
            async function addHistoryTrack(uri, title, btn) {
                try {
                    if (!currentGuild) return;
                    
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    
                    const res = await fetch(`/api/queue/${currentGuild}/add`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                        body: JSON.stringify({ uri })
                    });
                    
                    if (!res.ok) throw new Error('Failed');
                    
                    // Transformer en checkmark persistant
                    const trackId = btn.getAttribute('data-track-id');
                    if (!trackQueuePositions.has(trackId)) {
                        trackQueuePositions.set(trackId, new Set([1]));
                    }
                    
                    btn.className = 'queue-position-bubble flex-shrink-0 w-11 h-11 sm:w-auto sm:h-auto sm:px-3 sm:py-2 rounded-xl text-white flex items-center justify-center gap-1 text-xs font-bold';
                    btn.style.cssText = 'background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); cursor: default;';
                    btn.innerHTML = '<i class="fas fa-check"></i><span class="hidden sm:inline">Ajouté</span>';
                    showNotification(`"${title}" ajouté !`, 'success');
                } catch (error) {
                    btn.innerHTML = '<i class="fas fa-times"></i>';
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-plus"></i>';
                        btn.disabled = false;
                    }, 2000);
                }
            }
            
            function loadRadios() {
                const radioList = document.getElementById('radioList');
                
                const radios = [
                    { 
                        name: 'Skyrock', 
                        genre: 'Hip-Hop & Rap', 
                        url: 'http://icecast.skyrock.net/s/natio_mp3_128k',
                        logo: 'https://www.radio.fr/100/skyrock.png?version=e2ea4c5031152ae5e991336e4b2f1165'
                    },
                    { 
                        name: 'NRJ', 
                        genre: 'Hits & Pop', 
                        url: 'http://streaming.nrjaudio.fm/oumvmk8fnozc',
                        logo: 'https://play-lh.googleusercontent.com/x-Wj-GhTordPMZbLzSQ8bxTNcz6pcRbCXCMXn2uWj1BfVJoQTMyR8jlp39ooSfpM9pw'
                    },
                    { 
                        name: 'Fun Radio', 
                        genre: 'Dance & Electro', 
                        url: 'http://streaming.radio.funradio.fr/fun-1-44-128',
                        logo: 'https://yt3.googleusercontent.com/vIfDtV3vLqdPaZQioH4kIMf1A2wugTBV-Ur7Yxv0NNNwW4vDOOhsREFfGLLnJXaGXAID1Z5p=s900-c-k-c0x00ffffff-no-rj'
                    },
                    { 
                        name: 'RTL', 
                        genre: 'Actualités & Talk', 
                        url: 'http://streaming.radio.rtl.fr/rtl-1-44-128',
                        logo: 'https://www.radio.fr/100/rtl.png?version=ddb32ac4c9b610e23d81a1f616ef198c'
                    }
                ];
                
                radioList.innerHTML = radios.map(radio => `
                    <div class="flex items-center gap-3 p-3 rounded-xl bg-white/5 hover:bg-white/10 transition-all cursor-pointer group" onclick="addRadio('${radio.url.replace(/'/g, "\\'")}', '${radio.name.replace(/'/g, "\\'")}', '${radio.logo.replace(/'/g, "\\'")}', this)">
                        <!-- Logo de la radio -->
                        <div class="w-24 h-24 sm:w-28 sm:h-28 rounded-xl flex items-center justify-center flex-shrink-0 overflow-hidden bg-white group-hover:scale-105 transition-transform">
                            <img src="${radio.logo}" alt="${radio.name}" class="w-full h-full object-cover" onerror="this.onerror=null; this.parentElement.innerHTML='<i class=\\'fas fa-radio text-3xl\\'></i>'; this.parentElement.style.background='linear-gradient(135deg, var(--theme-primary), var(--theme-secondary))'; this.parentElement.classList.remove('bg-white');">
                        </div>
                        
                        <!-- Infos de la radio -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-broadcast-tower text-red-500" style="font-size: 14px;"></i>
                                <h4 class="font-bold text-white text-sm sm:text-base truncate" title="${radio.name}">${radio.name}</h4>
                            </div>
                            <p class="text-xs sm:text-sm text-white/60 truncate mt-1">${radio.genre}</p>
                            <div class="flex items-center gap-1 mt-1">
                                <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                                <span class="text-xs text-green-400">En direct</span>
                            </div>
                        </div>
                        
                        <!-- Bouton play -->
                        <div class="w-11 h-11 sm:w-12 sm:h-12 rounded-xl flex items-center justify-center text-white hover:scale-110 transition-all flex-shrink-0" style="background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary)); box-shadow: 0 4px 15px color-mix(in srgb, var(--theme-primary) 30%, transparent);">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                `).join('');
            }
            
            async function addRadio(url, name, logo, elem) {
                try {
                    if (!currentGuild) return;
                    
                    const btn = elem.querySelector('div:last-child');
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    
                    const res = await fetch(`/api/queue/${currentGuild}/add`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                        body: JSON.stringify({ 
                            uri: url,
                            thumbnail: logo,
                            isRadio: true,
                            radioName: name
                        })
                    });
                    
                    if (!res.ok) throw new Error('Failed');
                    
                    btn.innerHTML = '<i class="fas fa-check"></i>';
                    showNotification(`"${name}" ajouté !`, 'success');
                    
                    setTimeout(() => btn.innerHTML = '<i class="fas fa-play"></i>', 2000);
                } catch (error) {
                    const btn = elem.querySelector('div:last-child');
                    btn.innerHTML = '<i class="fas fa-times"></i>';
                    setTimeout(() => btn.innerHTML = '<i class="fas fa-play"></i>', 2000);
                }
            }
            
            // Sélectionner la plateforme de recherche
            function selectSearchPlatform(platform) {
                selectedSearchPlatform = platform;
                
                // Enlever la classe active de tous les boutons
                document.querySelectorAll('.search-platform-btn').forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.opacity = '0.5';
                    btn.style.transform = 'scale(0.95)';
                });
                
                // Ajouter la classe active au bouton sélectionné
                const selectedBtn = document.getElementById('platform-' + (platform === 'ytsearch' ? 'youtube' : platform === 'spsearch' ? 'spotify' : 'soundcloud'));
                if (selectedBtn) {
                    selectedBtn.classList.add('active');
                    selectedBtn.style.opacity = '1';
                    selectedBtn.style.transform = 'scale(1)';
                }
                
                // Relancer automatiquement la recherche si du texte est présent
                const searchInput = document.getElementById("popupSearchInput");
                if (searchInput && searchInput.value.trim()) {
                    searchMusicPopup();
                }
            }

            async function searchMusicPopup() {
                const query = document
                    .getElementById("popupSearchInput")
                    .value.trim();
                if (!query) return;

                const resultsContainer =
                    document.getElementById("popupSearchResults");
                const loadingIndicator =
                    document.getElementById("popupLoading");

                // Show loading
                loadingIndicator.classList.remove("hidden");
                resultsContainer.innerHTML = "";

                try {
                    // OPTIMISATION: Utiliser les API natives pour YouTube et SoundCloud
                    let endpoint = "/api/search";
                    let requestBody = {
                        query: query,
                        platform: selectedSearchPlatform,
                        isDirectLink: false
                    };

                    // Détecter si c'est un lien direct
                    const isDirectLink = query.startsWith('http');

                    if (selectedSearchPlatform === 'ytsearch' && !isDirectLink) {
                        // Utiliser l'API YouTube native
                        endpoint = "/api/youtube-native-search";
                        requestBody = {
                            query: query,
                            maxResults: 50
                        };
                        console.log(`🎵 Recherche YouTube native pour: ${query}`);
                    } else if (selectedSearchPlatform === 'spsearch' && !isDirectLink) {
                        // Utiliser l'API Spotify native
                        endpoint = "/api/spotify-native-search";
                        requestBody = {
                            query: query,
                            maxResults: 50
                        };
                        console.log(`🎵 Recherche Spotify native pour: ${query}`);
                    } else if (selectedSearchPlatform === 'scsearch' && !isDirectLink) {
                        // Utiliser l'API SoundCloud native
                        endpoint = "/api/soundcloud-native-search";
                        requestBody = {
                            query: query,
                            maxResults: 50
                        };
                        console.log(`🎵 Recherche SoundCloud native pour: ${query}`);
                    } else {
                        // Utiliser Lavalink pour liens directs uniquement
                        console.log(`🎵 Recherche via Lavalink pour: ${query}`);
                    }

                    const response = await fetch(endpoint, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${authToken}`,
                        },
                        body: JSON.stringify(requestBody),
                    });

                    if (!response.ok) {
                        throw new Error(`Search failed: ${response.status}`);
                    }

                    const data = await response.json();
                    let tracks = data.tracks || [];
                    
                    // Les API natives (YouTube, Spotify, SoundCloud) retournent déjà les bons résultats
                    // Pas besoin de filtrage supplémentaire
                    console.log(`✅ Reçu ${tracks.length} résultats de ${selectedSearchPlatform}`);
                    
                    displayPopupSearchResults(tracks);
                } catch (error) {
                    console.error("Search error:", error);
                    resultsContainer.innerHTML = `
                        <div class="text-center text-red-400 py-8">
                            <i class="fas fa-exclamation-triangle text-2xl mb-4"></i>
                            <p>Erreur de recherche: ${error.message}</p>
                        </div>
                    `;
                } finally {
                    loadingIndicator.classList.add("hidden");
                }
            }

            // Fonction pour transformer un bouton en checkmark
            async function transformButtonToBubble(btn, trackId, trackTitle) {
                try {
                    // Enregistrer dans la Map que la track est dans la queue
                    if (!trackQueuePositions.has(trackId)) {
                        trackQueuePositions.set(trackId, new Set([1]));
                    }
                    
                    // Animation de transformation
                    btn.style.animation = "buttonToBubble 0.6s ease-out forwards";
                    
                    // Après l'animation, remplacer le contenu par un checkmark
                    setTimeout(() => {
                        // Créer le nouveau bouton avec checkmark
                        const checkBtn = document.createElement('button');
                        checkBtn.setAttribute('data-track-id', trackId);
                        checkBtn.className = 'queue-position-bubble flex-shrink-0 w-11 h-11 sm:w-auto sm:h-auto sm:px-5 sm:py-3 rounded-xl font-bold text-sm text-white flex items-center justify-center gap-2';
                        checkBtn.style.cssText = 'background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); cursor: default;';
                        checkBtn.disabled = true;
                        checkBtn.innerHTML = '<i class="fas fa-check"></i><span class="hidden sm:inline">Ajouté</span>';
                        
                        // Remplacer le bouton par le checkmark
                        btn.parentNode.replaceChild(checkBtn, btn);
                        
                        console.log(`✅ Button transformed to checkmark for track: ${trackTitle}`);
                    }, 600);
                } catch (error) {
                    console.error("Error transforming button:", error);
                    btn.disabled = false;
                }
            }
            
            // Fonction pour récupérer les positions d'une track dans la queue
            async function getTrackQueuePosition(trackId) {
                if (!currentState || !currentState.queue) {
                    return null;
                }
                
                // Chercher toutes les occurrences dans la queue actuelle
                const queueWithCurrent = currentState.current ? [currentState.current, ...currentState.queue] : currentState.queue;
                const positions = [];
                
                for (let i = 0; i < queueWithCurrent.length; i++) {
                    const qTrack = queueWithCurrent[i];
                    const qTrackId = generateTrackId(qTrack.info?.title || "", qTrack.info?.author || "");
                    if (qTrackId === trackId) {
                        positions.push(i + 1); // Position 1-indexed
                    }
                }
                
                // Retourner la première position ou null
                return positions.length > 0 ? positions[0] : null;
            }
            
            // Fonction pour mettre à jour toutes les positions dans le popup
            function updateQueuePositions(queueTracks) {
                if (!queueTracks) return;
                
                // Créer une Set des trackIds actuellement dans la queue
                const currentQueueIds = new Set();
                
                queueTracks.forEach((track) => {
                    const trackId = generateTrackId(track.info?.title || "", track.info?.author || "");
                    currentQueueIds.add(trackId);
                });
                
                // Parcourir tous les boutons checkmark existants dans le popup
                const checkButtons = document.querySelectorAll('.queue-position-bubble');
                checkButtons.forEach(checkBtn => {
                    const trackId = checkBtn.getAttribute('data-track-id');
                    
                    if (!currentQueueIds.has(trackId)) {
                        // La track n'est plus dans la queue, retransformer en bouton +
                        retransformBubbleToButton(checkBtn, trackId);
                    }
                });
                
                // Mettre à jour la Map globale pour suivre les tracks dans la queue
                trackQueuePositions = new Map();
                currentQueueIds.forEach(id => trackQueuePositions.set(id, new Set([1])));
            }
            
            // Fonction pour retransformer une bulle en bouton
            function retransformBubbleToButton(bubble, trackId) {
                // Créer le nouveau bouton
                const btn = document.createElement('button');
                btn.setAttribute('data-track-id', trackId);
                btn.className = 'add-track-btn flex-shrink-0 w-11 h-11 sm:w-auto sm:h-auto sm:px-5 sm:py-3 rounded-xl font-bold text-sm text-white transition-all duration-300 hover:scale-105 active:scale-95 flex items-center justify-center gap-2';
                btn.style.cssText = 'background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary)); box-shadow: 0 4px 15px color-mix(in srgb, var(--theme-primary) 30%, transparent);';
                btn.innerHTML = '<i class="fas fa-plus"></i><span class="hidden sm:inline">Ajouter</span>';
                
                // Animation de retransformation
                bubble.style.animation = "buttonToBubble 0.6s ease-out reverse";
                
                setTimeout(() => {
                    bubble.parentNode.replaceChild(btn, bubble);
                    trackQueuePositions.delete(trackId);
                    console.log(`🔄 Bubble retransformed to button for track ID: ${trackId}`);
                    
                    // Note: Les event listeners seront ajoutés lors de la prochaine recherche
                    // On pourrait aussi les ajouter ici si nécessaire
                }, 600);
            }

            function displayPopupSearchResults(tracks) {
                const container = document.getElementById("popupSearchResults");

                if (!tracks.length) {
                    container.innerHTML = `
                        <div class="text-center py-20">
                            <i class="fas fa-search text-5xl text-white/20 mb-4"></i>
                            <p class="text-white/60 font-medium">Aucun résultat</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = tracks
                    .map((track, index) => {
                        const duration = track.duration ? formatDuration(track.duration) : "—";
                        const thumbnail = track.thumbnail || "";
                        const platform = track.platform || selectedPlatform;
                        
                        let platformIcon = '';
                        let platformBg = '';
                        if (platform.toLowerCase().includes('youtube')) {
                            platformIcon = 'fab fa-youtube';
                            platformBg = 'linear-gradient(135deg, #FF0000, #B30000)';
                        } else if (platform.toLowerCase().includes('spotify')) {
                            platformIcon = 'fab fa-spotify';
                            platformBg = 'linear-gradient(135deg, #1DB954, #158940)';
                        } else if (platform.toLowerCase().includes('soundcloud')) {
                            platformIcon = 'fab fa-soundcloud';
                            platformBg = 'linear-gradient(135deg, #FF8800, #CC6D00)';
                        } else {
                            platformIcon = 'fas fa-music';
                            platformBg = 'linear-gradient(135deg, #8B5CF6, #6D28D9)';
                        }
                        
                        // Générer un ID unique pour cette track
                        const trackId = generateTrackId(track.title || "unknown", track.author || "unknown");
                        
                        // Vérifier si la track est déjà dans la queue
                        const isInQueue = trackQueuePositions.has(trackId);
                        
                        // Créer soit le bouton + soit le bouton checkmark
                        let actionButton;
                        if (isInQueue) {
                            // Afficher le bouton checkmark
                            actionButton = `
                                <button 
                                    data-track-id="${trackId}"
                                    class="queue-position-bubble flex-shrink-0 w-11 h-11 sm:w-auto sm:h-auto sm:px-5 sm:py-3 rounded-xl font-bold text-sm text-white flex items-center justify-center gap-2"
                                    style="background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); cursor: default;"
                                    disabled
                                >
                                    <i class="fas fa-check"></i>
                                    <span class="hidden sm:inline">Ajouté</span>
                                </button>
                            `;
                        } else {
                            actionButton = `
                                <button 
                                    data-track-index="${index}"
                                    data-track-id="${trackId}"
                                    class="add-track-btn flex-shrink-0 w-11 h-11 sm:w-auto sm:h-auto sm:px-5 sm:py-3 rounded-xl font-bold text-sm text-white transition-all duration-300 hover:scale-105 active:scale-95 flex items-center justify-center gap-2"
                                    style="background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary)); box-shadow: 0 4px 15px color-mix(in srgb, var(--theme-primary) 30%, transparent);"
                                >
                                    <i class="fas fa-plus"></i>
                                    <span class="hidden sm:inline">Ajouter</span>
                                </button>
                            `;
                        }

                        return `
                        <div class="track-item" style="animation: trackAppear 0.4s ease ${index * 0.06}s both;">
                            <div class="group relative flex items-center gap-3 p-3 bg-white/5 border border-white/10 rounded-2xl transition-all duration-300 hover:bg-white/10 hover:border-white/25">
                                <!-- Thumbnail -->
                                <div class="relative w-16 h-16 flex-shrink-0 rounded-xl overflow-hidden">
                                    ${thumbnail 
                                        ? `<img src="${thumbnail}" alt="" class="w-full h-full object-cover">`
                                        : `<div class="w-full h-full flex items-center justify-center text-white text-2xl" style="background: ${platformBg};"><i class="${platformIcon}"></i></div>`
                                    }
                                    <div class="absolute top-1.5 right-1.5 w-6 h-6 rounded-lg flex items-center justify-center text-white text-xs" style="background: ${platformBg};">
                                        <i class="${platformIcon}"></i>
                                    </div>
                                </div>
                                
                                <!-- Info -->
                                <div class="flex-1 min-w-0">
                                    <div class="overflow-hidden mb-0.5">
                                        <h4 class="font-semibold text-white text-sm sm:text-base whitespace-nowrap track-title-marquee">
                                            ${(track.title || "Sans titre").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;")}
                                        </h4>
                                    </div>
                                    <p class="text-white/50 text-xs sm:text-sm truncate mb-1">
                                        ${(track.author || "Inconnu").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;")}
                                    </p>
                                    <span class="text-white/40 text-xs">${duration}</span>
                                </div>
                                
                                <!-- Bouton + ou Checkmark -->
                                ${actionButton}
                            </div>
                        </div>
                    `;
                    })
                    .join("");
                    
                if (!document.getElementById('trackItemStyles')) {
                    const styleEl = document.createElement('style');
                    styleEl.id = 'trackItemStyles';
                    styleEl.textContent = `
                        @keyframes trackAppear {
                            from { opacity: 0; transform: translateY(10px); }
                            to { opacity: 1; transform: translateY(0); }
                        }
                        
                        /* Animation marquee pour titres longs */
                        @keyframes marqueeScroll {
                            0% { transform: translateX(0); }
                            100% { transform: translateX(-50%); }
                        }
                        
                        .track-title-marquee {
                            display: inline-block;
                            padding-right: 20px;
                        }
                        
                        /* Activer l'animation au hover si le texte dépasse */
                        .track-item:hover .track-title-marquee {
                            animation: marqueeScroll 8s linear infinite;
                        }
                        
                        /* Animation de la bulle de position */
                        @keyframes bubblePulse {
                            0%, 100% {
                                transform: scale(1);
                                box-shadow: 0 0 20px color-mix(in srgb, var(--theme-primary) 50%, transparent);
                            }
                            50% {
                                transform: scale(1.05);
                                box-shadow: 0 0 30px color-mix(in srgb, var(--theme-primary) 70%, transparent);
                            }
                        }
                        
                        /* Animation de validation de succès */
                        @keyframes successPulse {
                            0% {
                                transform: scale(1.1);
                                box-shadow: 0 0 30px rgba(34, 197, 94, 1), 0 0 60px rgba(34, 197, 94, 0.5);
                            }
                            50% {
                                transform: scale(1.15);
                                box-shadow: 0 0 40px rgba(34, 197, 94, 1), 0 0 80px rgba(34, 197, 94, 0.7);
                            }
                            100% {
                                transform: scale(1.1);
                                box-shadow: 0 0 30px rgba(34, 197, 94, 1), 0 0 60px rgba(34, 197, 94, 0.5);
                            }
                        }
                        
                        /* Animation de transformation du bouton en bulle */
                        @keyframes buttonToBubble {
                            0% {
                                border-radius: 0.75rem;
                                width: auto;
                                transform: scale(1) rotate(0deg);
                            }
                            50% {
                                transform: scale(1.2) rotate(180deg);
                            }
                            100% {
                                border-radius: 9999px;
                                width: 3.5rem;
                                height: 3.5rem;
                                transform: scale(1) rotate(360deg);
                            }
                        }
                        
                        /* Style pour la bulle de position */
                        .queue-position-bubble {
                            cursor: default;
                            user-select: none;
                        }
                    `;
                    document.head.appendChild(styleEl);
                    
                    // Dupliquer le texte pour les titres longs pour un effet continu
                    setTimeout(() => {
                        document.querySelectorAll('.track-title-marquee').forEach(title => {
                            if (title.scrollWidth > title.parentElement.clientWidth) {
                                const originalText = title.textContent;
                                title.innerHTML = originalText + ' &nbsp;&nbsp; ' + originalText;
                            }
                        });
                    }, 100);
                }
                
                // Configurer la réduction au scroll après l'affichage des résultats
                setupPopupScrollCollapse();

                // Add event listeners for the add buttons with beautiful animation and anti-spam
                const currentTracks = tracks; // Store tracks for the event listeners
                container
                    .querySelectorAll(".add-track-btn")
                    .forEach((btn, index) => {
                        btn.addEventListener("click", async () => {
                            const track = currentTracks[index];
                            if (track && !btn.disabled) {
                                // Create unique track ID for anti-spam (utiliser generateTrackId pour cohérence)
                                const trackId = generateTrackId(track.title || "unknown", track.author || "unknown");
                                const now = Date.now();

                                // Check anti-spam cooldown
                                if (recentlyAddedTracks.has(trackId)) {
                                    const lastAdded =
                                        recentlyAddedTracks.get(trackId);
                                    const timeDiff = now - lastAdded;
                                    if (timeDiff < ANTI_SPAM_COOLDOWN) {
                                        const remainingTime = Math.ceil(
                                            (ANTI_SPAM_COOLDOWN - timeDiff) /
                                                1000,
                                        );
                                        showNotification(
                                            `Attendez ${remainingTime}s avant de re-ajouter "${track.title}"`,
                                            "warning",
                                        );
                                        return;
                                    }
                                }

                                // Disable button temporarily to prevent double clicks
                                btn.disabled = true;

                                // Add glowing effect and scale animation
                                btn.style.boxShadow = "0 0 20px rgba(34, 197, 94, 0.6)";
                                btn.style.transform = "scale(1.05)";
                                
                                // Change button to show loading state
                                const originalHTML = btn.innerHTML;
                                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span class="hidden sm:inline ml-2">Ajout...</span>';

                                try {
                                    console.log(`🎵 Adding track to queue: ${track.title} by ${track.author}`);
                                    
                                    await addTrackToQueue(
                                        track.encoded || "",
                                        track.title || "Titre inconnu",
                                        track.author || "Artiste inconnu",
                                        track.thumbnail || "",
                                        track.duration || 0,
                                        track.uri || "",
                                    );

                                    // Add to anti-spam list
                                    recentlyAddedTracks.set(trackId, now);

                                    // Clean old entries (older than cooldown)
                                    for (const [id, timestamp] of recentlyAddedTracks.entries()) {
                                        if (now - timestamp > ANTI_SPAM_COOLDOWN) {
                                            recentlyAddedTracks.delete(id);
                                        }
                                    }

                                    // Show success state avec animation améliorée - VALIDATION
                                    btn.innerHTML = '<i class="fas fa-check" style="font-size: 1.2em;"></i><span class="hidden sm:inline ml-2">Ajouté!</span>';
                                    btn.style.boxShadow = "0 0 30px rgba(34, 197, 94, 1), 0 0 60px rgba(34, 197, 94, 0.5)";
                                    btn.style.transform = "scale(1.1)";
                                    btn.style.animation = "successPulse 0.6s ease-out";
                                    
                                    console.log(`✅ Track added successfully: ${track.title}`);

                                    // Afficher le numéro de position dans le bouton après 800ms
                                    setTimeout(async () => {
                                        try {
                                            // Récupérer la position actuelle dans la queue
                                            const position = await getTrackQueuePosition(trackId);
                                            
                                            if (position) {
                                                // Transformer le bouton pour afficher le numéro
                                                btn.innerHTML = `<span style="font-size: 1.3em; font-weight: bold;">#${position}</span>`;
                                                btn.style.background = "linear-gradient(135deg, var(--theme-primary) 30%, var(--theme-secondary))";
                                                btn.style.borderColor = "var(--theme-light)";
                                                btn.style.boxShadow = "0 0 20px color-mix(in srgb, var(--theme-primary) 60%, transparent)";
                                                btn.style.transform = "scale(1)";
                                                btn.style.animation = "bubblePulse 2s ease-in-out infinite";
                                                btn.disabled = true;
                                                btn.style.cursor = "default";
                                                
                                                console.log(`🎯 Button now shows position #${position} for: ${track.title}`);
                                            } else {
                                                // Si la position n'est pas trouvée, garder l'état "Ajouté"
                                                btn.style.transform = "scale(1)";
                                                btn.disabled = true;
                                            }
                                        } catch (error) {
                                            console.error("Error getting track position:", error);
                                            btn.style.transform = "scale(1)";
                                        }
                                    }, 800);
                                } catch (error) {
                                    console.error("❌ Error adding track:", error);
                                    
                                    // Show error state
                                    btn.innerHTML = '<i class="fas fa-times"></i><span class="hidden sm:inline ml-2">Erreur</span>';
                                    btn.style.boxShadow = "0 0 20px rgba(239, 68, 68, 0.6)";
                                    
                                    // Restore button after 1.5 seconds
                                    setTimeout(() => {
                                        btn.innerHTML = originalHTML;
                                        btn.disabled = false;
                                        btn.style.boxShadow = "";
                                        btn.style.transform = "";
                                    }, 1500);
                                }
                            }
                        });
                    });
            }

            // Function to add track to queue from popup search
            async function addTrackToQueue(
                encoded,
                title,
                author,
                thumbnail,
                duration,
                uri,
            ) {
                if (!currentGuild) {
                    console.error("No guild selected");
                    showError("Veuillez sélectionner un serveur");
                    return;
                }

                try {
                    const response = await fetch(
                        `/api/queue/${currentGuild}/add`,
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${authToken}`,
                            },
                            body: JSON.stringify({
                                encoded,
                                title,
                                author,
                                thumbnail,
                                duration,
                                uri,
                            }),
                        },
                    );

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(
                            errorData.error || `HTTP ${response.status}`,
                        );
                    }

                    const result = await response.json();
                    console.log("Track added successfully:", result);

                    // Afficher le message de succès sans fermer le popup
                    showSuccess(`"${title}" ajouté à la playlist !`);
                } catch (error) {
                    console.error("Error adding track to queue:", error);
                    showError(`Erreur lors de l'ajout: ${error.message}`);
                }
            }

            // Initialize
            document.addEventListener("DOMContentLoaded", async function () {
                console.log('🚀 Dashboard initializing...');
                
                // Check if user is authenticated with Discord OAuth
                const authenticated = await checkAuthStatus();
                
                if (!authenticated) {
                    // Show login page if not authenticated
                    console.log('⚠️ User not authenticated, showing login page');
                    return;
                }
                
                initializeSocket();
                
                // Load guilds and show selection instead of using demo mode
                try {
                    const guilds = await loadGuilds();
                    if (guilds && guilds.length > 0) {
                        console.log(`✅ Loaded ${guilds.length} guilds, showing selection`);
                        showGuildSelection(guilds);
                    } else {
                        console.log('⚠️ No guilds available, using demo mode');
                        currentGuild = "demo";
                        showDashboard();
                    }
                } catch (error) {
                    console.error('❌ Error loading guilds:', error);
                    currentGuild = "demo";
                    showDashboard();
                }
            });

            // Clean up intervals when page unloads
            window.addEventListener("beforeunload", function () {
                stopProgressUpdates();
            });

            async function showGuildSelection(guilds = null) {
                console.log("showGuildSelection called with:", guilds);

                if (!guilds) {
                    console.log("Loading guilds...");
                    guilds = await loadGuilds();
                    console.log("Loaded guilds:", guilds);
                }

                // Add safety check for guilds array
                if (!guilds || !Array.isArray(guilds) || guilds.length === 0) {
                    console.log("No valid guilds found, starting demo mode");
                    currentGuild = "demo"; // Use demo guild
                    showDashboard();
                    return;
                }

                // Generate guild cards with real server icons
                const guildList = document.getElementById("guildList");
                try {
                    guildList.innerHTML = guilds
                        .map(
                            (guild) => {
                                const isBotPresent = guild.botPresent !== false;
                                const isDisabled = !isBotPresent;
                                const guildIcon = guild.icon || 'https://cdn.discordapp.com/embed/avatars/0.png';
                                
                                return `
                    <div class="gradient-border card-hover ${isDisabled ? 'opacity-40 cursor-not-allowed' : ''}" >
                        <div class="gradient-border-content p-4 sm:p-6 ${isDisabled ? 'grayscale' : ''}">
                            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 mb-4">
                                <div class="relative flex-shrink-0">
                                    <img src="${guildIcon}" alt="${guild.name}" class="w-16 h-16 sm:w-20 sm:h-20 rounded-2xl object-cover shadow-lg" style="box-shadow: 0 8px 24px color-mix(in srgb, var(--theme-primary) 30%, transparent);" />
                                    <div class="absolute -bottom-1 -right-1 w-6 h-6 rounded-full flex items-center justify-center ${guild.hasPlayer ? "bg-green-500 pulse-animation" : "bg-gray-500"}" style="box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.9);">
                                        ${guild.hasPlayer ? '<i class="fas fa-music text-white" style="font-size: 10px;"></i>' : '<i class="fas fa-pause text-white" style="font-size: 10px;"></i>'}
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-bold text-lg sm:text-xl text-white mb-1 truncate">${guild.name}</h3>
                                    <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs sm:text-sm">
                                        <div class="flex items-center gap-1.5 text-white/60">
                                            <i class="fas fa-users"></i>
                                            <span>${guild.memberCount} membres</span>
                                        </div>
                                        ${!isDisabled ? `
                                        <div class="flex items-center gap-1.5 ${guild.hasPlayer ? "text-green-400" : "text-white/50"}">
                                            <i class="fas fa-${guild.hasPlayer ? 'play-circle' : 'stop-circle'}"></i>
                                            <span>${guild.hasPlayer ? "En lecture" : "Inactif"}</span>
                                        </div>
                                        ` : `
                                        <div class="flex items-center gap-1.5 text-red-400">
                                            <i class="fas fa-times-circle"></i>
                                            <span>Bot absent</span>
                                        </div>
                                        `}
                                    </div>
                                </div>
                            </div>
                            ${!isDisabled ? `
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3">
                                <button
                                    onclick="event.stopPropagation(); joinVoiceChannelForGuild('${guild.id}')"
                                    class="w-full btn-primary text-white py-3 px-4 rounded-xl transition-all duration-300 font-semibold text-sm flex items-center justify-center gap-2 hover:scale-105"
                                    style="background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary)); box-shadow: 0 4px 12px color-mix(in srgb, var(--theme-primary) 40%, transparent);"
                                >
                                    <i class="fas fa-microphone"></i>
                                    <span>Rejoindre</span>
                                </button>
                                <button
                                    onclick="event.stopPropagation(); selectGuild('${guild.id}')"
                                    class="w-full text-white py-3 px-4 rounded-xl transition-all duration-300 font-semibold text-sm hover:scale-105 flex items-center justify-center gap-2"
                                    style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);"
                                >
                                    <i class="fas fa-sliders-h"></i>
                                    <span>Dashboard</span>
                                </button>
                            </div>
                            ` : `
                            <div class="text-center py-2 text-sm text-red-400/80">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                Le bot n'est pas présent sur ce serveur
                            </div>
                            `}
                        </div>
                    </div>
                `;
                            }
                        )
                        .join("");

                    console.log("Guild selection HTML generated successfully");
                    document
                        .getElementById("guildSelection")
                        .classList.remove("hidden");
                    document
                        .getElementById("dashboard")
                        .classList.add("hidden");
                    
                    // Masquer le bouton de recherche sur la page de sélection des serveurs
                    const searchButton = document.getElementById("searchButton");
                    if (searchButton) {
                        searchButton.classList.add("hidden");
                    }
                } catch (error) {
                    console.error(
                        "Error generating guild selection HTML:",
                        error,
                    );
                    // Fallback to demo mode if there's an error
                    currentGuild = "demo";
                    showDashboard();
                }
            }

            async function loadGuilds() {
                try {
                    const response = await fetch("/api/guilds", {
                        headers: {
                            Authorization: `Bearer ${authToken}`,
                        },
                    });

                    if (response.ok) {
                        const guilds = await response.json();
                        return guilds;
                    } else {
                        console.log(
                            "No guilds available - running in development mode",
                        );
                        return [];
                    }
                } catch (error) {
                    console.log("Error loading guilds:", error);
                    return [];
                }
            }

            function showError(message) {
                const errorDiv = document.getElementById("authError");
                errorDiv.textContent = message;
                errorDiv.classList.remove("hidden");
                setTimeout(() => errorDiv.classList.add("hidden"), 5000);
            }
            
            // Alias pour showSuccess
            function showSuccess(message) {
                showNotification(message, 'success');
            }

            function selectGuild(guildId) {
                currentGuild = guildId;
                document
                    .getElementById("guildSelection")
                    .classList.add("hidden");
                document.getElementById("dashboard").classList.remove("hidden");
                
                // Afficher le bouton de recherche dans le dashboard du serveur
                const searchButton = document.getElementById("searchButton");
                if (searchButton) {
                    searchButton.classList.remove("hidden");
                }

                if (socket) {
                    socket.emit("joinGuild", guildId);
                }

                loadGuildState();
            }

            function initializeSocket() {
                socket = io();

                socket.on("connect", () => {
                    // Authenticate first
                    socket.emit("authenticate", authToken);
                });

                socket.on("authenticated", (success) => {
                    if (success) {
                        updateConnectionStatus(true);
                        if (currentGuild) {
                            socket.emit("joinGuild", currentGuild);
                        }
                    } else {
                        console.log(
                            "Authentication failed - but continuing in demo mode",
                        );
                    }
                });

                socket.on("disconnect", () => {
                    updateConnectionStatus(false);
                });

                socket.on("stateUpdate", (state) => {
                    console.log("State update received:", state);
                    currentState = state;
                    updateUI(state);

                    // Always update progress bar position, even when paused
                    if (
                        state &&
                        state.current &&
                        state.position !== undefined &&
                        state.current.info.length
                    ) {
                        updateProgress(
                            state.position,
                            state.current.info.length,
                        );
                    }
                    
                    // Mettre à jour les positions dans le popup de recherche
                    if (state && state.queue) {
                        const queueWithCurrent = state.current ? [state.current, ...state.queue] : state.queue;
                        updateQueuePositions(queueWithCurrent);
                    }
                });

                socket.on("queueUpdate", (state) => {
                    currentState = state;
                    updateQueue(state?.queue || []);
                    
                    // Mettre à jour les positions dans le popup de recherche
                    if (state && state.queue) {
                        const queueWithCurrent = state.current ? [state.current, ...state.queue] : state.queue;
                        updateQueuePositions(queueWithCurrent);
                    }
                });

                socket.on("positionUpdate", (data) => {
                    // Validate incoming data
                    console.log("Position update:", data);
                    if (data && typeof data.position === "number") {
                        // Use data.duration if available, fallback to current track duration
                        const duration =
                            data.duration ||
                            currentState?.current?.info?.length;
                        if (duration) {
                            updateProgress(data.position, duration);
                        }
                        // Don't manage the timer here - let updateUI handle start/stop decisions
                    }
                });

                socket.on("playerDestroyed", async () => {
                    try {
                        const response = await fetch("/api/guilds", {
                            headers: {
                                Authorization: `Bearer ${authToken}`,
                            },
                        });
                        if (response.ok) {
                            const guilds = await response.json();
                            document
                                .getElementById("dashboard")
                                .classList.add("hidden");
                            showGuildSelection(guilds);
                        }
                    } catch (error) {
                        console.error(
                            "Error fetching guilds after player destroyed:",
                            error,
                        );
                        // Fallback to demo mode
                        console.log(
                            "Player destroyed, continuing in demo mode",
                        );
                    }
                });

                socket.on("historyUpdate", () => {
                    console.log("📜 History updated, refreshing...");
                    const historyTab = document.getElementById('popupHistory');
                    if (historyTab && !historyTab.classList.contains('hidden')) {
                        loadHistory();
                    }
                });
            }

            function updateConnectionStatus(connected) {
                const icon = document.getElementById("statusIcon");
                const text = document.getElementById("statusText");
                const button = document.getElementById("connectionStatus");
                
                // Récupérer le thème actuel
                const currentTheme = localStorage.getItem("zgmusicGradientTheme") || "red";
                const themeConfig = gradientThemes[currentTheme];

                if (connected) {
                    icon.className = "fas fa-wifi text-sm sm:text-base";
                    text.textContent = "Connecté";
                    text.className = "hidden sm:inline text-xs sm:text-sm font-medium";
                    // Utiliser les couleurs du thème pour l'état connecté
                    button.style.background = `linear-gradient(to right, ${themeConfig.primary}, ${themeConfig.secondary})`;
                    button.style.boxShadow = `0 4px 14px ${themeConfig.primary}80`;
                } else {
                    icon.className = "fas fa-wifi-slash text-sm sm:text-base";
                    text.textContent = "Déconnecté";
                    text.className = "hidden sm:inline text-xs sm:text-sm font-medium";
                    // Utiliser un gris pour l'état déconnecté
                    button.style.background = "linear-gradient(to right, #6b7280, #4b5563)";
                    button.style.boxShadow = "0 4px 14px rgba(0, 0, 0, 0.3)";
                }
            }

            async function loadGuildState() {
                try {
                    const response = await fetch(`/api/state/${currentGuild}`, {
                        headers: {
                            Authorization: `Bearer ${authToken}`,
                        },
                    });

                    if (response.ok) {
                        const state = await response.json();
                        currentState = state;
                        updateUI(state);
                    }
                } catch (error) {
                    console.error("Error loading guild state:", error);
                }
            }

            function updateUI(state) {
                if (!state) {
                    console.log('⚠️ updateUI called with null state');
                    return;
                }

                console.log(`🔄 Updating UI - hasPlayer: ${state.hasPlayer}, current: ${state.current?.info?.title || 'none'}`);

                // Handle idle state (no active player)
                if (state.hasPlayer === false) {
                    console.log('📭 No active player - displaying idle state');
                    updateCurrentTrack(null);
                    updateQueue([]);
                    updateVolume(100);
                    updatePlayPauseButton(false, null);
                    updatePausedIndicator(false);
                    stopProgressUpdates();
                    return;
                }

                // Normal state with active player
                updateCurrentTrack(state.current);
                updateQueue(state.queue || []);
                updateVolume(state.volume || 100);
                updatePlayPauseButton(state.paused, state.current);
                updatePausedIndicator(state.paused);

                // Manage progress updates based on play state
                if (state.current && !state.paused) {
                    startProgressUpdates();
                } else {
                    stopProgressUpdates();
                }
            }

            // New function for combined play/pause button
            function togglePlayPause() {
                if (!currentState || !currentState.current) {
                    return;
                }

                const action = currentState.paused ? "resume" : "pause";
                control(action);
            }

            function updatePlayPauseButton(isPaused, currentTrack) {
                const button = document.getElementById("playPauseBtn");
                const icon = document.getElementById("playPauseIcon");
                const text = document.getElementById("playPauseText");

                if (!currentTrack) {
                    // No track playing
                    button.disabled = true;
                    button.classList.add("opacity-50", "cursor-not-allowed");
                    icon.className = "fas fa-play mr-2";
                    text.textContent = "Aucune musique";
                } else {
                    // Track is available
                    button.disabled = false;
                    button.classList.remove("opacity-50", "cursor-not-allowed");

                    if (isPaused) {
                        icon.className = "fas fa-play mr-2";
                        text.textContent = "Reprendre";
                        button.classList.add("animate-pulse");
                    } else {
                        icon.className = "fas fa-pause mr-2";
                        text.textContent = "Pause";
                        button.classList.remove("animate-pulse");
                    }
                }
            }

            function updatePausedIndicator(isPaused) {
                const indicator = document.getElementById("pausedIndicator");
                if (indicator) {
                    if (isPaused) {
                        indicator.classList.remove("hidden");
                    } else {
                        indicator.classList.add("hidden");
                    }
                }
            }

            // Function removed - no longer needed since we simplified the search

            // Clear queue function
            async function clearQueue() {
                if (!currentGuild) return;

                if (
                    confirm(
                        "Êtes-vous sûr de vouloir vider la file d'attente ?",
                    )
                ) {
                    try {
                        await control("stop");
                        // The queue will be cleared automatically by the stop command
                    } catch (error) {
                        console.error("Error clearing queue:", error);
                    }
                }
            }

            function updateCurrentTrack(track) {
                const container = document.getElementById("currentTrack");

                if (!track) {
                    // Stop progress updates when no track is playing
                    stopProgressUpdates();
                    currentPosition = 0;
                    currentDuration = 0;

                    container.innerHTML = `
                    <div class="relative text-center py-10 overflow-hidden">
                        <!-- Contenu principal -->
                        <div class="relative z-10">
                            <!-- Icône centrale compacte -->
                            <div class="relative inline-block mb-5">
                                <div class="relative w-24 h-24 rounded-2xl flex items-center justify-center border-2 backdrop-blur-md shadow-lg floating-animation" style="background: linear-gradient(135deg, color-mix(in srgb, var(--theme-primary) 20%, transparent), color-mix(in srgb, var(--theme-dark) 30%, transparent)); border-color: color-mix(in srgb, var(--theme-primary) 40%, transparent); box-shadow: 0 0 30px color-mix(in srgb, var(--theme-primary) 30%, transparent);">
                                    <i class="fas fa-music text-4xl text-transparent bg-clip-text" style="background: linear-gradient(135deg, var(--theme-light), var(--theme-primary)); -webkit-background-clip: text;"></i>
                                </div>
                                <div class="absolute -bottom-2 -right-2 w-10 h-10 bg-gradient-to-br from-gray-700 to-gray-900 rounded-full flex items-center justify-center border-2 shadow-lg pulse-animation" style="border-color: color-mix(in srgb, var(--theme-primary) 50%, transparent);">
                                    <i class="fas fa-pause text-white text-sm"></i>
                                </div>
                            </div>
                            
                            <!-- Titre -->
                            <h3 class="text-2xl font-bold mb-6 text-white">
                                <i class="fas fa-compact-disc mr-2 fa-spin" style="color: color-mix(in srgb, var(--theme-light) 60%, transparent); animation-duration: 4s;"></i>
                                Aucune musique en cours
                            </h3>
                            
                            <!-- Message de suggestion -->
                            <div class="inline-flex items-center space-x-2 px-4 py-2 rounded-full border text-sm" style="background: color-mix(in srgb, var(--theme-primary) 5%, transparent); border-color: color-mix(in srgb, var(--theme-primary) 20%, transparent); color: color-mix(in srgb, var(--theme-light) 60%, transparent);">
                                <i class="fas fa-info-circle" style="color: color-mix(in srgb, var(--theme-light) 60%, transparent);"></i>
                                <span>Utilisez /play pour lancer une musique sur Discord</span>
                            </div>
                        </div>
                    </div>
                `;
                    return;
                }

                // Try multiple property paths for album artwork
                const artwork =
                    track.info?.artworkUrl ||
                    track.info?.thumbnail ||
                    track.thumbnail ||
                    track.artworkUrl ||
                    track.info?.artwork ||
                    track.artwork ||
                    null;

                // Détecter la plateforme d'origine
                let platformIcon = '';
                let platformColor = '';
                let platformName = '';
                const uri = track.info?.uri || track.uri || '';
                const sourceName = track.info?.sourceName || track.sourceName || '';
                
                if (uri.includes('youtube') || sourceName.toLowerCase().includes('youtube')) {
                    platformIcon = 'fab fa-youtube';
                    platformColor = '#FF0000';
                    platformName = 'YouTube';
                } else if (uri.includes('spotify') || sourceName.toLowerCase().includes('spotify')) {
                    platformIcon = 'fab fa-spotify';
                    platformColor = '#1DB954';
                    platformName = 'Spotify';
                } else if (uri.includes('soundcloud') || sourceName.toLowerCase().includes('soundcloud')) {
                    platformIcon = 'fab fa-soundcloud';
                    platformColor = '#FF7700';
                    platformName = 'SoundCloud';
                } else {
                    platformIcon = 'fas fa-music';
                    platformColor = 'var(--theme-primary)';
                    platformName = 'Musique';
                }

                const requester = track.info?.requester;
                const requesterName = requester?.displayName || requester?.tag || requester?.username || 'Utilisateur Discord';
                const requesterAvatar = requester?.avatar || null;
                
                // Get full title and author without truncation
                const fullTitle = track.info?.title || "Titre inconnu";
                const fullAuthor = track.info?.author || "Artiste inconnu";

                container.innerHTML = `
                <div class="space-y-3 sm:space-y-4">
                    <!-- Layout optimisé mobile avec pochette en ligne -->
                    <div class="flex items-center gap-3 sm:gap-4">
                        <!-- Pochette avec badge play - Optimisée mobile -->
                        <div class="relative flex-shrink-0">
                            <div class="w-24 h-24 sm:w-28 sm:h-28 md:w-32 md:h-32 bg-gradient-to-br from-purple-500/20 to-cyan-500/20 rounded-2xl flex items-center justify-center border-2 overflow-hidden shadow-2xl" 
                                 style="border-color: var(--theme-primary); box-shadow: 0 0 25px color-mix(in srgb, var(--theme-primary) 40%, transparent), 0 8px 16px rgba(0,0,0,0.3);">
                                ${artwork ? `<img src="${artwork}" alt="Album artwork" class="w-full h-full object-cover">` : `<i class="fas fa-music text-3xl sm:text-4xl text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-cyan-400"></i>`}
                            </div>
                            <div class="absolute -bottom-1.5 -right-1.5 w-8 h-8 sm:w-9 sm:h-9 md:w-10 md:h-10 rounded-full flex items-center justify-center pulse-animation" style="background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary)); box-shadow: 0 0 15px var(--theme-primary), 0 4px 8px rgba(0,0,0,0.4);">
                                <i class="fas fa-play text-white text-xs sm:text-sm"></i>
                            </div>
                        </div>
                        
                        <!-- Infos de la musique - Layout vertical optimisé -->
                        <div class="flex-1 min-w-0 flex flex-col justify-center gap-1.5">
                            <!-- Titre et Artiste -->
                            <div>
                                <h3 class="text-base sm:text-lg md:text-xl font-bold text-white mb-0.5 line-clamp-2 leading-tight">${fullTitle}</h3>
                                <p class="text-white/70 text-sm sm:text-base line-clamp-1">${fullAuthor}</p>
                            </div>
                            
                            <!-- Badges - Plateforme et Utilisateur -->
                            <div class="flex flex-wrap items-center gap-1.5 sm:gap-2">
                                <!-- Badge Plateforme -->
                                ${platformIcon ? `
                                <div class="inline-flex items-center gap-1.5 px-2 py-1 rounded-lg text-xs sm:text-sm" 
                                     style="background: color-mix(in srgb, ${platformColor} 20%, rgba(0,0,0,0.5)); border: 1.5px solid ${platformColor}; box-shadow: 0 0 10px color-mix(in srgb, ${platformColor} 40%, transparent);">
                                    <i class="${platformIcon}" style="color: ${platformColor}; font-size: 13px;"></i>
                                    <span class="text-white font-semibold">${platformName}</span>
                                </div>` : ''}
                                
                                <!-- Badge Utilisateur -->
                                ${requester ? `
                                <div class="inline-flex items-center gap-1.5 px-2 py-1 rounded-lg text-xs sm:text-sm" 
                                     style="background: color-mix(in srgb, var(--theme-primary) 20%, rgba(0,0,0,0.5)); border: 1.5px solid var(--theme-primary); box-shadow: 0 0 10px color-mix(in srgb, var(--theme-primary) 40%, transparent);">
                                    ${requesterAvatar ? `
                                    <img src="${requesterAvatar}" 
                                         alt="${requesterName}" 
                                         class="w-5 h-5 sm:w-6 sm:h-6 rounded-full object-cover border border-white/30" 
                                         style="box-shadow: 0 0 10px color-mix(in srgb, var(--theme-primary) 60%, transparent);" />
                                    ` : `
                                    <div class="w-5 h-5 sm:w-6 sm:h-6 rounded-full flex items-center justify-center border border-white/30" 
                                         style="background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary)); box-shadow: 0 0 8px var(--theme-primary);">
                                        <i class="fas fa-user text-white text-xs"></i>
                                    </div>
                                    `}
                                    <span class="font-semibold text-white truncate max-w-[100px] sm:max-w-[140px]">${requesterName}</span>
                                </div>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }

            function updateQueue(queue) {
                const container = document.getElementById("queue");
                const count = document.getElementById("queueCount");

                count.textContent = `${queue.length} musique${queue.length !== 1 ? "s" : ""}`;

                if (queue.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-white/40">
                            <i class="fas fa-list-ul text-4xl mb-4 floating-animation"></i>
                            <p class="text-lg mb-1">File d'attente vide</p>
                            <p class="text-sm">Ajoutez des musiques</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = queue
                    .map((track, index) => {
                        // Try multiple property paths for album artwork in queue
                        const artwork =
                            track.info?.artworkUrl ||
                            track.info?.thumbnail ||
                            track.thumbnail ||
                            track.artworkUrl ||
                            track.info?.artwork ||
                            track.artwork ||
                            null;
                        
                        // Détecter la plateforme d'origine
                        let platformIcon = '';
                        let platformColor = '';
                        let platformName = '';
                        const uri = track.info?.uri || track.uri || '';
                        const sourceName = track.info?.sourceName || track.sourceName || '';
                        
                        if (uri.includes('youtube') || sourceName.toLowerCase().includes('youtube')) {
                            platformIcon = 'fab fa-youtube';
                            platformColor = '#FF0000';
                            platformName = 'YouTube';
                        } else if (uri.includes('spotify') || sourceName.toLowerCase().includes('spotify')) {
                            platformIcon = 'fab fa-spotify';
                            platformColor = '#1DB954';
                            platformName = 'Spotify';
                        } else if (uri.includes('soundcloud') || sourceName.toLowerCase().includes('soundcloud')) {
                            platformIcon = 'fab fa-soundcloud';
                            platformColor = '#FF7700';
                            platformName = 'SoundCloud';
                        }
                        
                        const title = track.info?.title || "Titre inconnu";
                        const author = track.info?.author || "Artiste inconnu";
                        const requester = track.info?.requester;
                        const requesterName = requester?.displayName || requester?.tag || 'Dashboard User';
                        
                        return `
                <div class="queue-item p-3 sm:p-4 rounded-xl transition-all duration-300 group mb-2 relative" draggable="true" data-index="${index}">
                    <!-- Croix pour retirer en bas à droite avec couleur du thème -->
                    <button 
                        onclick="removeFromQueueByButton(this)" 
                        class="absolute bottom-2 right-2 w-7 h-7 sm:w-8 sm:h-8 rounded-full flex items-center justify-center text-white hover:scale-110 transition-all z-10"
                        style="background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary)); 
                               box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3), 0 0 10px color-mix(in srgb, var(--theme-primary) 30%, transparent);"
                        title="Retirer de la file">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                    
                    <div class="flex items-center gap-3">
                        <!-- Position Badge - Plus grand sur mobile -->
                        <div class="flex items-center justify-center w-8 h-8 sm:w-9 sm:h-9 text-white font-bold rounded-lg text-sm shrink-0" 
                             style="background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary)); 
                                    box-shadow: 0 0 10px color-mix(in srgb, var(--theme-primary) 30%, transparent);">
                            ${index + 1}
                        </div>
                        
                        <!-- Album Artwork with Neon Border - Plus grand sur mobile -->
                        <div class="w-14 h-14 sm:w-16 sm:h-16 rounded-xl flex items-center justify-center border-2 shrink-0 overflow-hidden" 
                             style="border-color: var(--theme-primary); 
                                    box-shadow: 0 0 12px color-mix(in srgb, var(--theme-primary) 30%, transparent);
                                    background: linear-gradient(135deg, color-mix(in srgb, var(--theme-primary) 15%, transparent), color-mix(in srgb, var(--theme-secondary) 15%, transparent));">
                            ${artwork ? `<img src="${artwork}" alt="Album" class="w-full h-full object-cover">` : `<i class="fas fa-music text-lg" style="color: var(--theme-light);"></i>`}
                        </div>
                        
                        <!-- Track Info -->
                        <div class="flex-1 min-w-0">
                            <!-- Title - Plus grand sur mobile -->
                            <h4 class="font-bold text-white text-sm sm:text-base leading-tight mb-1 line-clamp-1 queue-title-hover" 
                                title="${title}">
                                ${title}
                            </h4>
                            
                            <!-- Artist - Plus grand sur mobile -->
                            <p class="text-white/60 text-xs sm:text-sm leading-tight mb-1.5 line-clamp-1" 
                               title="${author}">
                                ${author}
                            </p>
                            
                            <!-- Platform & Requester on same line avec effets néon -->
                            <div class="flex items-center gap-2 text-xs sm:text-sm">
                                ${platformIcon ? `
                                <span class="inline-flex items-center gap-1 shrink-0" 
                                      style="color: ${platformColor};">
                                    <i class="${platformIcon}" style="font-size: 11px;"></i>
                                </span>` : ''}
                                ${requester ? `
                                <div class="flex items-center gap-1.5 min-w-0">
                                    ${requester.avatar ? `
                                    <img src="${requester.avatar}" 
                                         alt="${requesterName}" 
                                         class="history-avatar-neon w-5 h-5 sm:w-6 sm:h-6 rounded-full object-cover" />
                                    ` : `
                                    <div class="history-avatar-neon w-5 h-5 sm:w-6 sm:h-6 rounded-full flex items-center justify-center" 
                                         style="background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));">
                                        <i class="fas fa-user text-xs text-white"></i>
                                    </div>
                                    `}
                                    <span class="history-username-neon text-xs sm:text-sm truncate">${requesterName}</span>
                                </div>` : ''}
                            </div>
                        </div>
                        
                        <!-- Controls Desktop uniquement - Au hover (seulement monter/descendre) -->
                        <div class="hidden sm:flex items-center gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity shrink-0">
                            <button class="queue-control-btn w-8 h-8 rounded-lg transition-all duration-300 flex items-center justify-center ${index === 0 ? "opacity-30 cursor-not-allowed" : ""}" 
                                    onclick="moveTrackUp(this)" 
                                    ${index === 0 ? 'disabled' : ''}
                                    title="Monter" 
                                    style="background: linear-gradient(135deg, color-mix(in srgb, var(--theme-primary) 15%, transparent), color-mix(in srgb, var(--theme-secondary) 15%, transparent)); 
                                           border: 1px solid color-mix(in srgb, var(--theme-light) 20%, transparent); 
                                           color: var(--theme-light);">
                                <i class="fas fa-arrow-up text-xs"></i>
                            </button>
                            <button class="queue-control-btn w-8 h-8 rounded-lg transition-all duration-300 flex items-center justify-center ${index === queue.length - 1 ? "opacity-30 cursor-not-allowed" : ""}" 
                                    onclick="moveTrackDown(this)" 
                                    ${index === queue.length - 1 ? 'disabled' : ''}
                                    title="Descendre" 
                                    style="background: linear-gradient(135deg, color-mix(in srgb, var(--theme-primary) 15%, transparent), color-mix(in srgb, var(--theme-secondary) 15%, transparent)); 
                                           border: 1px solid color-mix(in srgb, var(--theme-light) 20%, transparent); 
                                           color: var(--theme-light);">
                                <i class="fas fa-arrow-down text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
                    })
                    .join("");

                // Initialize drag and drop functionality after rendering
                initializeDragAndDrop();
                
                // Initialize touch drag and drop for mobile
                initializeTouchDragAndDrop();
            }

            // Drag and Drop functionality
            let draggedElement = null;
            let draggedIndex = null;
            let autoScrollTimer = null;
            let autoScrollSpeed = 0;

            function initializeDragAndDrop() {
                const queueContainer = document.getElementById("queue");
                const queueItems =
                    queueContainer.querySelectorAll(".queue-item");

                queueItems.forEach((item, index) => {
                    // Clean up previous listeners
                    const newItem = item.cloneNode(true);
                    item.parentNode.replaceChild(newItem, item);

                    // Add event listeners to the new item
                    newItem.addEventListener("dragstart", handleDragStart);
                    newItem.addEventListener("dragend", handleDragEnd);
                    newItem.addEventListener("dragover", handleDragOver);
                    newItem.addEventListener("dragenter", handleDragEnter);
                    newItem.addEventListener("dragleave", handleDragLeave);
                    newItem.addEventListener("drop", handleDrop);
                });
            }

            function handleDragStart(e) {
                draggedElement = this;
                draggedIndex = parseInt(this.dataset.index);
                this.classList.add("dragging");
                e.dataTransfer.effectAllowed = "move";
                e.dataTransfer.setData("text/plain", draggedIndex.toString());

                // Mark all other items as potential drop targets
                document.querySelectorAll(".queue-item").forEach((item) => {
                    if (item !== this) {
                        item.classList.add("drag-placeholder");
                    }
                });

                // Start auto-scroll monitoring
                startAutoScroll();
            }

            function handleDragEnd(e) {
                this.classList.remove("dragging");

                // Clean up all drag classes
                document.querySelectorAll(".queue-item").forEach((item) => {
                    item.classList.remove("drag-over", "drag-placeholder");
                });

                // Stop auto-scroll
                stopAutoScroll();

                draggedElement = null;
                draggedIndex = null;
            }

            function handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = "move";
            }

            function handleDragEnter(e) {
                e.preventDefault();
                if (this !== draggedElement && draggedElement) {
                    this.classList.add("drag-over");
                }
            }

            function handleDragLeave(e) {
                // Only remove if we're actually leaving this element
                if (!this.contains(e.relatedTarget)) {
                    this.classList.remove("drag-over");
                }
            }

            function handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();

                if (this !== draggedElement && draggedElement) {
                    const dropIndex = parseInt(this.dataset.index);

                    if (
                        draggedIndex !== null &&
                        dropIndex !== null &&
                        draggedIndex !== dropIndex
                    ) {
                        console.log(
                            `Moving track from ${draggedIndex} to ${dropIndex}`,
                        );
                        moveTrack(draggedIndex, dropIndex);
                    }
                }

                this.classList.remove("drag-over");
                return false;
            }

            // Auto-scroll functions for drag and drop
            function startAutoScroll() {
                if (autoScrollTimer) return;

                autoScrollTimer = setInterval(() => {
                    if (draggedElement && autoScrollSpeed !== 0) {
                        const queueContainer = document.getElementById("queue");
                        queueContainer.scrollTop += autoScrollSpeed;
                    }
                }, 16); // 60 FPS for smooth scrolling

                // Add global mouse move listener to detect scroll zones
                document.addEventListener(
                    "mousemove",
                    handleAutoScrollDetection,
                );
            }

            function stopAutoScroll() {
                if (autoScrollTimer) {
                    clearInterval(autoScrollTimer);
                    autoScrollTimer = null;
                }
                autoScrollSpeed = 0;
                document.removeEventListener(
                    "mousemove",
                    handleAutoScrollDetection,
                );
            }

            function handleAutoScrollDetection(e) {
                if (!draggedElement) return;

                const queueContainer = document.getElementById("queue");
                const containerRect = queueContainer.getBoundingClientRect();
                const scrollZoneSize = 50; // Zone de 50px en haut et en bas
                const maxSpeed = 8; // Vitesse maximale de scroll

                const mouseY = e.clientY;
                const containerTop = containerRect.top;
                const containerBottom = containerRect.bottom;

                // Zone de scroll vers le haut
                if (
                    mouseY >= containerTop &&
                    mouseY <= containerTop + scrollZoneSize
                ) {
                    const intensity =
                        1 - (mouseY - containerTop) / scrollZoneSize;
                    autoScrollSpeed = -maxSpeed * intensity;
                }
                // Zone de scroll vers le bas
                else if (
                    mouseY >= containerBottom - scrollZoneSize &&
                    mouseY <= containerBottom
                ) {
                    const intensity =
                        1 - (containerBottom - mouseY) / scrollZoneSize;
                    autoScrollSpeed = maxSpeed * intensity;
                }
                // Pas de scroll
                else {
                    autoScrollSpeed = 0;
                }
            }

            // Touch Drag and Drop for Mobile
            let touchDragState = {
                element: null,
                index: null,
                holdTimer: null,
                isDragging: false,
                startY: 0,
                currentY: 0,
                scrollTop: 0
            };

            function initializeTouchDragAndDrop() {
                const queueContainer = document.getElementById("queue");
                const queueItems = queueContainer.querySelectorAll(".queue-item");

                queueItems.forEach((item, index) => {
                    // Remove existing touch listeners to avoid duplicates
                    item.removeEventListener("touchstart", handleTouchStart);
                    item.removeEventListener("touchmove", handleTouchMove);
                    item.removeEventListener("touchend", handleTouchEnd);
                    item.removeEventListener("touchcancel", handleTouchCancel);

                    // Add new touch listeners
                    item.addEventListener("touchstart", handleTouchStart, { passive: false });
                    item.addEventListener("touchmove", handleTouchMove, { passive: false });
                    item.addEventListener("touchend", handleTouchEnd, { passive: false });
                    item.addEventListener("touchcancel", handleTouchCancel, { passive: false });
                });
            }

            function handleTouchStart(e) {
                // Don't interfere with button clicks
                if (e.target.closest('button')) {
                    return;
                }

                const item = this;
                const touch = e.touches[0];
                
                touchDragState.element = item;
                touchDragState.index = parseInt(item.dataset.index);
                touchDragState.startY = touch.clientY;
                touchDragState.scrollTop = document.getElementById("queue").scrollTop;

                // Visual feedback for hold
                item.classList.add("touch-holding");

                // Start hold timer (500ms hold to start drag)
                touchDragState.holdTimer = setTimeout(() => {
                    touchDragState.isDragging = true;
                    item.classList.remove("touch-holding");
                    item.classList.add("dragging");
                    
                    // Haptic feedback if available
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }

                    // Mark other items as placeholders
                    document.querySelectorAll(".queue-item").forEach((otherItem) => {
                        if (otherItem !== item) {
                            otherItem.classList.add("drag-placeholder");
                        }
                    });
                }, 500);
            }

            function handleTouchMove(e) {
                if (!touchDragState.element) return;

                const touch = e.touches[0];
                touchDragState.currentY = touch.clientY;
                const deltaY = Math.abs(touchDragState.currentY - touchDragState.startY);

                // If moved before hold timer, cancel the hold
                if (!touchDragState.isDragging && deltaY > 10) {
                    clearTimeout(touchDragState.holdTimer);
                    touchDragState.element.classList.remove("touch-holding");
                    touchDragState.element = null;
                    return;
                }

                // If dragging, prevent scroll and find drop target
                if (touchDragState.isDragging) {
                    e.preventDefault();
                    
                    const queueContainer = document.getElementById("queue");
                    const items = Array.from(queueContainer.querySelectorAll(".queue-item"));
                    
                    // Remove previous drag-over classes
                    items.forEach(item => item.classList.remove("drag-over"));
                    
                    // Find the item under the touch point
                    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                    const dropTarget = elementBelow?.closest(".queue-item");
                    
                    if (dropTarget && dropTarget !== touchDragState.element) {
                        dropTarget.classList.add("drag-over");
                    }

                    // Auto-scroll at edges
                    const containerRect = queueContainer.getBoundingClientRect();
                    const scrollZone = 80;
                    
                    if (touch.clientY < containerRect.top + scrollZone) {
                        queueContainer.scrollTop -= 5;
                    } else if (touch.clientY > containerRect.bottom - scrollZone) {
                        queueContainer.scrollTop += 5;
                    }
                }
            }

            function handleTouchEnd(e) {
                if (!touchDragState.element) return;

                clearTimeout(touchDragState.holdTimer);

                if (touchDragState.isDragging) {
                    e.preventDefault();
                    
                    const touch = e.changedTouches[0];
                    const queueContainer = document.getElementById("queue");
                    const items = Array.from(queueContainer.querySelectorAll(".queue-item"));
                    
                    // Find drop target
                    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                    const dropTarget = elementBelow?.closest(".queue-item");
                    
                    if (dropTarget && dropTarget !== touchDragState.element) {
                        const dropIndex = parseInt(dropTarget.dataset.index);
                        
                        if (touchDragState.index !== dropIndex) {
                            console.log(`Touch moving track from ${touchDragState.index} to ${dropIndex}`);
                            moveTrack(touchDragState.index, dropIndex);
                            
                            // Haptic feedback
                            if (navigator.vibrate) {
                                navigator.vibrate([30, 10, 30]);
                            }
                        }
                    }
                }

                // Clean up
                touchDragState.element.classList.remove("dragging", "touch-holding");
                document.querySelectorAll(".queue-item").forEach((item) => {
                    item.classList.remove("drag-over", "drag-placeholder");
                });

                touchDragState = {
                    element: null,
                    index: null,
                    holdTimer: null,
                    isDragging: false,
                    startY: 0,
                    currentY: 0,
                    scrollTop: 0
                };
            }

            function handleTouchCancel(e) {
                handleTouchEnd(e);
            }

            // Function to move track using the existing API
            async function moveTrack(fromIndex, toIndex) {
                if (!currentGuild) {
                    console.error("Move track error: No guild selected");
                    return;
                }

                try {
                    const response = await fetch(
                        `/api/queue/${currentGuild}/move`,
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${authToken}`,
                            },
                            body: JSON.stringify({
                                fromIndex: fromIndex,
                                toIndex: toIndex,
                            }),
                        },
                    );

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(
                            `Move track failed: ${response.status} - ${errorText}`,
                        );
                        throw new Error(
                            `Move track failed: ${response.status}`,
                        );
                    }

                    const result = await response.json();
                    console.log("Track moved successfully:", result);
                    showNotification(
                        `✓ "${result.track}" déplacé avec succès`,
                        "success",
                    );
                } catch (error) {
                    console.error("Move track error:", error.message || error);
                    showNotification("✗ Erreur lors du déplacement", "error");
                }
            }

            function updateVolume(volume) {
                const slider = document.getElementById("volumeSlider");
                const percentage = document.getElementById("volumePercentage");
                const circleProgress = document.getElementById("volumeCircleProgress");
                const iconDisplay = document.getElementById("volumeIconDisplay");

                slider.value = volume;
                
                if (percentage) {
                    percentage.textContent = `${volume}%`;
                }
                
                // Mettre à jour le cercle de progression
                if (circleProgress) {
                    circleProgress.style.setProperty('--volume-progress', `${volume}%`);
                }
                
                // Changer l'icône selon le niveau de volume
                if (iconDisplay) {
                    if (volume === 0) {
                        iconDisplay.className = 'fas fa-volume-mute volume-icon-display';
                    } else if (volume < 30) {
                        iconDisplay.className = 'fas fa-volume-off volume-icon-display';
                    } else if (volume < 70) {
                        iconDisplay.className = 'fas fa-volume-down volume-icon-display';
                    } else {
                        iconDisplay.className = 'fas fa-volume-up volume-icon-display';
                    }
                }
            }

            function updateProgress(position, duration) {
                if (!duration || duration <= 0) return;

                // Validate position data
                if (typeof position !== "number" || position < 0) {
                    position = 0;
                }

                // Update global position and duration with more precise timing
                currentPosition = position;
                currentDuration = duration;
                lastUpdateTime = performance.now(); // Use high-resolution time

                // Show progress section when music is playing
                const progressSection =
                    document.getElementById("progressSection");
                if (progressSection) {
                    progressSection.classList.remove("hidden");
                }

                const progressBar = document.getElementById("musicProgressBar");

                if (progressBar) {
                    const percentage = Math.min(
                        Math.max((position / duration) * 100, 0),
                        100,
                    );
                    progressBar.style.width = `${percentage}%`;
                }
            }

            // Function to start continuous progress updates
            function startProgressUpdates() {
                if (progressInterval) {
                    clearInterval(progressInterval);
                }

                progressInterval = setInterval(() => {
                    if (
                        currentState &&
                        currentState.current &&
                        !currentState.paused &&
                        currentDuration > 0
                    ) {
                        // Calculate elapsed time since last server update using high-resolution time
                        const now = performance.now();
                        const elapsed = now - lastUpdateTime;
                        const estimatedPosition = currentPosition + elapsed;

                        // Only update if we haven't exceeded the duration and position is reasonable
                        if (
                            estimatedPosition <= currentDuration &&
                            estimatedPosition >= 0
                        ) {
                            const progressBar =
                                document.getElementById("musicProgressBar");

                            if (progressBar) {
                                const percentage = Math.min(
                                    (estimatedPosition / currentDuration) * 100,
                                    100,
                                );
                                progressBar.style.width = `${percentage}%`;
                            }
                        } else if (estimatedPosition > currentDuration) {
                            // Track likely ended, stop updates
                            stopProgressUpdates();
                        }
                    } else {
                        // No valid state, stop updates
                        stopProgressUpdates();
                    }
                }, 200); // Update every 200ms for smooth but efficient progress
            }

            // Function to stop progress updates
            function stopProgressUpdates() {
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
            }

            async function control(action, value = null) {
                if (!currentGuild) {
                    console.error("Control error: No guild selected");
                    return;
                }

                try {
                    const response = await fetch(
                        `/api/controls/${currentGuild}`,
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${authToken}`,
                            },
                            body: JSON.stringify({ action, value }),
                        },
                    );

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(
                            `Control action failed: ${response.status} - ${errorText}`,
                        );
                        throw new Error(
                            `Control action failed: ${response.status}`,
                        );
                    }

                    const result = await response.json();
                    console.log(
                        `Control action '${action}' successful:`,
                        result,
                    );
                } catch (error) {
                    console.error("Control error:", error.message || error);
                }
            }

            // Fonction pour activer/désactiver le loop (rejouer à l'infini)
            let currentLoopMode = "none"; // Peut être "none", "track", ou "queue"
            async function toggleLoop() {
                const btn = document.getElementById('loopBtn');
                const icon = btn.querySelector('i');
                
                if (!currentGuild) {
                    console.error("Loop error: No guild selected");
                    showNotification("Veuillez sélectionner un serveur", "error");
                    return;
                }
                
                try {
                    // Alterner entre "none" et "track" (rejouer la musique actuelle)
                    const newLoopMode = currentLoopMode === "none" ? "track" : "none";
                    
                    // Envoyer la commande loop au serveur avec la valeur
                    await control('loop', newLoopMode);
                    
                    // Mettre à jour l'état local
                    currentLoopMode = newLoopMode;
                    
                    // Mettre à jour l'apparence du bouton
                    if (currentLoopMode === "track") {
                        // État actif : couleur du thème
                        btn.style.background = 'linear-gradient(135deg, var(--theme-primary), var(--theme-secondary))';
                        btn.style.boxShadow = '0 0 20px color-mix(in srgb, var(--theme-primary) 60%, transparent)';
                        icon.style.animation = 'spin 2s linear infinite';
                        console.log('🔁 Loop activé - La musique actuelle va se rejouer à l\'infini');
                        showNotification("🔁 Loop activé", "success");
                    } else {
                        // État inactif : gris
                        btn.style.background = 'linear-gradient(135deg, #6b7280, #4b5563)';
                        btn.style.boxShadow = '';
                        icon.style.animation = '';
                        console.log('⏹️ Loop désactivé');
                        showNotification("⏹️ Loop désactivé", "info");
                    }
                } catch (error) {
                    console.error('❌ Erreur lors du toggle loop:', error);
                    showNotification("Erreur lors de l'activation du loop", "error");
                }
            }
            
            // Ajouter l'animation de rotation pour l'icône
            if (!document.getElementById('loopIconAnimation')) {
                const style = document.createElement('style');
                style.id = 'loopIconAnimation';
                style.textContent = `
                    @keyframes spin {
                        from { transform: rotate(0deg); }
                        to { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }

            // Fonction pour rejoindre le canal vocal
            let isInVoice = false;
            async function joinVoiceChannel() {
                const btn = document.getElementById('joinVoiceBtn');
                const btnText = document.getElementById('joinVoiceText');
                const btnIcon = btn.querySelector('i');
                
                if (!currentGuild) {
                    console.error("Join voice error: No guild selected");
                    return;
                }
                
                // Toggle l'état
                isInVoice = !isInVoice;
                
                if (isInVoice) {
                    // Rejoindre le vocal
                    btnIcon.className = 'fas fa-phone-slash';
                    btnText.textContent = 'Quitter le vocal';
                    btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    
                    try {
                        await control('joinVoice');
                        console.log('✅ Bot rejoint le canal vocal');
                    } catch (error) {
                        console.error('❌ Erreur lors de la connexion au vocal:', error);
                        // Revenir à l'état précédent en cas d'erreur
                        isInVoice = false;
                        btnIcon.className = 'fas fa-microphone';
                        btnText.textContent = 'Rejoindre le vocal';
                        btn.style.background = 'linear-gradient(135deg, var(--theme-primary), var(--theme-secondary))';
                    }
                } else {
                    // Quitter le vocal
                    btnIcon.className = 'fas fa-microphone';
                    btnText.textContent = 'Rejoindre le vocal';
                    btn.style.background = 'linear-gradient(135deg, var(--theme-primary), var(--theme-secondary))';
                    
                    try {
                        await control('leaveVoice');
                        console.log('✅ Bot a quitté le canal vocal');
                    } catch (error) {
                        console.error('❌ Erreur lors de la déconnexion du vocal:', error);
                    }
                }
            }

            // Function to detect if query is a YouTube URL
            function isYouTubeURL(query) {
                const youtubeRegex =
                    /^(https?\:\/\/)?(www\.youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/|youtube\.com\/watch\?v=|m\.youtube\.com\/watch\?v=).+/;
                return youtubeRegex.test(query);
            }

            async function searchMusic() {
                const query = document
                    .getElementById("searchInput")
                    .value.trim();
                if (!query) return;

                // Show loading state
                const container = document.getElementById("searchResults");
                container.innerHTML = `
                    <div class="text-center py-8 text-white/60">
                        <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                        <p>Recherche avancée en cours...</p>
                        <p class="text-sm mt-2 text-white/40">Analyse de ${isYouTubeURL(query) ? "votre lien YouTube" : "YouTube, Spotify & SoundCloud"}</p>
                    </div>
                `;

                try {
                    let searchPromises = [];

                    // If it's a YouTube URL, search it directly
                    if (isYouTubeURL(query)) {
                        searchPromises.push(
                            fetch("/api/search", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${authToken}`,
                                },
                                body: JSON.stringify({
                                    query: query, // Direct YouTube URL
                                    platform: "youtube",
                                    isDirectLink: true,
                                }),
                            }),
                        );
                    } else {
                        // Enhanced search across multiple platforms with more results
                        searchPromises = [
                            // YouTube search with more results
                            fetch("/api/search", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${authToken}`,
                                },
                                body: JSON.stringify({
                                    query: `ytsearch50:${query}`, // Demander 50 résultats YouTube
                                    platform: "youtube",
                                }),
                            }),
                            // Spotify search with more results
                            fetch("/api/search", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${authToken}`,
                                },
                                body: JSON.stringify({
                                    query: `spsearch50:${query}`, // Demander 50 résultats Spotify
                                    platform: "spotify",
                                }),
                            }),
                            // SoundCloud with less results but still more than before
                            fetch("/api/search", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${authToken}`,
                                },
                                body: JSON.stringify({
                                    query: `scsearch15:${query}`,
                                    platform: "soundcloud",
                                }),
                            }),
                        ];
                    }

                    const responses = await Promise.allSettled(searchPromises);
                    let allTracks = [];

                    // Combine results from all platforms
                    for (const response of responses) {
                        if (
                            response.status === "fulfilled" &&
                            response.value.ok
                        ) {
                            const data = await response.value.json();
                            if (data.tracks && data.tracks.length > 0) {
                                allTracks = allTracks.concat(data.tracks);
                            }
                        }
                    }

                    // For direct YouTube links, don't limit results
                    // For searches, show way more results (up to 80)
                    if (!isYouTubeURL(query)) {
                        // Prioritize YouTube and Spotify results, mix them
                        const youtubeResults = allTracks
                            .filter((t) => t.source === "YouTube")
                            .slice(0, 35);
                        const spotifyResults = allTracks
                            .filter((t) => t.source === "Spotify")
                            .slice(0, 35);
                        const soundcloudResults = allTracks
                            .filter((t) => t.source === "SoundCloud")
                            .slice(0, 10);

                        // Merge them with YouTube and Spotify getting priority
                        allTracks = [
                            ...youtubeResults,
                            ...spotifyResults,
                            ...soundcloudResults,
                        ];
                    }

                    displaySearchResults(allTracks);
                } catch (error) {
                    console.error("Search error:", error);
                    container.innerHTML = `
                        <div class="text-center py-8 text-red-400">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <p>Erreur de recherche</p>
                            <p class="text-sm mt-2 text-white/40">Veuillez réessayer</p>
                        </div>
                    `;
                }
            }

            function displaySearchResults(tracks) {
                const container = document.getElementById("searchResults");
                searchResults = tracks; // Store results globally

                if (!tracks || tracks.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-white/40">
                            <i class="fas fa-search text-4xl mb-4"></i>
                            <p>Aucun résultat trouvé</p>
                            <p class="text-sm mt-2">Essayez une autre recherche</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = tracks
                    .map(
                        (track, index) => `
                    <div class="flex items-center space-x-4 p-4 bg-white/5 border border-white/10 rounded-xl hover:bg-white/10 transition-all duration-300 group cursor-pointer" 
                         onclick="addToQueue(${index})"
                         data-track-index="${index}">
                        <div class="w-16 h-16 bg-gradient-to-br from-purple-500/20 to-cyan-500/20 rounded-xl flex items-center justify-center border border-white/10 group-hover:scale-105 transition-transform">
                            ${track.thumbnail ? `<img src="${track.thumbnail}" alt="Thumbnail" class="w-full h-full object-cover rounded-xl">` : `<i class="fas fa-music text-red-400 text-xl"></i>`}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between mb-1">
                                <p class="font-semibold text-white truncate group-hover:text-red-300 transition-colors">${track.title || "Titre inconnu"}</p>
                                <div class="flex items-center space-x-1 text-xs shrink-0 ml-2">
                                    ${getPlatformIcon(track.source || track.platform || "Unknown")}
                                    <span class="text-white/50">${track.source || track.platform || "Unknown"}</span>
                                </div>
                            </div>
                            <p class="text-sm text-white/60 truncate">${track.author || "Artiste inconnu"}</p>
                            <p class="text-xs text-white/40 mt-1">${formatDuration(track.duration || 0)}</p>
                        </div>
                        <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                            <div class="btn-primary p-3 rounded-lg">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                    </div>
                `,
                    )
                    .join("");
            }

            function displayPlaylistResults(playlists) {
                const container = document.getElementById("searchResults");
                searchResults = playlists; // Store results globally

                if (!playlists || playlists.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-white/40">
                            <i class="fas fa-list-music text-4xl mb-4"></i>
                            <p>Aucune playlist trouvée</p>
                            <p class="text-sm mt-2">Essayez une autre recherche</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = playlists
                    .map(
                        (playlist, index) => `
                    <div class="flex items-center space-x-4 p-4 bg-white/5 border border-white/10 rounded-xl hover:bg-white/10 transition-all duration-300 group cursor-pointer" 
                         onclick="addPlaylistToQueue('${playlist.uri || playlist.url}')"
                         data-playlist-index="${index}">
                        <div class="w-16 h-16 bg-gradient-to-br from-green-500/20 to-blue-500/20 rounded-xl flex items-center justify-center border border-white/10 group-hover:scale-105 transition-transform">
                            ${playlist.thumbnail ? `<img src="${playlist.thumbnail}" alt="Playlist thumbnail" class="w-full h-full object-cover rounded-xl">` : `<i class="fas fa-list-music text-green-400 text-xl"></i>`}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-white truncate group-hover:text-green-300 transition-colors">${playlist.title || "Playlist"}</p>
                            <p class="text-sm text-white/60 truncate mt-1">${playlist.author || "Auteur inconnu"}</p>
                            <p class="text-xs text-white/40 mt-1">Playlist • ${playlist.tracks || 0} musiques</p>
                        </div>
                        <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                            <div class="bg-gradient-to-r from-green-500 to-blue-500 p-3 rounded-lg">
                                <i class="fas fa-plus-circle"></i>
                            </div>
                        </div>
                    </div>
                `,
                    )
                    .join("");
            }

            async function addToQueue(index) {
                if (!currentGuild || !searchResults[index]) return;

                const track = searchResults[index];

                // Find the button for this track
                const trackElement = document.querySelector(
                    `[data-track-index="${index}"]`,
                );
                const originalOnClick = trackElement?.getAttribute("onclick");
                const originalInnerHTML = trackElement?.innerHTML;

                try {
                    // Change button to "Ajouté" state during request
                    if (trackElement) {
                        trackElement.style.pointerEvents = "none";
                        trackElement.style.opacity = "0.6";
                        trackElement.innerHTML = `
                            <div class="w-16 h-16 bg-gradient-to-br from-green-500/20 to-green-600/20 rounded-xl flex items-center justify-center border border-green-400/30 group-hover:scale-105 transition-transform">
                                <i class="fas fa-check text-green-400 text-xl"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-green-400 truncate">${track.title || "Titre inconnu"}</p>
                                <p class="text-sm text-green-300/60 truncate mt-1">${track.author || "Artiste inconnu"}</p>
                                <p class="text-xs text-green-200/40 mt-1">✓ Ajouté à la playlist</p>
                            </div>
                            <div class="flex items-center">
                                <div class="bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg font-medium">
                                    <i class="fas fa-check mr-2"></i>Ajouté
                                </div>
                            </div>
                        `;
                        trackElement.removeAttribute("onclick");
                    }

                    const response = await fetch(
                        `/api/queue/${currentGuild}/add`,
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${authToken}`,
                            },
                            body: JSON.stringify({
                                encoded: track.encoded,
                                title: track.title,
                                author: track.author,
                                thumbnail: track.thumbnail,
                                duration: track.duration,
                                uri: track.uri,
                            }),
                        },
                    );

                    if (response.ok) {
                        showNotification(
                            "✓ Musique ajoutée à la file",
                            "success",
                        );

                        // Start cooldown timer (3 seconds)
                        setTimeout(() => {
                            if (
                                trackElement &&
                                originalInnerHTML &&
                                originalOnClick
                            ) {
                                trackElement.innerHTML = originalInnerHTML;
                                trackElement.setAttribute(
                                    "onclick",
                                    originalOnClick,
                                );
                                trackElement.style.pointerEvents = "auto";
                                trackElement.style.opacity = "1";
                            }
                        }, 3000);
                    } else {
                        // Restore button immediately on error
                        if (
                            trackElement &&
                            originalInnerHTML &&
                            originalOnClick
                        ) {
                            trackElement.innerHTML = originalInnerHTML;
                            trackElement.setAttribute(
                                "onclick",
                                originalOnClick,
                            );
                            trackElement.style.pointerEvents = "auto";
                            trackElement.style.opacity = "1";
                        }
                        console.error(
                            "Failed to add track to queue:",
                            response.statusText,
                        );
                        showNotification("✗ Erreur lors de l'ajout", "error");
                    }
                } catch (error) {
                    // Restore button immediately on error
                    if (trackElement && originalInnerHTML && originalOnClick) {
                        trackElement.innerHTML = originalInnerHTML;
                        trackElement.setAttribute("onclick", originalOnClick);
                        trackElement.style.pointerEvents = "auto";
                        trackElement.style.opacity = "1";
                    }
                    console.error("Add to queue error:", error);
                    showNotification("✗ Erreur lors de l'ajout", "error");
                }
            }

            async function addPlaylistToQueue(playlistUrl) {
                if (!currentGuild || !playlistUrl) return;

                try {
                    const response = await fetch(
                        `/api/queue/${currentGuild}/add`,
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${authToken}`,
                            },
                            body: JSON.stringify({
                                uri: playlistUrl,
                                isPlaylist: true,
                            }),
                        },
                    );

                    if (response.ok) {
                        showNotification(
                            "✓ Playlist ajoutée à la file",
                            "success",
                        );
                        // Clear search results
                        document.getElementById("searchResults").innerHTML = "";
                        document.getElementById("searchInput").value = "";
                        searchResults = [];
                    } else {
                        console.error(
                            "Failed to add playlist to queue:",
                            response.statusText,
                        );
                        showNotification(
                            "✗ Erreur lors de l'ajout de la playlist",
                            "error",
                        );
                    }
                } catch (error) {
                    console.error("Add playlist to queue error:", error);
                    showNotification(
                        "✗ Erreur lors de l'ajout de la playlist",
                        "error",
                    );
                }
            }

            function formatDuration(duration) {
                // Si c'est déjà une chaîne (YouTube retourne "3:45"), la retourner directement
                if (typeof duration === 'string' && duration.includes(':')) {
                    return duration;
                }
                
                // Sinon, c'est en millisecondes (SoundCloud, Spotify), on la formate
                const ms = parseInt(duration);
                if (isNaN(ms) || ms <= 0) {
                    return "—";
                }
                
                const minutes = Math.floor(ms / 60000);
                const seconds = Math.floor((ms % 60000) / 1000);
                return `${minutes}:${seconds.toString().padStart(2, "0")}`;
            }

            // Remove from queue function
            async function removeFromQueue(index) {
                if (!currentGuild) return;

                try {
                    const response = await fetch(
                        `/api/queue/${currentGuild}/remove`,
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${authToken}`,
                            },
                            body: JSON.stringify({ index }),
                        },
                    );

                    if (response.ok) {
                        showNotification(
                            "✓ Musique supprimée de la file",
                            "success",
                        );
                    } else {
                        throw new Error("Failed to remove track");
                    }
                } catch (error) {
                    console.error("Remove from queue error:", error);
                    showNotification(
                        "✗ Erreur lors de la suppression",
                        "error",
                    );
                }
            }

            // Move track in queue function
            async function moveTrack(fromIndex, toIndex) {
                if (!currentGuild) return;

                try {
                    const response = await fetch(
                        `/api/queue/${currentGuild}/move`,
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${authToken}`,
                            },
                            body: JSON.stringify({ fromIndex, toIndex }),
                        },
                    );

                    if (response.ok) {
                        showNotification("✓ Musique déplacée", "success");
                    } else {
                        throw new Error("Failed to move track");
                    }
                } catch (error) {
                    console.error("Move track error:", error);
                    showNotification("✗ Erreur lors du déplacement", "error");
                }
            }

            // New functions that dynamically calculate the current index
            function moveTrackUp(button) {
                const queueItem = button.closest(".queue-item");
                const queueContainer = document.getElementById("queue");
                const allItems = Array.from(
                    queueContainer.querySelectorAll(".queue-item"),
                );
                const currentIndex = allItems.indexOf(queueItem);

                if (currentIndex > 0) {
                    moveTrack(currentIndex, currentIndex - 1);
                }
            }

            function moveTrackDown(button) {
                const queueItem = button.closest(".queue-item");
                const queueContainer = document.getElementById("queue");
                const allItems = Array.from(
                    queueContainer.querySelectorAll(".queue-item"),
                );
                const currentIndex = allItems.indexOf(queueItem);

                if (currentIndex < allItems.length - 1) {
                    moveTrack(currentIndex, currentIndex + 1);
                }
            }

            // Dynamic remove function that calculates current index
            function removeFromQueueByButton(button) {
                const queueItem = button.closest(".queue-item");
                const queueContainer = document.getElementById("queue");
                const allItems = Array.from(
                    queueContainer.querySelectorAll(".queue-item"),
                );
                const currentIndex = allItems.indexOf(queueItem);

                if (currentIndex >= 0) {
                    removeFromQueue(currentIndex);
                }
            }

            // Show notification function with improved styling (sans flou)
            function showNotification(message, type) {
                const notification = document.createElement("div");
                // Position discrète sur mobile : bas à droite, plus petite
                const isMobile = window.innerWidth < 768;
                const positionClass = isMobile ? "bottom-4 right-4" : "top-4 right-4";
                const sizeClass = isMobile ? "p-2 text-xs max-w-[200px]" : "p-4";
                notification.className = `fixed ${positionClass} ${sizeClass} rounded-xl shadow-2xl transition-all duration-500 transform translate-x-full border`;
                notification.style.zIndex = "9999999";
                if (isMobile) {
                    notification.style.opacity = "0.9";
                }

                if (type === "success") {
                    // Utiliser les couleurs du thème actuel au lieu du vert
                    const currentTheme = localStorage.getItem("zgmusicGradientTheme") || "red";
                    const themeConfig = gradientThemes[currentTheme];
                    
                    notification.style.background = `linear-gradient(to right, ${themeConfig.primary}, ${themeConfig.secondary})`;
                    notification.style.borderColor = `${themeConfig.primary}40`;
                    notification.className += " text-white";
                    notification.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0" style="background: ${themeConfig.light};">
                                <i class="fas fa-check text-white text-xs"></i>
                            </div>
                            <span class="font-medium">${message}</span>
                        </div>
                    `;
                } else {
                    notification.className +=
                        " bg-gradient-to-r from-red-500 to-red-600 text-white border-red-400/30";
                    notification.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <div class="w-6 h-6 bg-red-400 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-exclamation text-red-900 text-xs"></i>
                            </div>
                            <span class="font-medium">${message}</span>
                        </div>
                    `;
                }

                document.body.appendChild(notification);

                // Animate in
                setTimeout(() => {
                    notification.classList.remove("translate-x-full");
                    notification.classList.add("scale-105");
                    setTimeout(() => {
                        notification.classList.remove("scale-105");
                    }, 200);
                }, 100);

                // Remove after 4 seconds
                setTimeout(() => {
                    notification.classList.add(
                        "translate-x-full",
                        "scale-95",
                        "opacity-0",
                    );
                    setTimeout(() => {
                        if (notification.parentNode) {
                            document.body.removeChild(notification);
                        }
                    }, 500);
                }, 4000);
            }

            // Update volume display
            function updateVolumeDisplay(value) {
                const percentage = document.getElementById("volumePercentage");
                const circleProgress = document.getElementById("volumeCircleProgress");
                const iconDisplay = document.getElementById("volumeIconDisplay");
                
                if (percentage) {
                    percentage.textContent = value + "%";
                }
                
                // Mettre à jour le cercle de progression
                if (circleProgress) {
                    circleProgress.style.setProperty('--volume-progress', `${value}%`);
                }
                
                // Changer l'icône selon le niveau de volume
                if (iconDisplay) {
                    const vol = parseInt(value);
                    if (vol === 0) {
                        iconDisplay.className = 'fas fa-volume-mute volume-icon-display';
                    } else if (vol < 30) {
                        iconDisplay.className = 'fas fa-volume-off volume-icon-display';
                    } else if (vol < 70) {
                        iconDisplay.className = 'fas fa-volume-down volume-icon-display';
                    } else {
                        iconDisplay.className = 'fas fa-volume-up volume-icon-display';
                    }
                }
            }

            // Add volume adjustment function
            function adjustVolume(delta) {
                const slider = document.getElementById("volumeSlider");
                const currentVolume = parseInt(slider.value);
                const newVolume = Math.max(
                    0,
                    Math.min(100, currentVolume + delta),
                );

                slider.value = newVolume;
                updateVolumeDisplay(newVolume);
                control("volume", newVolume);

                // Show a subtle feedback
                showNotification(`Volume: ${newVolume}%`, "success");
            }

            // Interactive circular volume control with rotation
            (function initVolumeCircularControl() {
                const volumeCircular = document.getElementById('volumeCircular');
                if (!volumeCircular) return;

                let isInteracting = false;
                let lastAngle = null;
                let startVolume = 100;
                let lastNotificationTime = 0;
                const notificationThrottle = 500; // ms

                // Calculate angle from center
                function getAngleFromCenter(clientX, clientY, rect) {
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    const deltaX = clientX - centerX;
                    const deltaY = clientY - centerY;
                    
                    // Calculate angle in degrees (0° = top, clockwise)
                    let angle = Math.atan2(deltaY, deltaX) * (180 / Math.PI);
                    angle = (angle + 90 + 360) % 360; // Normalize to 0-360, starting from top
                    
                    return angle;
                }

                // Convert angle to volume (0-150)
                function angleToVolume(angle) {
                    // Map 360 degrees to 0-150 volume
                    return Math.round((angle / 360) * 150);
                }

                // Start interaction
                function startInteraction(clientX, clientY) {
                    isInteracting = true;
                    volumeCircular.classList.add('interacting', 'rotating');
                    
                    const slider = document.getElementById("volumeSlider");
                    startVolume = parseInt(slider.value);
                    
                    const rect = volumeCircular.getBoundingClientRect();
                    lastAngle = getAngleFromCenter(clientX, clientY, rect);
                }

                // Update volume during interaction
                function updateInteraction(clientX, clientY) {
                    if (!isInteracting) return;
                    
                    const rect = volumeCircular.getBoundingClientRect();
                    const currentAngle = getAngleFromCenter(clientX, clientY, rect);
                    
                    if (lastAngle !== null) {
                        // Calculate angle delta
                        let angleDelta = currentAngle - lastAngle;
                        
                        // Handle wrap-around
                        if (angleDelta > 180) angleDelta -= 360;
                        if (angleDelta < -180) angleDelta += 360;
                        
                        // Sensitivity: 2.4 degrees per volume unit (360 / 150)
                        const volumeDelta = Math.round(angleDelta / 2.4);
                        
                        if (volumeDelta !== 0) {
                            const slider = document.getElementById("volumeSlider");
                            const currentVolume = parseInt(slider.value);
                            const newVolume = Math.max(0, Math.min(150, currentVolume + volumeDelta));
                            
                            slider.value = newVolume;
                            updateVolumeDisplay(newVolume);
                            
                            lastAngle = currentAngle;
                        }
                    }
                }

                // End interaction
                function endInteraction() {
                    if (!isInteracting) return;
                    
                    isInteracting = false;
                    volumeCircular.classList.remove('interacting', 'rotating');
                    
                    const slider = document.getElementById("volumeSlider");
                    const finalVolume = parseInt(slider.value);
                    
                    // Send volume to server
                    control("volume", finalVolume);
                    
                    // Show notification (throttled)
                    const now = Date.now();
                    if (now - lastNotificationTime > notificationThrottle) {
                        showNotification(`Volume: ${finalVolume}%`, "success");
                        lastNotificationTime = now;
                    }
                    
                    lastAngle = null;
                }

                // Touch events
                volumeCircular.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    startInteraction(touch.clientX, touch.clientY);
                });

                volumeCircular.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    updateInteraction(touch.clientX, touch.clientY);
                });

                volumeCircular.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    endInteraction();
                });

                volumeCircular.addEventListener('touchcancel', (e) => {
                    e.preventDefault();
                    endInteraction();
                });

                // Mouse events (desktop)
                volumeCircular.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    startInteraction(e.clientX, e.clientY);
                });

                document.addEventListener('mousemove', (e) => {
                    if (isInteracting) {
                        e.preventDefault();
                        updateInteraction(e.clientX, e.clientY);
                    }
                });

                document.addEventListener('mouseup', (e) => {
                    if (isInteracting) {
                        e.preventDefault();
                        endInteraction();
                    }
                });
            })();

            // Add missing showDashboard function
            function showDashboard() {
                document
                    .getElementById("guildSelection")
                    .classList.add("hidden");
                document.getElementById("dashboard").classList.remove("hidden");
                
                // Afficher le bouton de recherche dans le dashboard
                const searchButton = document.getElementById("searchButton");
                if (searchButton) {
                    searchButton.classList.remove("hidden");
                }

                // Auto-load demo state for development mode
                if (currentGuild === "demo") {
                    updateUI(null);
                    updateQueue([]);
                }
            }

            // Add restart bot function
            async function restartBot() {
                if (
                    !confirm(
                        "Êtes-vous sûr de vouloir redémarrer le bot ? Cette action interrompra temporairement tous les services.",
                    )
                ) {
                    return;
                }

                try {
                    const button = event.target.closest("button");
                    const originalHTML = button.innerHTML;

                    // Show loading state
                    button.innerHTML =
                        '<i class="fas fa-spinner fa-spin text-xs sm:text-sm"></i><span class="hidden sm:inline">Redémarrage...</span>';
                    button.disabled = true;

                    const response = await fetch("/api/restart", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });

                    if (response.ok) {
                        showNotification(
                            "Bot redémarré avec succès !",
                            "success",
                        );

                        // Reset button after successful restart - no page reload
                        setTimeout(() => {
                            button.innerHTML = originalHTML;
                            button.disabled = false;
                        }, 3000);
                    } else {
                        throw new Error("Échec du redémarrage");
                    }
                } catch (error) {
                    console.error("Error restarting bot:", error);
                    showNotification(
                        "Erreur lors du redémarrage du bot",
                        "error",
                    );

                    // Reset button
                    const button = event.target.closest("button");
                    if (button) {
                        button.innerHTML =
                            '<i class="fas fa-redo text-xs sm:text-sm"></i><span class="hidden sm:inline">Redémarrer</span>';
                        button.disabled = false;
                    }
                }
            }

            // Add clear queue function
            async function clearQueue() {
                if (
                    !currentGuild ||
                    !confirm(
                        "Êtes-vous sûr de vouloir vider toute la file d'attente ?",
                    )
                ) {
                    return;
                }

                try {
                    const response = await fetch(
                        `/api/queue/${currentGuild}/clear`,
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                        },
                    );

                    if (response.ok) {
                        showNotification("File d'attente vidée !", "success");
                    } else {
                        throw new Error("Erreur lors du vidage de la file");
                    }
                } catch (error) {
                    console.error("Error clearing queue:", error);
                    showNotification(
                        "Erreur lors du vidage de la file d'attente",
                        "error",
                    );
                }
            }

            // Add join voice channel function
            async function joinVoiceChannel() {
                if (!currentGuild) {
                    showNotification(
                        "Veuillez sélectionner un serveur",
                        "error",
                    );
                    return;
                }

                try {
                    const button = document.getElementById("joinBtn");
                    const originalHTML = button.innerHTML;

                    // Show loading state
                    button.innerHTML =
                        '<i class="fas fa-spinner fa-spin mr-2"></i>Connexion...';
                    button.disabled = true;

                    const response = await fetch(`/api/join/${currentGuild}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({}),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showNotification(
                            `Bot connecté au canal vocal : ${data.voiceChannel?.name || "Canal vocal"}`,
                            "success",
                        );
                    } else {
                        showNotification(
                            data.error || "Erreur lors de la connexion",
                            "error",
                        );
                    }

                    // Reset button
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.disabled = false;
                    }, 2000);
                } catch (error) {
                    console.error("Join voice channel error:", error);
                    showNotification(
                        "Erreur lors de la connexion au canal vocal",
                        "error",
                    );

                    // Reset button
                    const button = document.getElementById("joinBtn");
                    button.innerHTML =
                        '<i class="fas fa-volume-up mr-2"></i>Faire rejoindre le bot';
                    button.disabled = false;
                }
            }

            // Function to join voice channel for a specific guild from guild selection
            async function joinVoiceChannelForGuild(guildId) {
                // Find the button to show loading state
                const button =
                    event?.target ||
                    document.querySelector(`button[onclick*="${guildId}"]`);
                const originalHTML = button?.innerHTML;

                try {
                    // Show loading state
                    if (button) {
                        button.innerHTML =
                            '<i class="fas fa-spinner fa-spin mr-2"></i>Connexion...';
                        button.disabled = true;
                    }

                    showNotification(
                        "Connexion au canal vocal en cours...",
                        "info",
                    );

                    const response = await fetch(`/api/join/${guildId}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${authToken}`,
                        },
                        body: JSON.stringify({}),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showNotification(
                            `🎵 Bot connecté au canal vocal "${data.voiceChannel?.name || "vocal"}" ! Le dashboard est maintenant disponible.`,
                            "success",
                        );

                        // Update button to success state
                        if (button) {
                            button.innerHTML =
                                '<i class="fas fa-check mr-2"></i>Connecté !';
                            button.className =
                                "w-full mt-3 bg-gradient-to-r from-green-500 to-green-600 text-white py-2 px-4 rounded-lg transition-all duration-300 font-medium text-sm";
                        }

                        // Reload guilds to update the status after 2 seconds
                        setTimeout(() => {
                            showGuildSelection();
                        }, 2000);
                    } else {
                        showNotification(
                            data.error ||
                                "Erreur lors de la connexion au canal vocal",
                            "error",
                        );

                        // Restore button on error
                        if (button && originalHTML) {
                            button.innerHTML = originalHTML;
                            button.disabled = false;
                        }
                    }
                } catch (error) {
                    console.error("Join voice channel error:", error);
                    showNotification(
                        "Erreur lors de la connexion au canal vocal",
                        "error",
                    );

                    // Restore button on error
                    if (button && originalHTML) {
                        button.innerHTML = originalHTML;
                        button.disabled = false;
                    }
                }
            }

            // === POPUP DE BIENVENUE ===
            function closeWelcomePopup() {
                const popup = document.getElementById("welcomePopup");
                popup.classList.add("hidden");

                // Sauvegarder que l'utilisateur a vu le popup
                localStorage.setItem("zgmusicPopupSeen", "true");
            }

            // === SÉLECTEUR DE COULEUR DE DÉGRADÉ ===
            function toggleColorPicker() {
                const menu = document.getElementById("colorPickerMenu");
                const btn = document.getElementById("colorPickerBtn");
                
                if (menu.classList.contains("hidden")) {
                    // Positionner le menu correctement au-dessus de tout
                    const rect = btn.getBoundingClientRect();
                    menu.style.top = (rect.bottom + 10) + "px";
                    menu.style.right = (window.innerWidth - rect.right) + "px";
                    menu.style.left = "auto";
                    // S'assurer que le z-index est bien appliqué
                    menu.style.zIndex = "999999";
                    menu.style.position = "fixed";
                }
                
                menu.classList.toggle("hidden");
            }

            // Fermer le menu si on clique ailleurs (mais pas sur le menu utilisateur)
            document.addEventListener("click", (e) => {
                const btn = document.getElementById("colorPickerBtn");
                const menu = document.getElementById("colorPickerMenu");
                const userProfile = document.getElementById("userProfile");
                const userMenu = document.getElementById("userDropdownMenu");
                
                // Ne pas fermer si on clique sur le menu utilisateur
                const clickOnUserMenu = userProfile?.contains(e.target) || userMenu?.contains(e.target);
                
                if (!btn?.contains(e.target) && !menu?.contains(e.target) && !clickOnUserMenu) {
                    menu?.classList.add("hidden");
                }
            });

            const gradientThemes = {
                red: {
                    gradient: "linear-gradient(45deg, #7f1d1d, #991b1b, #dc2626, #ef4444, #dc2626, #991b1b, #7f1d1d)",
                    particle: "rgba(220, 38, 38, 0.8)",
                    primary: "#dc2626",
                    secondary: "#991b1b",
                    light: "#ef4444",
                    dark: "#7f1d1d",
                    logo: "zg-logo-silver.png",
                    pickerColor: "from-red-600 to-red-800 hover:from-red-700 hover:to-red-900"
                },
                blue: {
                    gradient: "linear-gradient(45deg, #1e3a8a, #1e40af, #2563eb, #3b82f6, #2563eb, #1e40af, #1e3a8a)",
                    particle: "rgba(37, 99, 235, 0.8)",
                    primary: "#2563eb",
                    secondary: "#1e40af",
                    light: "#3b82f6",
                    dark: "#1e3a8a",
                    logo: "zg-logo-silver.png",
                    pickerColor: "from-red-600 to-red-800 hover:from-red-700 hover:to-red-900"
                }
            };

            function changeGradient(theme) {
                const config = gradientThemes[theme];
                if (!config) return;

                // Mettre à jour le fond
                const bg = document.querySelector(".animated-background");
                if (bg) {
                    bg.style.background = config.gradient;
                    bg.style.backgroundSize = "400% 400%";
                }

                // Mettre à jour le logo
                const logo = document.getElementById("themeLogo");
                if (logo && config.logo) {
                    logo.src = config.logo;
                }

                // Mettre à jour le bouton de sélection de couleur avec la couleur du thème
                const colorPickerBtn = document.getElementById("colorPickerBtn");
                if (colorPickerBtn) {
                    if (theme === 'blue') {
                        colorPickerBtn.className = "bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white px-4 py-3 sm:px-6 sm:py-4 rounded-full transition-all duration-300 font-medium text-base sm:text-lg flex items-center space-x-2 sm:space-x-3 shadow-lg hover:shadow-xl hover:scale-105";
                    } else {
                        colorPickerBtn.className = "bg-gradient-to-r from-red-600 to-red-800 hover:from-red-700 hover:to-red-900 text-white px-4 py-3 sm:px-6 sm:py-4 rounded-full transition-all duration-300 font-medium text-base sm:text-lg flex items-center space-x-2 sm:space-x-3 shadow-lg hover:shadow-xl hover:scale-105";
                    }
                }

                // Mettre à jour les indicateurs de thème actif
                const redCheck = document.getElementById('theme-red-check');
                const blueCheck = document.getElementById('theme-blue-check');
                const redBtn = document.getElementById('theme-red-btn');
                const blueBtn = document.getElementById('theme-blue-btn');
                
                if (theme === 'red') {
                    if (redCheck) redCheck.style.opacity = '1';
                    if (blueCheck) blueCheck.style.opacity = '0';
                    if (redBtn) redBtn.style.borderColor = 'rgba(239, 68, 68, 0.8)';
                    if (blueBtn) blueBtn.style.borderColor = 'rgba(59, 130, 246, 0.3)';
                } else if (theme === 'blue') {
                    if (redCheck) redCheck.style.opacity = '0';
                    if (blueCheck) blueCheck.style.opacity = '1';
                    if (redBtn) redBtn.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                    if (blueBtn) blueBtn.style.borderColor = 'rgba(59, 130, 246, 0.8)';
                }

                // Mettre à jour les variables CSS pour changer TOUT le thème
                const root = document.documentElement;
                root.style.setProperty('--theme-primary', config.primary);
                root.style.setProperty('--theme-secondary', config.secondary);
                root.style.setProperty('--theme-light', config.light);
                root.style.setProperty('--theme-dark', config.dark);
                root.style.setProperty('--theme-particle', config.particle);

                // Mettre à jour tous les boutons et éléments dynamiquement
                updateThemeElements(config);

                toggleColorPicker();
                localStorage.setItem("zgmusicGradientTheme", theme);
            }

            function updateThemeElements(config) {
                // Mettre à jour les particules
                const particles = document.querySelectorAll('.particle');
                particles.forEach(p => {
                    p.style.background = `radial-gradient(circle, ${config.particle} 0%, ${config.particle.replace('0.8', '0.2')} 50%, transparent 100%)`;
                });

                // Mettre à jour les particules néon
                const neonParticles = document.querySelectorAll('.particle-neon');
                neonParticles.forEach(p => {
                    p.style.background = config.particle;
                    p.style.boxShadow = `0 0 20px ${config.primary}, 0 0 40px ${config.primary}, 0 0 60px ${config.primary}`;
                });

                // Mettre à jour les particules diamant
                const diamondParticles = document.querySelectorAll('.particle-diamond');
                diamondParticles.forEach(p => {
                    p.style.background = `linear-gradient(45deg, ${config.primary}, ${config.light}, ${config.primary})`;
                });

                // Mettre à jour les particules étoiles
                const starParticles = document.querySelectorAll('.particle-star');
                starParticles.forEach(p => {
                    p.style.background = `linear-gradient(45deg, #fff, ${config.primary}, #fff)`;
                    p.style.boxShadow = `0 0 10px ${config.particle}`;
                });

                // Mettre à jour les titres en gradient
                document.querySelectorAll('.theme-gradient-text, [class*="from-red-400"]').forEach(el => {
                    el.style.background = `linear-gradient(45deg, ${config.light}, ${config.primary})`;
                    el.style.webkitBackgroundClip = 'text';
                    el.style.webkitTextFillColor = 'transparent';
                    el.style.backgroundClip = 'text';
                });

                // Mettre à jour les boutons de contrôle
                document.querySelectorAll('[class*="from-red-500"], [class*="from-red-600"]').forEach(el => {
                    if (el.tagName === 'BUTTON' && !el.id.includes('colorPicker')) {
                        el.style.background = `linear-gradient(45deg, ${config.primary}, ${config.secondary})`;
                    }
                });
                
                // Mettre à jour le bouton de statut de connexion si connecté
                const statusButton = document.getElementById("connectionStatus");
                const statusText = document.getElementById("statusText");
                if (statusButton && statusText && statusText.textContent === "Connecté") {
                    statusButton.style.background = `linear-gradient(to right, ${config.primary}, ${config.secondary})`;
                    statusButton.style.boxShadow = `0 4px 14px ${config.primary}80`;
                }
            }

            // Charger le thème sauvegardé au démarrage
            window.loadSavedTheme = function() {
                const savedTheme = localStorage.getItem("zgmusicGradientTheme") || "red";
                if (savedTheme && gradientThemes[savedTheme]) {
                    const config = gradientThemes[savedTheme];
                    const bg = document.querySelector(".animated-background");
                    if (bg) {
                        bg.style.background = config.gradient;
                        bg.style.backgroundSize = "400% 400%";
                    }
                    
                    // Mettre à jour le logo
                    const logo = document.getElementById("themeLogo");
                    if (logo && config.logo) {
                        logo.src = config.logo;
                    }

                    // Mettre à jour le bouton de sélection de couleur avec la couleur du thème
                    const colorPickerBtn = document.getElementById("colorPickerBtn");
                    if (colorPickerBtn) {
                        if (savedTheme === 'blue') {
                            colorPickerBtn.className = "bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white px-4 py-3 sm:px-6 sm:py-4 rounded-full transition-all duration-300 font-medium text-base sm:text-lg flex items-center space-x-2 sm:space-x-3 shadow-lg hover:shadow-xl hover:scale-105";
                        } else {
                            colorPickerBtn.className = "bg-gradient-to-r from-red-600 to-red-800 hover:from-red-700 hover:to-red-900 text-white px-4 py-3 sm:px-6 sm:py-4 rounded-full transition-all duration-300 font-medium text-base sm:text-lg flex items-center space-x-2 sm:space-x-3 shadow-lg hover:shadow-xl hover:scale-105";
                        }
                    }
                    
                    // Appliquer les variables CSS
                    const root = document.documentElement;
                    root.style.setProperty('--theme-primary', config.primary);
                    root.style.setProperty('--theme-secondary', config.secondary);
                    root.style.setProperty('--theme-light', config.light);
                    root.style.setProperty('--theme-dark', config.dark);
                    root.style.setProperty('--theme-particle', config.particle);

                    // Mettre à jour tous les éléments après un court délai pour s'assurer que le DOM est chargé
                    setTimeout(() => {
                        updateThemeElements(config);
                    }, 100);
                }
            }
        </script>

        <!-- JavaScript pour les particules et curseur néon magnifique -->
        <script>
            // === SYSTÈME DE PARTICULES FLOTTANTES OPTIMISÉ ===
            function createParticles() {
                const container = document.getElementById("particlesContainer");
                const isMobile = isMobileDevice();
                
                // OPTIMISATION MOBILE : Réduire drastiquement les particules sur mobile
                const totalParticleCount = isMobile ? 8 : 60; // 8 sur mobile, 60 sur desktop

                // Types de particules avec leurs probabilités
                // Sur mobile, on utilise seulement les particules basiques pour la performance
                const particleTypes = isMobile ? [
                    { class: "particle", weight: 100 }
                ] : [
                    { class: "particle", weight: 40 },
                    { class: "particle-star", weight: 25 },
                    { class: "particle-diamond", weight: 20 },
                    { class: "particle-neon", weight: 15 },
                ];

                for (let i = 0; i < totalParticleCount; i++) {
                    setTimeout(() => {
                        // Sélectionner un type de particule aléatoire
                        const random = Math.random() * 100;
                        let currentWeight = 0;
                        let selectedType = particleTypes[0];

                        for (const type of particleTypes) {
                            currentWeight += type.weight;
                            if (random <= currentWeight) {
                                selectedType = type;
                                break;
                            }
                        }

                        const particle = document.createElement("div");
                        particle.className = selectedType.class;

                        // Taille variable selon le type
                        let size;
                        if (selectedType.class === "particle-neon") {
                            size = Math.random() * 6 + 3; // Plus petites pour l'effet néon
                        } else if (selectedType.class === "particle-star") {
                            size = Math.random() * 5 + 2;
                        } else if (selectedType.class === "particle-diamond") {
                            size = Math.random() * 8 + 4;
                        } else {
                            size = Math.random() * 10 + 4;
                        }

                        particle.style.width = size + "px";
                        particle.style.height = size + "px";

                        // Position de départ aléatoire
                        particle.style.left = Math.random() * 100 + "%";
                        particle.style.bottom = "-20px";

                        // Durée d'animation variable selon le type
                        let baseDuration;
                        if (selectedType.class === "particle-neon") {
                            baseDuration = Math.random() * 8 + 14; // Plus lent pour l'effet
                        } else if (selectedType.class === "particle-star") {
                            baseDuration = Math.random() * 6 + 12;
                        } else if (selectedType.class === "particle-diamond") {
                            baseDuration = Math.random() * 10 + 18;
                        } else {
                            baseDuration = Math.random() * 8 + 15;
                        }

                        particle.style.animationDuration = baseDuration + "s";

                        // Délai aléatoire
                        const delay = Math.random() * 8;
                        particle.style.animationDelay = delay + "s";

                        container.appendChild(particle);

                        // Supprimer la particule après l'animation
                        setTimeout(
                            () => {
                                if (particle.parentNode) {
                                    particle.parentNode.removeChild(particle);
                                }
                            },
                            (baseDuration + delay) * 1000,
                        );
                    }, i * (isMobile ? 400 : 200)); // Création plus lente sur mobile
                }

                // Récréer les particules continuellement
                // Sur mobile, intervalle plus long pour économiser les ressources
                setTimeout(createParticles, isMobile ? 15000 : 8000);
            }

            // === CURSEUR PRO ULTRA RAPIDE ===
            // Curseur exact de serveur-zg.rf.gd
            let cursor;
            let trailElements = [];

            function isMobileDevice() {
                return 'ontouchstart' in window || navigator.maxTouchPoints > 0 || window.matchMedia('(hover: none)').matches;
            }

            function initZGCursor() {
                // Ne pas créer le curseur sur mobile
                if (isMobileDevice()) {
                    console.log("📱 Mobile détecté - Curseur personnalisé désactivé");
                    return;
                }
                
                // Créer le curseur principal
                cursor = document.createElement("div");
                cursor.className = "custom-cursor";
                document.body.appendChild(cursor);
            }

            function createTrail(x, y) {
                const trail = document.createElement("div");
                trail.className = "cursor-trail";
                trail.style.left = x - 3 + "px";
                trail.style.top = y - 3 + "px";
                document.body.appendChild(trail);

                // Supprimer l'élément après l'animation
                setTimeout(() => {
                    if (trail.parentNode) {
                        trail.parentNode.removeChild(trail);
                    }
                }, 500);
            }

            // Mouvement du curseur avec effet de traînée
            document.addEventListener("mousemove", (e) => {
                if (!cursor) return; // Protection pour éviter les erreurs

                const x = e.clientX;
                const y = e.clientY;

                // Déplacer le curseur principal
                cursor.style.left = x - 10 + "px";
                cursor.style.top = y - 10 + "px";

                // Créer une traînée (réduire la fréquence pour de meilleures performances)
                if (Math.random() > 0.7) {
                    createTrail(x, y);
                }
            });

            // Effet de clic
            document.addEventListener("mousedown", () => {
                if (!cursor) return;
                cursor.style.transform = "scale(1.5)";
            });

            document.addEventListener("mouseup", () => {
                if (!cursor) return;
                cursor.style.transform = "scale(1)";
            });

            // Effet hover
            document.addEventListener("mouseover", (e) => {
                if (!cursor) return;
                if (
                    e.target.matches(
                        "button, a, input, select, textarea, [onclick], .card-hover, .ripple, .btn-primary",
                    )
                ) {
                    cursor.style.transform = "scale(1.3)";
                    cursor.style.boxShadow = "0 0 30px var(--theme-primary)";
                }
            });

            document.addEventListener("mouseout", (e) => {
                if (!cursor) return;
                cursor.style.transform = "scale(1)";
                cursor.style.boxShadow = "0 0 20px var(--theme-primary)";
            });

            // Masquer/afficher le curseur
            document.addEventListener("mouseleave", () => {
                if (!cursor) return;
                cursor.style.opacity = "0";
            });

            document.addEventListener("mouseenter", () => {
                if (!cursor) return;
                cursor.style.opacity = "1";
            });

            // Initialisation
            document.addEventListener("DOMContentLoaded", () => {
                console.log(
                    "🔥 Dashboard ZG MUSIC - Version Optimisée Chargée!",
                );

                // Démarrer le système de curseur ZG
                initZGCursor();

                // Charger le thème de dégradé sauvegardé
                loadSavedTheme();

                // Démarrer les particules après un petit délai
                setTimeout(() => {
                    createParticles();
                    console.log("✨ Système de particules démarré");
                }, 1000);

                // Message de performance
                console.log(
                    "⚡ Fond d'écran YouTube remplacé par animation CSS pure - Performance optimisée!",
                );
            });

            // === OPTIMISATIONS DE PERFORMANCE ===
            // Système de détection de scroll pour désactiver les animations
            let scrollTimer = null;
            let isScrolling = false;
            
            function handleScroll() {
                if (!isScrolling) {
                    isScrolling = true;
                    document.body.classList.add('scrolling');
                }
                
                // Réinitialiser le timer
                clearTimeout(scrollTimer);
                
                // Retirer la classe après 150ms sans scroll
                scrollTimer = setTimeout(() => {
                    isScrolling = false;
                    document.body.classList.remove('scrolling');
                }, 150);
            }
            
            // Ajouter l'écouteur de scroll avec passive pour meilleures performances
            window.addEventListener('scroll', handleScroll, { passive: true });
            
            // Réduire la fréquence des particules si performance faible
            let performanceMode = false;

            // Détecter la performance et ajuster automatiquement
            function checkPerformance() {
                const fps = 60;
                let lastTime = performance.now();
                let frameCount = 0;

                function measureFPS() {
                    frameCount++;
                    const currentTime = performance.now();
                    if (currentTime - lastTime >= 1000) {
                        const currentFPS =
                            frameCount / ((currentTime - lastTime) / 1000);
                        if (currentFPS < 30) {
                            performanceMode = true;
                            console.log(
                                "⚡ Mode performance activé pour maintenir la fluidité",
                            );
                        }
                        frameCount = 0;
                        lastTime = currentTime;
                    }
                    requestAnimationFrame(measureFPS);
                }
                requestAnimationFrame(measureFPS);
            }

            // === TAB MANAGEMENT SYSTEM ===
            let currentDashboardTab = 'home';
            let userSettings = {
                defaultVolume: 100,
                preferredPlatform: 'youtube',
                theme: 'red',
                language: 'fr',
                autoplay: false,
                notifications: true
            };

            function switchDashboardTab(tabName) {
                console.log(`🔄 Switching to tab: ${tabName}`);
                
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // Remove active class from all tabs
                document.querySelectorAll('.dashboard-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected tab content
                const tabContent = document.getElementById(`tabContent-${tabName}`);
                if (tabContent) {
                    tabContent.classList.remove('hidden');
                }
                
                // Add active class to selected tab
                const tabButton = document.getElementById(`dashTab-${tabName}`);
                if (tabButton) {
                    tabButton.classList.add('active');
                }
                
                currentDashboardTab = tabName;
                
                // Load data for specific tabs
                if (tabName === 'history') {
                    loadDashboardHistory();
                } else if (tabName === 'favorites') {
                    loadFavorites();
                } else if (tabName === 'statistics') {
                    loadStatistics();
                }
            }

            // === HISTORY TAB ===
            async function loadDashboardHistory() {
                if (!currentGuild) return;
                
                const historyList = document.getElementById('dashboardHistoryList');
                historyList.innerHTML = '<div class="col-span-full text-center py-12 text-white/40"><i class="fas fa-spinner fa-spin text-4xl mb-4"></i><p class="text-xl">Chargement...</p></div>';
                
                try {
                    const response = await fetch(`/api/history/${currentGuild}?limit=50`);
                    const data = await response.json();
                    
                    if (data.tracks && data.tracks.length > 0) {
                        displayDashboardHistory(data.tracks);
                    } else {
                        historyList.innerHTML = '<div class="col-span-full text-center py-12 text-white/40"><i class="fas fa-history text-6xl mb-4"></i><p class="text-xl">Aucun historique</p></div>';
                    }
                } catch (error) {
                    console.error('Error loading history:', error);
                    historyList.innerHTML = '<div class="col-span-full text-center py-12 text-red-400"><i class="fas fa-exclamation-triangle text-4xl mb-4"></i><p class="text-xl">Erreur de chargement</p></div>';
                }
            }

            function displayDashboardHistory(tracks) {
                const historyList = document.getElementById('dashboardHistoryList');
                
                // Grouper les musiques par URI (même musique)
                const groupedTracks = {};
                tracks.forEach(track => {
                    const key = track.trackUri || track.trackTitle;
                    if (!groupedTracks[key]) {
                        groupedTracks[key] = {
                            ...track,
                            playCount: 0,
                            lastAddedAt: track.addedAt,
                            addedByUsers: []
                        };
                    }
                    groupedTracks[key].playCount++;
                    
                    // Ajouter cet utilisateur s'il n'est pas déjà dans la liste
                    const userExists = groupedTracks[key].addedByUsers.find(u => 
                        u.id === track.addedBy || u.displayName === track.addedByDisplayName
                    );
                    
                    if (!userExists) {
                        groupedTracks[key].addedByUsers.push({
                            id: track.addedBy,
                            avatar: track.addedByAvatar || 'https://cdn.discordapp.com/embed/avatars/0.png',
                            displayName: track.addedByDisplayName || track.addedByUsername || 'Inconnu',
                            addedAt: track.addedAt
                        });
                    }
                    
                    // Garder la date la plus récente
                    if (new Date(track.addedAt) > new Date(groupedTracks[key].lastAddedAt)) {
                        groupedTracks[key].lastAddedAt = track.addedAt;
                    }
                });
                
                // Convertir en tableau et trier par date la plus récente
                const groupedArray = Object.values(groupedTracks).sort((a, b) => 
                    new Date(b.lastAddedAt) - new Date(a.lastAddedAt)
                );
                
                historyList.innerHTML = groupedArray.map(track => {
                    const addedDate = new Date(track.lastAddedAt);
                    const formattedDate = addedDate.toLocaleDateString('fr-FR', { 
                        day: '2-digit', 
                        month: 'short', 
                        year: 'numeric' 
                    });
                    const formattedTime = addedDate.toLocaleTimeString('fr-FR', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    const userDisplayName = track.addedByDisplayName || track.addedByUsername || 'Inconnu';
                    const userAvatar = track.addedByAvatar || 'https://cdn.discordapp.com/embed/avatars/0.png';
                    
                    return `
                        <div class="history-group-card" data-track-uri="${escapeHtml(track.trackUri || '')}" data-track-title="${escapeHtml(track.trackTitle)}">
                            <div class="flex items-start gap-3 sm:gap-4">
                                <!-- Pochette -->
                                <div class="relative flex-shrink-0">
                                    <div class="history-thumbnail">
                                        <img src="${track.trackThumbnail || '/logo.png'}" alt="" class="w-16 h-16 sm:w-20 sm:h-20 rounded-lg object-cover">
                                    </div>
                                </div>
                                
                                <!-- Informations de la musique -->
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-bold text-white text-sm sm:text-base break-words mb-1 line-clamp-2">${escapeHtml(track.trackTitle)}</h4>
                                    <p class="text-xs sm:text-sm text-white/60 break-words mb-2 line-clamp-1">${track.trackAuthor || 'Inconnu'}</p>
                                    
                                    <!-- Avatars et pseudos de tous les utilisateurs avec effet néon -->
                                    <div class="flex flex-wrap items-center gap-2 mb-2">
                                        ${track.addedByUsers.slice(0, 3).map(user => `
                                            <div class="flex items-center gap-1.5 bg-white/5 rounded-full pr-2 py-0.5">
                                                <img src="${user.avatar}" alt="${escapeHtml(user.displayName)}" class="w-5 h-5 sm:w-6 sm:h-6 rounded-full history-avatar-neon">
                                                <span class="history-username-neon text-xs">${escapeHtml(user.displayName)}</span>
                                            </div>
                                        `).join('')}
                                        ${track.addedByUsers.length > 3 ? `
                                            <div class="bg-white/5 rounded-full px-2 py-0.5 text-xs text-white/60">
                                                +${track.addedByUsers.length - 3} autres
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <!-- Date et heure -->
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-calendar-alt text-white/30 text-xs"></i>
                                        <span class="history-datetime">${formattedDate} à ${formattedTime}</span>
                                    </div>
                                </div>
                                
                                <!-- Boutons d'action -->
                                <div class="flex flex-col gap-2 flex-shrink-0">
                                    <button 
                                        class="btn-add-queue bg-white/10 hover:bg-white/20 px-3 py-2 rounded-lg text-white transition-all" 
                                        title="Ajouter à la file"
                                        data-uri="${escapeHtml(track.trackUri || '')}"
                                        data-title="${escapeHtml(track.trackTitle || '')}"
                                        data-author="${escapeHtml(track.trackAuthor || '')}"
                                        data-thumbnail="${escapeHtml(track.trackThumbnail || '')}"
                                        onclick="addToQueueFromHistoryBtn(this)">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button 
                                        class="btn-favorite px-3 py-2 rounded-lg" 
                                        title="Ajouter aux favoris"
                                        data-uri="${escapeHtml(track.trackUri || '')}"
                                        data-title="${escapeHtml(track.trackTitle || '')}"
                                        data-author="${escapeHtml(track.trackAuthor || '')}"
                                        data-thumbnail="${escapeHtml(track.trackThumbnail || '')}"
                                        onclick="toggleFavoriteBtn(this)">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function filterHistory(query) {
                const items = document.querySelectorAll('#dashboardHistoryList > div');
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
                });
            }

            // Nouvelle fonction avec data attributes
            function addToQueueFromHistoryBtn(button) {
                const uri = button.dataset.uri;
                const title = button.dataset.title;
                addToQueueFromHistory(uri, title);
            }

            async function addToQueueFromHistory(uri, title) {
                if (!currentGuild) {
                    alert('Veuillez sélectionner un serveur');
                    return;
                }

                try {
                    const response = await fetch(`/api/queue/${currentGuild}/add`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            uri: uri,
                            title: title
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP ${response.status}`);
                    }

                    alert(`"${title}" ajouté à la file !`);
                } catch (error) {
                    console.error('Error adding to queue:', error);
                    alert(`Erreur: ${error.message}`);
                }
            }

            // === SETTINGS TAB ===
            async function loadSettings() {
                try {
                    const response = await fetch(`/api/settings/${currentUser.id}`);
                    if (response.ok) {
                        const data = await response.json();
                        userSettings = { ...userSettings, ...data };
                        applySettings();
                    }
                } catch (error) {
                    console.log('Using default settings');
                    applySettings();
                }
            }

            function applySettings() {
                document.getElementById('defaultVolumeSlider').value = userSettings.defaultVolume;
                document.getElementById('defaultVolumeDisplay').textContent = userSettings.defaultVolume + '%';
                document.getElementById('languageSelect').value = userSettings.language;
                document.getElementById('autoplayToggle').checked = userSettings.autoplay;
                document.getElementById('notificationsToggle').checked = userSettings.notifications;
                
                selectPreferredPlatform(userSettings.preferredPlatform);
                switchTheme(userSettings.theme);
            }

            function updateVolumeDisplay(value) {
                document.getElementById('defaultVolumeDisplay').textContent = value + '%';
            }

            function selectPreferredPlatform(platform) {
                document.querySelectorAll('.platform-pref-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                const btn = document.getElementById(`pref-${platform}`);
                if (btn) btn.classList.add('active');
                userSettings.preferredPlatform = platform;
            }

            function switchTheme(theme) {
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                const btn = document.getElementById(`theme-${theme}`);
                if (btn) btn.classList.add('active');
                userSettings.theme = theme;
                
                setGradientTheme(theme);
            }

            function toggleAutoplay(checked) {
                userSettings.autoplay = checked;
            }

            function toggleNotifications(checked) {
                userSettings.notifications = checked;
            }

            function changeLanguage(lang) {
                userSettings.language = lang;
            }

            async function saveSettings() {
                userSettings.defaultVolume = parseInt(document.getElementById('defaultVolumeSlider').value);
                
                try {
                    const response = await fetch(`/api/settings/${currentUser.id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(userSettings)
                    });
                    
                    if (response.ok) {
                        showNotification('Réglages sauvegardés !', 'success');
                    } else {
                        showNotification('Erreur lors de la sauvegarde', 'error');
                    }
                } catch (error) {
                    console.error('Error saving settings:', error);
                    showNotification('Erreur lors de la sauvegarde', 'error');
                }
            }

            // === PLAYLISTS TAB ===
            async function loadPlaylists() {
                if (!currentUser) return;
                
                const playlistsList = document.getElementById('playlistsList');
                playlistsList.innerHTML = '<div class="col-span-full text-center py-12 text-white/40"><i class="fas fa-spinner fa-spin text-4xl mb-4"></i><p class="text-xl">Chargement...</p></div>';
                
                try {
                    const response = await fetch(`/api/playlists/${currentUser.id}`);
                    const data = await response.json();
                    
                    if (data.playlists && data.playlists.length > 0) {
                        displayPlaylists(data.playlists);
                    } else {
                        playlistsList.innerHTML = '<div class="col-span-full text-center py-12 text-white/40"><i class="fas fa-list-music text-6xl mb-4 floating-animation"></i><p class="text-xl">Aucune playlist</p><p class="text-sm mt-2">Créez votre première playlist</p></div>';
                    }
                } catch (error) {
                    console.error('Error loading playlists:', error);
                    playlistsList.innerHTML = '<div class="col-span-full text-center py-12 text-white/40"><i class="fas fa-list-music text-6xl mb-4 floating-animation"></i><p class="text-xl">Aucune playlist</p><p class="text-sm mt-2">Créez votre première playlist</p></div>';
                }
            }

            function displayPlaylists(playlists) {
                const playlistsList = document.getElementById('playlistsList');
                playlistsList.innerHTML = playlists.map(playlist => `
                    <div class="gradient-border card-hover">
                        <div class="gradient-border-content p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-white truncate">${escapeHtml(playlist.name)}</h3>
                                <i class="fas fa-music theme-text text-2xl"></i>
                            </div>
                            <p class="text-white/60 mb-4">${playlist.tracks?.length || 0} morceaux</p>
                            <div class="flex gap-2">
                                <button onclick="playPlaylist('${playlist._id}')" class="flex-1 btn-primary px-3 py-2 rounded-lg text-white text-sm">
                                    <i class="fas fa-play mr-1"></i>Jouer
                                </button>
                                <button onclick="editPlaylist('${playlist._id}')" class="px-3 py-2 rounded-lg text-white bg-white/10 hover:bg-white/20 transition-all text-sm">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deletePlaylist('${playlist._id}')" class="px-3 py-2 rounded-lg text-red-400 bg-white/10 hover:bg-red-500/20 transition-all text-sm">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            function openCreatePlaylistModal() {
                showNotification('Modal de création de playlist - À implémenter', 'info');
            }

            async function playPlaylist(playlistId) {
                showNotification('Lecture de la playlist...', 'info');
            }

            async function editPlaylist(playlistId) {
                showNotification('Édition de la playlist - À implémenter', 'info');
            }

            async function deletePlaylist(playlistId) {
                if (!confirm('Supprimer cette playlist ?')) return;
                
                try {
                    const response = await fetch(`/api/playlists/${playlistId}`, { method: 'DELETE' });
                    if (response.ok) {
                        showNotification('Playlist supprimée', 'success');
                        loadPlaylists();
                    }
                } catch (error) {
                    console.error('Error deleting playlist:', error);
                    showNotification('Erreur lors de la suppression', 'error');
                }
            }

            // === ADD TO PLAYLIST MODAL ===
            let currentTrackToAdd = null;

            async function showAddToPlaylistModal(uri, title, author, thumbnail, duration) {
                if (!currentUser) {
                    showNotification('Veuillez vous connecter', 'error');
                    return;
                }

                currentTrackToAdd = { uri, title, author, thumbnail, duration };
                
                const modal = document.getElementById('addToPlaylistModal');
                const trackInfo = document.getElementById('playlistModalTrackInfo');
                const playlistList = document.getElementById('playlistModalList');
                
                trackInfo.innerHTML = `
                    <div class="flex items-center gap-3">
                        <img src="${thumbnail || '/logo.png'}" alt="" class="w-12 h-12 rounded-lg object-cover">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-semibold text-white text-sm break-words">${escapeHtml(title)}</h4>
                            <p class="text-xs text-white/60 break-words">${author || 'Inconnu'}</p>
                        </div>
                    </div>
                `;
                
                playlistList.innerHTML = '<div class="text-center py-8 text-white/40"><i class="fas fa-spinner fa-spin text-3xl mb-2"></i><p>Chargement des playlists...</p></div>';
                
                modal.classList.remove('hidden');
                
                try {
                    const response = await fetch('/api/playlists');
                    const data = await response.json();
                    
                    if (data.playlists && data.playlists.length > 0) {
                        playlistList.innerHTML = data.playlists.map(playlist => `
                            <button onclick="addTrackToPlaylistFromModal('${playlist._id}')" class="w-full glass-effect hover:bg-white/10 rounded-lg p-3 text-left transition-all">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <i class="fas fa-list-ul text-lg" style="color: var(--theme-primary);"></i>
                                        <div>
                                            <h4 class="font-semibold text-white text-sm">${escapeHtml(playlist.name)}</h4>
                                            <p class="text-xs text-white/60">${playlist.tracks?.length || 0} morceaux</p>
                                        </div>
                                    </div>
                                    <i class="fas fa-plus text-white/60"></i>
                                </div>
                            </button>
                        `).join('');
                    } else {
                        playlistList.innerHTML = `
                            <div class="text-center py-8 text-white/40">
                                <i class="fas fa-list-ul text-4xl mb-2"></i>
                                <p>Aucune playlist</p>
                                <p class="text-xs mt-1">Créez une playlist d'abord</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading playlists:', error);
                    playlistList.innerHTML = '<div class="text-center py-8 text-red-400"><i class="fas fa-exclamation-triangle text-3xl mb-2"></i><p>Erreur de chargement</p></div>';
                }
            }

            function closeAddToPlaylistModal(event) {
                if (event && event.target !== event.currentTarget) return;
                document.getElementById('addToPlaylistModal').classList.add('hidden');
                currentTrackToAdd = null;
            }

            async function addTrackToPlaylistFromModal(playlistId) {
                if (!currentTrackToAdd) return;
                
                try {
                    const response = await fetch(`/api/playlists/${playlistId}/add-track`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title: currentTrackToAdd.title,
                            author: currentTrackToAdd.author,
                            uri: currentTrackToAdd.uri,
                            thumbnail: currentTrackToAdd.thumbnail,
                            duration: currentTrackToAdd.duration
                        })
                    });
                    
                    if (response.ok) {
                        showNotification('Ajouté à la playlist !', 'success');
                        closeAddToPlaylistModal();
                    } else {
                        const error = await response.json();
                        showNotification(error.error || 'Erreur lors de l\'ajout', 'error');
                    }
                } catch (error) {
                    console.error('Error adding to playlist:', error);
                    showNotification('Erreur lors de l\'ajout', 'error');
                }
            }

            // === FAVORITES TAB ===
            async function loadFavorites() {
                if (!currentUser) return;
                
                const favoritesList = document.getElementById('favoritesList');
                favoritesList.innerHTML = '<div class="col-span-full text-center py-12 text-white/40"><i class="fas fa-spinner fa-spin text-4xl mb-4"></i><p class="text-xl">Chargement...</p></div>';
                
                try {
                    const response = await fetch(`/api/favorites/${currentUser.id}`);
                    const data = await response.json();
                    
                    if (data.favorites && data.favorites.length > 0) {
                        displayFavorites(data.favorites);
                    } else {
                        favoritesList.innerHTML = '<div class="col-span-full text-center py-12 text-white/40"><i class="fas fa-heart text-6xl mb-4 floating-animation"></i><p class="text-xl">Aucun favori</p><p class="text-sm mt-2">Ajoutez des morceaux à vos favoris</p></div>';
                    }
                } catch (error) {
                    console.error('Error loading favorites:', error);
                    favoritesList.innerHTML = '<div class="col-span-full text-center py-12 text-white/40"><i class="fas fa-heart text-6xl mb-4 floating-animation"></i><p class="text-xl">Aucun favori</p><p class="text-sm mt-2">Ajoutez des morceaux à vos favoris</p></div>';
                }
            }

            function displayFavorites(favorites) {
                const favoritesList = document.getElementById('favoritesList');
                favoritesList.innerHTML = favorites.map(fav => `
                    <div class="gradient-border card-hover relative">
                        <div class="gradient-border-content p-4">
                            <img src="${fav.thumbnail || '/logo.png'}" alt="" class="w-full h-32 object-cover rounded-lg mb-3">
                            <h4 class="font-bold text-white text-sm truncate mb-1">${escapeHtml(fav.title)}</h4>
                            <p class="text-xs text-white/60 truncate mb-3">${fav.author || 'Inconnu'}</p>
                            <div class="flex gap-2">
                                <button onclick="playTrack('${(fav.uri || '').replace(/'/g, "\\'")}', '${(fav.title || '').replace(/'/g, "\\'")}')' class="flex-1 btn-primary px-2 py-1 rounded-lg text-white text-xs">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button onclick="removeFavorite('${fav._id}')" class="px-2 py-1 rounded-lg text-red-400 bg-white/10 hover:bg-red-500/20 transition-all text-xs">
                                    <i class="fas fa-heart-broken"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            function filterFavorites(query) {
                const items = document.querySelectorAll('#favoritesList > div');
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
                });
            }

            async function removeFavorite(favoriteId) {
                try {
                    const response = await fetch(`/api/favorites/${favoriteId}`, { method: 'DELETE' });
                    if (response.ok) {
                        showNotification('Retiré des favoris', 'success');
                        loadFavorites();
                    }
                } catch (error) {
                    console.error('Error removing favorite:', error);
                    showNotification('Erreur', 'error');
                }
            }

            // === STATISTICS TAB ===
            async function loadStatistics() {
                if (!currentGuild) return;
                
                try {
                    // Fetch top tracks and listening time
                    const [topTracksRes, listeningTimeRes] = await Promise.all([
                        fetch(`/api/stats/top-tracks/${currentGuild}?limit=10`),
                        fetch(`/api/stats/listening-time/${currentGuild}`)
                    ]);
                    
                    const topTracksData = await topTracksRes.json();
                    const listeningTimeData = await listeningTimeRes.json();
                    
                    displayStatistics({
                        topTracks: topTracksData.topTracks || [],
                        totalTracks: listeningTimeData.totalTracks || 0
                    });
                } catch (error) {
                    console.error('Error loading statistics:', error);
                    showNotification('Erreur lors du chargement des statistiques', 'error');
                }
            }

            function displayStatistics(data) {
                document.getElementById('totalTracksPlayed').textContent = data.totalTracks || 0;
                document.getElementById('totalPlaytime').textContent = (data.totalTracks * 3.5).toFixed(0) + ' min';
                
                displayTopTracks(data.topTracks || []);
            }

            function displayTopTracks(tracks) {
                const topTracksList = document.getElementById('topTracksList');
                const medals = ['🥇', '🥈', '🥉'];
                topTracksList.innerHTML = tracks.slice(0, 10).map((track, index) => {
                    const medal = index < 3 ? medals[index] : `#${index + 1}`;
                    const rankClass = index < 3 ? 'bg-gradient-to-r from-yellow-600/20 to-yellow-800/20 border-yellow-500/30' : 'bg-white/5 border-white/10';
                    
                    // Style spécial pour les badges de rang
                    let rankBadgeStyle = '';
                    if (index === 0) {
                        rankBadgeStyle = 'background: linear-gradient(135deg, #FFD700, #FFA500); box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);';
                    } else if (index === 1) {
                        rankBadgeStyle = 'background: linear-gradient(135deg, #C0C0C0, #A8A8A8); box-shadow: 0 4px 15px rgba(192, 192, 192, 0.5);';
                    } else if (index === 2) {
                        rankBadgeStyle = 'background: linear-gradient(135deg, #CD7F32, #B8732D); box-shadow: 0 4px 15px rgba(205, 127, 50, 0.5);';
                    } else {
                        rankBadgeStyle = 'background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); border: 2px solid rgba(255,255,255,0.2);';
                    }
                    
                    return `
                    <div class="group ${rankClass} hover:bg-white/10 border rounded-xl p-3 sm:p-4 flex items-center gap-3 sm:gap-4 transition-all duration-300 hover:scale-[1.02] hover:shadow-lg">
                        <!-- Badge de rang stylé -->
                        <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl flex items-center justify-center flex-shrink-0 font-black text-white text-sm sm:text-base transition-transform group-hover:scale-110" style="${rankBadgeStyle}">
                            ${medal}
                        </div>
                        <img src="${track.thumbnail || '/logo.png'}" alt="" class="w-12 h-12 sm:w-14 sm:h-14 rounded-lg object-cover shadow-lg flex-shrink-0">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-white group-hover:text-[var(--theme-light)] truncate text-sm sm:text-base transition-colors">${escapeHtml(track.title)}</h4>
                            <p class="text-xs sm:text-sm text-white/60 truncate">${track.author || 'Inconnu'}</p>
                        </div>
                        <!-- Badge d'écoutes stylé -->
                        <div class="flex-shrink-0 px-3 py-2 rounded-lg text-center" style="background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary)); box-shadow: 0 4px 12px color-mix(in srgb, var(--theme-primary) 40%, transparent);">
                            <div class="text-base sm:text-lg font-black text-white">${track.playCount}</div>
                            <div class="text-xs text-white/80 font-semibold">écoutes</div>
                        </div>
                    </div>
                `}).join('');
            }

            function displayTopArtists(artists) {
                const topArtistsList = document.getElementById('topArtistsList');
                topArtistsList.innerHTML = artists.slice(0, 10).map((artist, index) => `
                    <div class="glass-effect rounded-xl p-4 flex items-center gap-4">
                        <div class="text-2xl font-bold theme-text w-8">#${index + 1}</div>
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-500 to-red-700 flex items-center justify-center">
                            <i class="fas fa-user text-white text-xl"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-white truncate">${escapeHtml(artist._id || artist.name || 'Unknown')}</h4>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-white">${artist.playCount}</div>
                            <div class="text-xs text-white/60">écoutes</div>
                        </div>
                    </div>
                `).join('');
            }

            function displayWeeklyChart(dailyStats) {
                const weeklyChart = document.getElementById('weeklyChart');
                
                if (!weeklyChart) return;
                
                if (!dailyStats || dailyStats.length === 0) {
                    weeklyChart.innerHTML = '<div class="text-center py-8 text-white/40 w-full"><p class="text-sm">Aucune donnée disponible</p></div>';
                    return;
                }
                
                const maxPlays = Math.max(...dailyStats.map(d => d.count || 0), 1);
                const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
                
                weeklyChart.innerHTML = dailyStats.map((stat, index) => {
                    const height = Math.max((stat.count / maxPlays) * 100, 5);
                    const date = new Date(stat._id);
                    const dayName = days[date.getDay()];
                    return `
                        <div class="flex flex-col items-center flex-1 gap-2">
                            <div class="text-xs text-white font-bold">${stat.count}</div>
                            <div class="w-full bg-white/10 rounded-t-lg relative overflow-hidden" style="height: ${height}%">
                                <div class="absolute inset-0 bg-gradient-to-t from-red-600 to-red-400" style="animation: barGrow 1s ease-out ${index * 0.1}s backwards;"></div>
                            </div>
                            <div class="text-xs text-white/60">${dayName}</div>
                        </div>
                    `;
                }).join('');
            }

            function formatPlaytime(minutes) {
                const hours = Math.floor(minutes / 60);
                return hours > 0 ? `${hours}h` : `${minutes}m`;
            }

            // Utility function
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function showNotification(message, type = 'info') {
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        </script>
    </body>
</html>
